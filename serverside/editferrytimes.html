<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>AIA: Edit Ferry Schedule</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

</head>
<body>
<div class="w3-container" >
<h1 class="w3-blue w3-text-white"><strong>&nbsp EDIT FERRY SCHEDULE </strong></h1>
     (ver 3/5/21)
    <p>To Use:
    1. Click 'LOAD FULL SCHEDULE'. 2. Click on an S entry to move it to the Edit box. 3. Click on Format (). 4. Make changes using Edit box. 
    5 Click 'Save Edit box to SA/AI' to save back to S and A (30 min later). 5. When done, select SAVE FULL SCHEDULE, which copies the full schedule to the Edit box. 5 Select All in edit box, copy, and paste into dailycache.txt.</p>
    <button onclick="LoadSchedule()">LOAD FULL SCHEDULE from dailycache</button><br/>
    <button onclick="CheckSchedule()"> Check </button>
    <button onclick="TestSchedule()"> Test all entries</button>
    <button onclick="DisplayFerrySchedule()">DISPLAY Schedule</button>
    <button onclick="SaveSchedule()"> SAVE FERRYS/A/K to Edit Box</button>
    <button onclick="SaveDailyCache()"> SAVE DAILYCACHE.txt to Edit Box</button>

    <p>Rules for ferry time expression:<br/>
    <ul>
        <li>Times are 2400, NO leading zero. 0=midnight. 1200=noon. </li>
        <li>Time = D to delete row. I to insert row.</li>
        <li>* = runs every day.</li>
        <li>0123456 = day of week to run. 0=Sunday. 6=Saturday. Multiple days are allowed, e.g. 135</li>
        <li>(xxxxx) = a javascript expression that evaluates to TRUE/FALSE. TRUE = run.  FALSE = skip.</li>
        <li>Allowable variables: gMonthDay (101-1231), gYYmmdd (201001), gDayofMonth (1-31), gWeekofMonth (1-5), gMonth (1-12), gDayofWeek (0-6)</li>
        <li>Allowable functions: any javascript function, plus any function in AIA.</li>
        <li>Most useful function:  InList(variabletotest, l1, l2, ...).  Returns TRUE if variabletotest is l1 or l2 or ... Can take any number of list elements.</li>
        <li>RFB. 6/3/18.</li>              
        </ul>

    <h1 class="w3-blue w3-text-white">&nbsp EDIT AREA</h1>
    <label>gMonthDay</label><input type="number" id="monthday" size="4"/>
    <label>gDayofWeek</label><input type="number" id="dayofweek" size="1"/>
    <label>gWeekofMonth</label><input type="number" id="weekofmonth" size="1"/><p />
    <strong>hhmm/I/D: <input type="text" id="edittime" size="4" /> &nbsp;<input type="text" size="1" id="editSAK" /> </strong>&nbsp; &nbsp;
    <button onclick="PFormat()">Pretty Format by ()</button> 
    <button onclick="CheckEdit()">Syntax Check rule</button> 
    <button onclick="PCountEdit()">() Count</button> 
    <button onclick="SaveEdit(0)">Save Edit box and time to 1 schedule</button>
    <button onclick="SaveEdit(1)">Save Edit box to ST and AI (don't change AI time)</button><br/>
    <textarea cols="200" rows="4" id="editrule"></textarea>

    <h1 class="w3-blue w3-text-white">&nbsp SCHEDULE TABLE</h1>
    <table id="ftable">
            <tr><td>STEIL</td><td>rule</td><td>S</td><td>AI</td><td>Rule</td><td>S</td><td>KETR</td><td>Rule</td><td>S</td></tr>

    </table>
  <hr/>
        <h1 class="w3-blue w3-text-white">&nbsp RESULTS TABLE</h1>
    <table id="ferrytable">

    </table>
    </div>

<script>
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //  HISTORY
    //  ?   Initial version.
    //  05/12/20 Add schedule display, format(), save to dailycache.txt clipboard
    
    // Ferry run times and flags. 
    //  These values are valid as of 9/2016 - but are immediately overridden by data in dailycache.txt:
    //  FERRYTS,FERRYTA,FERRYTK,FERRYTS2,FERRYTA2,FERRYTK2   (read in by ParseDailyCache)Heirarchy is:
    //  1. '*' overrides everything and means always.
    //  2. 0-6 = day of week that run is valid on.
    //  3. Starts with a '(': it is the special case rules run with 'eval'

    var ferrytimeS = [445, "((gDayofWeek>0)&&(gDayofWeek<6)&&!InList(gMonthDay,1225,101,704,thanksgiving))", 545, "123456", 645, "*", 800, "*", 900, "*", 1000, "((gDayofWeek!=3)||!InList(gWeekofMonth,1,3))", 1200, "*", 1420, "*", 1520, "*", 1620, "*", 1730, "*", 1840, "*", 2040, "*", 2200, "( (gDayofWeek==6)|| ((gDayofWeek==5)&&!((gMonthDay>=701)&&(gMonthDay<=laborday))) ||InList(gMonthDay,1231,101,memorialday,703,704,laborday,thanksgiving,1224,1225))", 2300, "((gDayofWeek==5)&&(gMonthDay>=701)&&(gMonthDay<=laborday))"];
    var ferrytimeA = [515, "((gDayofWeek>0)&&(gDayofWeek<6)&&!InList(gMonthDay,1225,101,704,thanksgiving))", 615, "123456", 730, "*", 830, "*", 930, "*", 1030, "((gDayofWeek!=3)||!InList(gWeekofMonth,1,3))", 1230, "*", 1450, "*", 1550, "*", 1650, "*", 1800, "*", 1910, "*", 2110, "*", 2230, "( (gDayofWeek==6)|| ((gDayofWeek==5)&&!((gMonthDay>=701)&&(gMonthDay<=laborday))) ||InList(gMonthDay,1231,101,memorialday,703,704,laborday,thanksgiving,1224,1225))", 2330, "((gDayofWeek==5)&&(gMonthDay>=701)&&(gMonthDay<=laborday))"];
    var ferrytimeK = [0, "", 0, "", 655, "*", 0, "", 0, "", 1010, "((gDayofWeek==2)&&InList(gWeekofMonth,1,3))", 1255, "*", 0, "", 0, "", 0, "", 0, "", 1935, "*", 0, "", 2250, "( (gDayofWeek==6)|| ((gDayofWeek==5)&&!((gMonthDay>=701)&&(gMonthDay<=laborday))) ||InList(gMonthDay,1231,101,memorialday,703,704,laborday,thanksgiving,1224,1225))", 2350, "((gDayofWeek==5)&&(gMonthDay>=701)&&(gMonthDay<=laborday))"];
    var ferrytimeS2 = [445, "((gDayofWeek>0)&&(gDayofWeek<6)&&!InList(gMonthDay,1225,101,704,thanksgiving))", 545, "123456", 645, "*", 800, "*", 900, "*", 1000, "((gDayofWeek!=3)||!InList(gWeekofMonth,1,3))", 1200, "*", 1230, 50, 1350, 50, 1420, "*", 1450, 50, 1520, "*", 1550, 50, 1620, "*", 1650, 50, 1730, "*", 1800, 50, 1840, "*", 2040, "*", 2200, "( (gDayofWeek==6)|| ((gDayofWeek==5)&&!((gMonthDay>=701)&&(gMonthDay<=laborday))) ||InList(gMonthDay,1231,101,memorialday,703,704,laborday,thanksgiving,1224,1225))", 2300, "((gDayofWeek==5)&&(gMonthDay>=701)&&(gMonthDay<=laborday))"];
    var ferrytimeA2 = [515, "((gDayofWeek>0)&&(gDayofWeek<6)&&!InList(gMonthDay,1225,101,704,thanksgiving))", 615, "123456", 730, "*", 830, "*", 930, "*", 1030, "((gDayofWeek!=3)||!InList(gWeekofMonth,1,3))", 1230, "*", 1300, 50, 1420, 50, 1450, "*", 1520, 50, 1550, "*", 1620, 50, 1650, "*", 1730, 50, 1800, "*", 1840, 50, 1910, "*", 2110, "*", 2230, "( (gDayofWeek==6)|| ((gDayofWeek==5)&&!((gMonthDay>=701)&&(gMonthDay<=laborday))) ||InList(gMonthDay,1231,101,memorialday,703,704,laborday,thanksgiving,1224,1225))", 2330, "((gDayofWeek==5)&&(gMonthDay>=701)&&(gMonthDay<=laborday))"];
    var ferrytimeK2 = [0, "", 0, "", 655, "*", 0, "", 0, "", 1010, "((gDayofWeek==2)&&InList(gWeekofMonth,1,3))", 1255, "*", 0, "", 0, "", 0, "", 0, "", 0, "", 0, "", 0, "", 0, "", 0, "", 0, "", 1935, "*", 0, "", 2250, "( (gDayofWeek==6)|| ((gDayofWeek==5)&&!((gMonthDay>=701)&&(gMonthDay<=laborday))) ||InList(gMonthDay,1231,101,memorialday,703,704,laborday,thanksgiving,1224,1225))", 2350, "((gDayofWeek==5)&&(gMonthDay>=701)&&(gMonthDay<=laborday))"];
    var gDayofWeekName = ["SUNDAY", "MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY"];
    var ferrytimeSd = [];
    var ferrytimeAd = [];
    var ferrytimeKd = [];   // true if modified

    var gFerryDate2 = 0;  // cutover time to ferrytimex2
    var geditSAK = "";
    var gediti = 0;
    var gFerrytimebeingedited = 0;
    var gASbeingedited = "";

    var gdailycache = "";  // global data read in from dailycache.txt
    var gdailycachenew = "";

    // global dates
    var gDayofWeek = 1;
    var gMonthDay = 202;
    var gWeekofMonth = 2;
    var gDateString; 
    var gTimeStampms; // milisec since 1970
    var gLetterofWeek; // letter for day of week
    var gTimehh;
    var gTimemm;
    var gTimehhmm;  // hhmm in 24 hour format
    var gMonth;  // month 1-12. IMPORTANT: note starts with 1
    var gDayofMonth; // day of month 1-31
    var gYear;
    var gYYmmdd; // yymmdd

    var laborday = 0;
    var memorialday = 531;
    var thanksgiving = 1122;
    var gDateString
   

    //////////////////////////////////////////////////////////////////////////
    // Load the schedule from dailycache.text  (local or web)
    // Reads dailycache, extracts the ferry times, and builds the table
    //  Entry   dailycache.txt is a local file, or it can retrieve it from the web site
    //  Exit    ftable built
    function LoadSchedule() {
        GetDailyCache();
    }

    //////////////////////////////////////////////////////////////////////////
    // Check Schedule - checks the syntax of each row, per the rules above
    //  Entry:  ftable = the schedule table
    //  Exit:   bad rows colored red.
    //
    function CheckSchedule() {

    }

    ////////////////////////////////////////////////////////////////////////////
    //  TestSchedule - prompts for a date/time, and then runs the rules
    //  Entry   ftable = the schedule table
    //  Exit    none
    function TestSchedule() {


    }

    //////////////////////////////////////////////////////////////////////////////
    //  SaveSchedule - saves the schedule rows to a local file. OR 
    //      replaces the current schedule rows in dailycache.txt with the new rows
    //  Entry   ftable = the schedule table
    //  Exit
    function SaveSchedule() {

    }


    //------------------------------------------------------------------------------------------------


    ///////////////////////////////////////////////////////////////////////////////////////////////
    //  GetDailyCache - retrieves the daily cache into the local storage objects 
    //  Load from server using ajax async request.
    //  FERRYTIMESS,FERRYTIMESA,OPENHOURS,OPENHOURSEND,EMERGENCY,EMERGENCYEND
    //function GetDailyCache() {
    //     ajax async request
    //    var myurl = FixURL("dailycache.txt"); 
    //    $.ajax({
    //        url: myurl, // for phone use fully qualified url http://anderson-island.org/
    //        success: function (data) {
    //}
    function GetDailyCache() {
        // ajax async request
        ////var myurl = FixURL("dailycache.txt");

        //var myurl = FixURL("getdailycache.php?VER=" + gVer + "&KIND=" + DeviceInfo() + "&N=" + localStorage.getItem("Cmain") +
        //    "&P=" + LSget("pagehits").substr(0, 30));
        //var myurl = FixURL("getdailycachetest.php?VER=" + gVer + "&KIND=" + DeviceInfo() + "&N=" + localStorage.getItem("Cmain") +
        //   "&P=" + LSget("pagehits").substr(0, 30));
        var myurl = "http://www.anderson-island.org/dailycache.txt?" + Date.now(); // add date to turn off cache
        // ajax request without jquery
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (xhttp.readyState == 4 && xhttp.status == 200) HandleDailyCacheReply(xhttp.responseText);
        }
        xhttp.open("GET", myurl, true);
        xhttp.send();
    }
    /////////////////////////////////////////////////////////////////////////////
    // HandleDailyCacheReply - process the dailycache.txt file
    function HandleDailyCacheReply(data) {
        gdailycache = data;// save the data
        ParseDailyCache(data);
    }

    ////////////////////////////////////////////////////////////////////////////////////////
    // ParseDailyCache - parses the daily cache into its parts in local storage
    // data is demarkated by 
    //  KEYWORD\n data   \n      OR
    //  KEYWORD\n  data with embedded newlines \n KEYWORDEND

    function ParseDailyCache(data) {
        var s;

        data = data.replace(/\r/g, ""); // remove all crs regular expression with global flag
        //var rows = data.split("\n"); //split into lines
        if (data.substring(0, 10) != "DAILYCACHE") {
            //alert("could not load updated values for ferry times and open hours");
            //document.getElementById("reloadreason").innerHTML = "Could not load dailycache data.";
            alert("Could get dailycache.txt");
            return;
        }

        //localStorage.setItem("dailycacheloaded", gMonthDay); // remember date time
        //parseCache(data, "ferrytimess", "FERRYTIMESS", "\n");
        //parseCache(data, "ferrytimesa", "FERRYTIMESA", "\n");
        //parseCache(data, "ferrytimesk", "FERRYTIMESK", "\n");
        parseCache(data, "ferrytimess", "FERRYTS", "\n");
        parseCache(data, "ferrytimesa", "FERRYTA", "\n");
        parseCache(data, "ferrytimesk", "FERRYTK", "\n");
        // fill ferry arrays
        ParseFerryTimes();
        clearTable(document.getElementById("ftable"));
        BuildFerryScheduleToEdit(ferrytimeS, ferrytimeA, ferrytimeK);
        alert("Loaded " + ferrytimeA.length + " entries.");
        
    }

    /////////////////////////////
    // parseCache - returns the string from the daily cache
    //  data is in the form:  <startstr>\n data <endstr>
    //  localstoragename = name of local storage item, "" to not store it
    //  startstr = starting string, endstr = ending string. can be "\n"
    //  exit    returns the string. "" if no string.
    // Modified 5/15/18 to always check for <startstr>\n and return error if not found.
    function parseCache(data, localstoragename, startstr, endstr) {
        //var s = data.indexOf(startstr);
        var s = data.indexOf(startstr + "\n");  //This should work more reliably but i'm afraid of the \n on nonwindows
        //if (s < 0) return "";
        if (s < 0) {
            alert("ERROR in DailyCache startstr: Cant find " + startstr);
            return "";
        }
        var e = data.indexOf(endstr, s + startstr.length + 1);
        //if (e < 0) return "";
        if (e < 0) {
            alert("ERROR in DailyCache endstr: Cant find " + endstr);
            return "";
        }
        var str = data.substring(s + startstr.length + 1, e);
        if (localstoragename != "") localStorage.setItem(localstoragename, str);
        return str;
    }


    ////////////////////////////////////////////////////////////////////////
    //  ParseFerryTimes - convert the ferrytimesx strings into arrays ferrytimeX
    //      which is a mixed array of runtime(number);rules(string); runtime; rules, ...
    //      works on ver 1.7 data.  ignores comma delimited ver 1.5 data.
    //  Entry   localStorage items ferrytimesxx are set
    //  Exit    arrays ferrytimexx are set 
    function ParseFerryTimes() {
        ferrytimeS = FillFerryArray("ferrytimess");
        ferrytimeA = FillFerryArray("ferrytimesa");
        ferrytimeK = FillFerryArray("ferrytimesk");
        if (ferrytimeS.length != ferrytimeA.length) alert("different number of entries for S and A!");
        if (ferrytimeS.length != ferrytimeK.length) alert("different number of entries for S and K!");
        // set delta to all false
        for (var i = 0; i < ferrytimeS.length; i = i + 2) {
            ferrytimeSd[i] = false;
            ferrytimeAd[i] = false;
            ferrytimeKd[i] = false;
        }

        //ferrytimeS2 = FillFerryArray("ferrytimess2");
        //ferrytimeA2 = FillFerryArray("ferrytimesa2");
        //ferrytimeK2 = FillFerryArray("ferrytimesk2");

        //str = localStorage.getItem("ferrydate2");
        //if (IsEmpty(str)) return;
        //var d = new Date(str);  // convert ferry date 2 to ms
        //gFerryDate2 = d.getTime(d); // ms till cutover
    }

    // Helper - convert ferry times from string to number, so "0800" becomes 800
    //  remember that the ferry time is every other entry in each array
    //  exit    returns new ferry time array
    function FillFerryArray(itemname) {
        var str;
        var FA;
        str = localStorage.getItem(itemname);
        if (str == null) return null;
        FA = str.split(";"); // fill array with strings
        // convert ferry time to a number
        for (var i = 0; i < FA.length; i = i + 2) {
            FA[i] = Number(FA[i]);  // convert to number
            if (isNaN(FA[i])) alert("Data error " + itemname + " " + i);
        }

        return FA;
    }

    /////////////////////////////////////////////////////////////////////////////////////////
    // Loads the next ferry times into the global 'table' as a row for each run. 
    // ferrytimesS, ferrytimesA is the array of times and days for Steelacoom and AI;
    //  Entry: table = table to add to
    //         ferrytimesS, A, K = array of ferry times for Steilacoom, AI, and Ketron
    //         global gYYmmdd = date
    //  Exit: builds table of run times. Note: cell id = YYmmddhhmmX where X=S/A/K
    function BuildFerryScheduleToEdit(ferrytimesS, ferrytimesA, ferrytimesK) {
        var i;
        var ft;
        var amcolor = "#f0ffff";
        var table = document.getElementById("ftable");
        // roll through the ferry times, skipping runs that are not valid for today
        for (i = 0; i < ferrytimesS.length; i = i + 2) {
            //if ((gTimehhmm >= (ferrytimesS[i] + extrat)) && (gTimehhmm >= (ferrytimesA[i] + extrat)) && (gTimehhmm > Number(ferrytimesK[i]))) continue;  // skip ferrys that have alreaedy run
            //if ((gTimehhmm >= (Number(ferrytimesS[i]) + extrat)) && (gTimehhmm >= (Number(ferrytimesA[i]) + extrat)) && (gTimehhmm > Number(ferrytimesK[i]))) continue;  // skip ferrys that have alreaedy run
            // now determine if the next run will run today.  If it is a valid run, break out of loop.
            //if (ValidFerryRun(ferrytimesS[i + 1], ferrytimesS[i])) {
                // Steelacoom
                var row1, row1col1, row1col2;
                row1 = table.insertRow(-1);
                row1col1 = row1.insertCell(0);
                row1col1.style.border.width = 1;
                row1col1.innerHTML = FormatTime(ferrytimesS[i]);
                row1col1.style.border = "thin solid black";
                if (ferrytimesS[i] < 1200) row1col1.style.backgroundColor = amcolor;
                // Insert rule
                row1col1 = row1.insertCell(1);
                row1col1.style.border = "thin solid black";
            //row1col1.innerHTML = "<textarea rows='2' cols='100'>" + ferrytimesS[i+1] + "</textarea>";
                row1col1.innerHTML = ferrytimeS[i + 1];
                row1col1.id = "S" + i.toFixed(); // id = yymmddhhmmS
                row1col1.onclick = function () { fclick(this.id) };
                if (gFerrytimebeingedited == ferrytimesS[i] && gASbeingedited == "S") row1col1.style.backgroundColor = "yellow";
                row1col1 = row1.insertCell(2);  // statuss
                row1col1.style.border = "thin solid black";
                if(ferrytimeSd[i]) row1col1.style.backgroundColor = "red";


                // Anderson Island;
                row1col2 = row1.insertCell(3);
                row1col2.innerHTML = FormatTime(ferrytimesA[i]);
                row1col2.style.color = "darkblue";
                row1col2.style.border = "thin solid black";
                if (ferrytimesA[i] < 1200) row1col2.style.backgroundColor = amcolor;
                // Insert rule
                row1col2 = row1.insertCell(4);
                row1col2.style.border = "thin solid black";
                //row1col2.innerHTML = "<textarea rows='2' cols='100'>" + ferrytimesA[i + 1] + "</textarea>";
                row1col2.innerHTML = ferrytimesA[i + 1];
                row1col2.id = "A" + i.toFixed(); // id = yymmddhhmmA
                if (gFerrytimebeingedited == ferrytimesA[i] && gASbeingedited == "A") row1col2.style.backgroundColor = "yellow";
                row1col2.onclick = function () { fclick(this.id) };
                row1col2 = row1.insertCell(5);  // status
                row1col2.style.border = "thin solid black";
                if(ferrytimeAd[i]) row1col2.style.backgroundColor = "red"; // if it changed

                // Ketron
                var row1col3 = row1.insertCell(6);
                row1col3.innerHTML = FormatTime(ferrytimesK[i]);
                row1col3.style.color = "brown";
                row1col3.style.border = "thin solid black";
                if (ferrytimesK[i] < 1200) row1col3.style.backgroundColor = amcolor;
                // Insert rule
                row1col3 = row1.insertCell(7);
                row1col3.style.border = "thin solid black";
                row1col3.innerHTML = ferrytimesK[i + 1];
                row1col3.id = "K" + i.toFixed(); // id = yymmddhhmmS
                row1col3.onclick = function () { fclick(this.id) };
                if (gFerrytimebeingedited == ferrytimesK[i] && gASbeingedited == "K") row1col2.style.backgroundColor = "yellow";
                row1col3 = row1.insertCell(8);  // status    
                row1col3.style.border = "thin solid black";
                if(ferrytimeKd[i]) row1col1.style.backgroundColor = "red";  // if it changed


        }
        return;
    }

    //////////////////////////////////////////////////////////////////////
    //  FormatTime()  returns just a fixed number
    function FormatTime(t) {
        return t.toFixed(0);
    }

    /////////////////////////////////////////////////////////////////////
    //  fclick - move stuff to edit box
    //  entry {S|A|K}index
    function fclick(id) {
        geditSAK = id.substr(0, 1);
        document.getElementById("editSAK").value = geditSAK;
        var i = Number(id.substr(1)); //index
        gediti = i;
        gASbeingedited = geditSAK;
        switch(geditSAK) {
            case "S": 
                document.getElementById("edittime").value = ferrytimeS[i];
                document.getElementById("editrule").value = ferrytimeS[i + 1];
                gFerrytimebeingedited = ferrytimeS[i];
                break;
            case "A": 
                document.getElementById("edittime").value = ferrytimeA[i];
                document.getElementById("editrule").value = ferrytimeA[i + 1];
                gFerrytimebeingedited = ferrytimeA[i];
                break;
            case "K": 
                document.getElementById("edittime").value = ferrytimeK[i];
                document.getElementById("editrule").value = ferrytimeK[i + 1];
                gFerrytimebeingedited = ferrytimeK[i];
                break;
        }
        clearTable(document.getElementById("ftable"));
        BuildFerryScheduleToEdit(ferrytimeS, ferrytimeA, ferrytimeK);

    }
        
    ////////////////////////////////////////////////////////////////////////
    // EditCheck - verify the syntactic correctness of the edit expression
    //  Checks "editrule"
    //  returns true if ok, false if bad
    function CheckEdit() {
        var rule = document.getElementById("editrule").value;
        if (CheckRule(rule, true)) return alert("ok");
        alert("invalid expression");
    }

    // empty is ok
    // * is ok
    // integer is ok
    // (valid javascript eval) is ok
    function CheckRule(rule, showresult) {
        if(rule=="") return true;
        if (rule == "*") return true;
        gDayofWeek = Number(document.getElementById("dayofweek").value);
        gMonthDay = Number(document.getElementById("monthday").value);
        gWeekofMonth = Number(document.getElementById("weekofmonth").value);
        if (rule.substr(0, 1) == "(") {
            try {
                r = eval(rule);
                if (showresult) alert("returns " + r);
                return true;
            } catch (e) {
                alert(e);
                return false;
            }
        }
        var patt =  /^[0123456]+$/;
        if(patt.test(rule)) return true; // numbers 0-6 only
        return true;
    }

    ///////////////////////////////////////////////////////////////////
    // SaveEdit - move the edit cell back into the ferrytime array 
    //  and regen the display table
    //  Entry   all = 0 to just save to current entry, 1 to save to Steiacoom, AI
    //          gediti = index into ferrytimeS/A/K for item being edited.
    function SaveEdit(all) {
        if (all == 1) geditSAK = "SA";
        if (geditSAK == "") return;
        var rule = document.getElementById("editrule").value;
        rule = rule.replace(/ /g, ""); // remove spaces
        rule = rule.replace(/\n/g, ""); // remove new line
        var ft = document.getElementById("edittime").value;
        if (ft == "D") {
            DeleteRow(gediti); // delete row
            return;
        }
        if (ft == "I") {
            InsertRow(gediti); // insert row
            return;
        }
        var ft = Number(document.getElementById("edittime").value);
        if (Number.isNaN(ft) == true) {
            alert("invalid time");
            return;
        }
        if (!CheckRule(rule, false)) {
            alert("invalied expression - can't save");
            return;
        }
        if (ft > 2400 || ft < 0) {
            alert("invalid time. can't save");
            return;
        }
        switch (geditSAK) {
                case "S":
                    ferrytimeS[gediti] = ft;
                    ferrytimeS[gediti + 1] = rule;
                    ferrytimeSd[gediti] = true;
                    break;
                case "A":
                    ferrytimeA[gediti] = ft;
                    ferrytimeA[gediti + 1] = rule;
                    ferrytimeAd[gediti] = true;
                    break;
                case "K":
                    ferrytimeK[gediti] = ft;
                    ferrytimeK[gediti + 1] = rule;
                    ferrytimeKd[gediti] = true;
                    break;
                case "SA":
                    ferrytimeS[gediti] = ft;
                    ferrytimeS[gediti + 1] = rule;
                    ferrytimeA[gediti + 1] = rule;
                    ferrytimeSd[gediti] = true;
                    ferrytimeAd[gediti] = true;
                    //ferrytimeK[gediti] = ft;
                    //ferrytimeK[gediti + 1] = rule;
                    break;

        }
        clearTable(document.getElementById("ftable"));
        BuildFerryScheduleToEdit(ferrytimeS, ferrytimeA, ferrytimeK);
        alert("value saved for " + geditSAK + " " + ft.toFixed())
    }

    ////////////////////////////////////////////////////////////////////////////////
    //  DeleteRow - delete the row
    //  entry gediti = index of row to delete from ferrytimeS[i]; A[i], K[i]
    //  exit    2 items deleted from ferrytimeS/A/K
    //          display rebilt
    function DeleteRow(di) {
        if (confirm("delete row?") == false) return;
        le = ferrytimeS.length-1;
        var i;
        // move rows down
        for (i = di; i < le; i++) {
            ferrytimeS[i] = ferrytimeS[i + 2];
            ferrytimeA[i] = ferrytimeA[i + 2];
            ferrytimeK[i] = ferrytimeK[i + 2];
        }
        ferrytimeS.length = le - 2;
        ferrytimeA.length = le - 2;
        ferrytimeK.length = le - 2;  // turncate array
        // rebuild html table for the schedule
        clearTable(document.getElementById("ftable"));
        BuildFerryScheduleToEdit(ferrytimeS, ferrytimeA, ferrytimeK)

    }

    ////////////////////////////////////////////////////////////////////////////////
    //  InsertRow - insert the row
    //  entry gediti = index of row to insert
    function InsertRow(di) {
        if (confirm("insert row?") == false) return;
        le = ferrytimeS.length+2;
        var i;
        // move rows down
        for (i = le; i > di; i--) {
            ferrytimeS[i] = ferrytimeS[i - 2];
            ferrytimeA[i] = ferrytimeA[i - 2];
            ferrytimeK[i] = ferrytimeK[i - 2];
        }
        // rebuild html table for the schedule
        clearTable(document.getElementById("ftable"));
        BuildFerryScheduleToEdit(ferrytimeS, ferrytimeA, ferrytimeK)
    }

    ///////////////////////////////////////////////////////////////////////////////
    // PCountEdit - parenthesis count for now
     function PCountEdit() {
        var rule = document.getElementById("editrule").value;
        var i;
        var pcount = 0;
        var p = "";
        for (i = 0; i < rule.length; i++) {
            var s = rule.substr(i, 1);
            if (s == "(") {
                pcount++;
                p = p + "(" + pcount.toFixed();
            } else if (s == ")") {
                p = p + ")" + pcount.toFixed();
                pcount--;
            } else {
                p = p + s;
            }
        }
        alert(p + "\nMissing Parens = " + pcount.toFixed()); // display paren count;

     }

    ///////////////////////////////////////////////////////////////////////////////
    // PFormat - Break up into multiple lines based on level 0 closing parenthesis
     function PFormat() {
        var rule = document.getElementById("editrule").value;
        var i;
        var pcount = 0;
         var p = "";
         var sprev = "";
         var prev4 = "";
         var s = "";
         if (rule.substr(0, 2) == "((") rule = rule.substr(1, rule.length - 2);  // strip first and last ()
         // loop through and insert a crlf at each level 0 paren
         for (i = 0; i < rule.length; i++) {
             sprev = s;
             s = rule.substr(i, 1);
             if (s == "(") {
                 pcount++;
                 p = p + "(";
             } else if (s == ")") {
                var lf = "";
                if (pcount == 1) lf = "\n";
                p = p + ")" + lf;
                pcount--;
             } else {
                p = p + s;
             }
         }
         p = p.replace(/\)\&\&\(/g, ") && (");
         p = p.replace(/\)\|\|\(/g, ") || (");
         p = p.replace(/\n\|\|\(/g, "\n|| (");
         p = p.replace(/\n\&\&\(/g, "\n&& (");
         p = p.replace(/\)\)/g, ") )");
         p = p.replace(/\(\(/g, "( (");
         document.getElementById("editrule").value = p;
         if(pcount != 0) alert(p + "\nMissing Parens = " + pcount.toFixed()); // display paren count;

     }
    
    ////////////////////////////////////////////////////////////////////////////////
    //  CheckSchedule() - lchecks entire schedule and sets status
    //  returns true if no errors, else false;
     function CheckSchedule() {
         var i;
         var ok = true;
         for (i = 0; i < ferrytimeA.length; i+=2) {
             if(CheckRule(ferrytimeS[i+1], false) == false) {
                 alert("Error: Steilacoom " + ferrytimeS[i]);
                 ok = false;
             }
             if(CheckRule(ferrytimeA[i+1], false) == false) {
                 alert("Error: Anderson " + ferrytimeA[i]);
                 ok = false;
             }
             if(CheckRule(ferrytimeK[i+1], false) == false) {
                 alert("Error: Ketron " + ferrytimeK[i]);
                 ok = false;
             }
         }
         alert("Checked " + ferrytimeA.length + " entries. Result =" + ok);
         return ok;
     }
     ////////////////////////////////////////////////////////////////////////////////
     //  SaveSchedule() - saves entire schedule to edit box
    //  entry: ferrytimeA/S/K array = edited schedule
    //  exit: true if no error, document.editrule = formatted schedule values for dailycache.txt,
    //          false if an error
     function SaveSchedule() {
         var i;
         if (CheckSchedule() == false) {
             alert("can not save while there are errors.");
             return false;
         }
         var FTA = "FERRYTA\n";
         var FTS = "FERRYTS\n";
         var FTK = "FERRYTK\n";
         for (i = 0; i < ferrytimeA.length; i+=2) {
             FTA = FTA + ferrytimeA[i].toFixed() + ";" + ferrytimeA[i + 1] + ";";
             FTS = FTS + ferrytimeS[i].toFixed() + ";" + ferrytimeS[i + 1] + ";";
             FTK = FTK + ferrytimeK[i].toFixed() + ";" + ferrytimeK[i + 1] + ";";
         }
         document.getElementById("editrule").value = FTS.substr(0, FTS.length - 1) + "\n" + FTA.substr(0, FTA.length - 1) + "\n" + FTK.substr(0, FTK.length - 1) + "\n";
         alert("saved " + ferrytimeA.length.toFixed() + " rows to the edit box.");
         return true;
    }

    //////////////////////////////////////////////////////////////////////////////////////////////
    //  UpdateDailyCache() Replaces the ferry info in DailyCache with the edited Ferry values
    //  entry: ferrytimeA/S/K array = edited schedule
    //  exit: true if no error, 
    //        clipboard and document.editrule = entire formatted dailycache.txt contents.
    //
    function SaveDailyCache() {
        if (!SaveSchedule()) return false;
        InitializeDates(0);
        // schedule is now in the editrule.value
        var editrule = document.getElementById("editrule");
        var newferryschedule = editrule.value;
        if (gdailycache.length == 0) return alert("no daily cache data");
        if (newferryschedule.length == 0) return alert("no new ferry schedule data");
        // find and replace
        var fs = gdailycache.indexOf("FERRYTS\n");
        if (fs < 10) return alert("cannot find FERRYTS in dailycache");
        var fs2 = gdailycache.indexOf("FERRYTS2\n");
        if (fs2 < fs) return alert("cannot find FERRYTS2 in dailycache, or it is not before FERRYTS");
        gdailycachenew = gdailycache.substr(0, fs) + "//Ferry Schedule Edited " + gYYmmdd + "\n" + newferryschedule + gdailycache.substr(fs2);  // build new daily cache
        // move to the edit box
        editrule.value = gdailycachenew;
        /* Get the text field */
          /* Select the text field */
        editrule.select();
        editrule.setSelectionRange(0, 99999); /*For mobile devices*/

        /* Copy the text inside the text field */
        document.execCommand("copy");
        alert("replacement for dailycache.txt is now in the clipboard")
    }

    /////////////////////////////////////////////////////////////////////////////////////////
    // clear table. Deletes all rows but the first.
    function clearTable(table) {
        // clear table
        while (table.rows.length > 1) {
            table.deleteRow(-1);
        }
    }

    /////////////////////////////////////////////////////////////////////////////////////////
    //  InList check for the argument in the list
    //  entry   a = value
    //          a1, a2, ... = values to test for
    //  returns true if a = a1 or a2 or a3, ...; e.g. InList(3,0,1,2,3,4) returns true because 3 is in the list
    function InList(a) {
        var i;
        for (i = 1; i < arguments.length; i++) { if (arguments[0] == arguments[i]) return true; }
        return false;
    }

    //////////////////////////////////////////////////////////////////////////////////////
//  timeAdd - increments time by nn minutes. Use -nn to decrement time.
//  Entry   timehhmm as hhmm, addmm as minutes (positive or negative);
//  Exit    new time
function timeAdd(timehhmm, addmm) {
    var tm = (Math.floor(timehhmm / 100) * 60) + (timehhmm % 100) + addmm; // time in min
    return Math.floor(tm / 60) *100 + (tm % 60);
}

//============================================== FROM AIA index.js ========================================================//
//============================================== FROM AIA index.js ========================================================//
// AIA ONLY GLOBALS
    var gFerryHighlight = 0;
////////////////////////////////////////////////////////////////
//  FROM AIA index.js
// DisplayFerrySchedule build and displays the grid 'ferrytable'
//  entry userdate = "" for today, else mm/dd
function DisplayFerrySchedule() {
    var row1, row1col1;
    var userdate = prompt("enter date as empty, or mm/dd/yyyy");
    if (userdate == "") InitializeDates(0);
    else InitializeDates(userdate);
    //document.getElementById("ferrymessage").innerHTML = localStorage.getItem("ferrymessage");

    var table = document.getElementById("ferrytable");
    //gTableToClear = "ferrytable";
    clearTable(table);
    if(table.rows.length>0) table.deleteRow(0);  // clear 1st row

    row1 = table.insertRow(-1);
    row1col1 = row1.insertCell(0);
    row1col1.style.backgroundColor = "blue";
    row1col1.style.color = "white";
    if (userdate == "") row1col1.innerHTML = 'TODAY';
    else row1col1.innerHTML = gDayofWeekName[gDayofWeek];
    row1col1 = row1.insertCell(1);
    row1col1.style.backgroundColor = "blue";
    row1col1.style.color = "white";
    row1col1.innerHTML = gMonth + "/" + gDayofMonth + (holiday ? " Holiday" : "") ;
    row1col1 = row1.insertCell(2);
    row1col1.style.backgroundColor = "blue";

    InsertStAI(table);
    BuildFerrySchedule(table, UseFerryTime("S"), UseFerryTime("A"), UseFerryTime("K"));
 
    gTimehhmm = 0;  // ignore current time
    var i;
    for (i = 0; i < 7; i++) {
        InitializeDates(1);  // tomorrow
        row1 = table.insertRow(-1);
        row1col1 = row1.insertCell(0);
        row1col1.colSpan = "3";
        row1col1.style.backgroundColor = "blue";
        row1col1.style.color = "white";
        row1col1.innerHTML = gDayofWeekName[gDayofWeek] + " " + gMonth + "/" + gDayofMonth + (holiday ? " Holiday" : "");
        InsertStAI(table);
        BuildFerrySchedule(table, UseFerryTime("S"), UseFerryTime("A"), UseFerryTime("K"));
    }

    InitializeDates(0);  // reset dates back
    }
    /////////////////////////////////////////////////////////////////////////////////////////
// Loads the next ferry times into the global 'table' as a row for each run for 1 day. 
// ferrytimesS, ferrytimesA is the array of times and days for Steelacoom and AI;
//  Entry: table = table to add to
//         ferrytimesS, A, K = array of ferry times for Steilacoom, AI, and Ketron
//         global gYYmmdd = date
//  Exit: builds table of run times. Note: cell id = YYmmddhhmmX where X=S/A/K
function BuildFerrySchedule(table, ferrytimesS, ferrytimesA, ferrytimesK) {
    var i;
    var ft;
    var amcolor = "#f0ffff";
    const extrat = 29; // extra time in display 29 minutes
    var boldS = false, boldA = false, boldK = false;
    var validS = false, validA = false, validK = false; // true if runs are valid
    var adjustedcurrenttime = 0; // time adjusted for ferry delays (time adjusted backwards)
    var rowcount = 0;
    //if (gTimehhmm > 0) adjustedcurrenttime = timeAdd(gTimehhmm, -(extrat + gFerryDelayMin)); // adjust current time backwards for the ferry sailing test

    // roll through the ferry times, skipping runs that are not valid for today
    for (i = 0; i < ferrytimesS.length; i = i + 2) {
        if ((adjustedcurrenttime >= ferrytimesS[i]) && (adjustedcurrenttime >= ferrytimesA[i]) && (adjustedcurrenttime > ferrytimesK[i]))continue;  // skip ferrys that have alreaedy run
        // now determine if the next run will run today.  If it is a valid run, break out of loop.
        validS = (ferrytimesS[i] != 0) &&  ValidFerryRun(ferrytimesS[i + 1], ferrytimesS[i]);
        validA = (ferrytimesA[i] != 0) && ValidFerryRun(ferrytimesA[i + 1], ferrytimesA[i]);
        validK = (ferrytimesK[i] != 0) && ValidFerryRun(ferrytimesK[i + 1], ferrytimesK[i]);
        if (validS||validA||validK) {
            rowcount++;
            // Steelacoom
            var row1, row1col1, row1col2;
            row1 = table.insertRow(-1);
            row1col1 = row1.insertCell(0);
            row1col1.style.border.width = 1;
            row1col1.style.border = "thin solid black";
            if (validS) {
                row1col1.innerHTML = "&nbsp;&nbsp;" + FormatTime(ferrytimesS[i]);
                if (gTimehhmm > ferrytimesS[i]) row1col1.style.color = "lightgray";
                if (ferrytimesS[i] < 1200) row1col1.style.backgroundColor = amcolor;
                row1col1.id = gYYmmdd.toFixed(0) + formathhmm(ferrytimesS[i]) + "S"; // id = yymmddhhmmS
                row1col1.onclick = function () { ferryclick(this.id) };
            } else {
                row1col1.innerHTML = "&nbsp;&nbsp;"
            }

            // Anderson Island;
            row1col2 = row1.insertCell(1);
            row1col2.style.border = "thin solid black";
            if (validA) {
                row1col2.innerHTML = "&nbsp;&nbsp;" + FormatTime(ferrytimesA[i]);
                if (gTimehhmm > ferrytimesA[i]) row1col2.style.color = "lightgray";
                else row1col2.style.color = "darkblue";
                if (ferrytimesA[i] < 1200) row1col2.style.backgroundColor = amcolor;
                row1col2.id = gYYmmdd.toFixed(0) + formathhmm(ferrytimesA[i]) + "A"; // id = yymmddhhmmA
                row1col2.onclick = function () { ferryclick(this.id) };
            } else {
                row1col2.innerHTML = "&nbsp;&nbsp;";
            }

            // Ketron
            var row1col3 = row1.insertCell(2);
            row1col3.style.border = "thin solid black";
            if (validK) {
                row1col3.innerHTML = "&nbsp;&nbsp;" + FormatTime(ferrytimesK[i]);
                if (gTimehhmm > ferrytimesK[i]) row1col3.style.color = "lightgray";
                else row1col3.style.color = "brown";
                row1col3.style.border = "thin solid black";
                if (ferrytimesK[i] < 1200) row1col3.style.backgroundColor = amcolor;
                row1col3.id = gYYmmdd.toFixed(0) + formathhmm(ferrytimesK[i]) + "K"; // id = yymmddhhmmS
                row1col3.onclick = function () { ferryclick(this.id) };
            }
            // make the next run bold
            if (row1.rowIndex <= 3) { // row 3 or 4 (index=2 or 3) is the next run
                if (gTimehhmm <= ferrytimesS[i] && !boldS) {
                    row1col1.style.fontWeight = "bold";  // bold 
                    boldS = true;
                }
                if (gTimehhmm <= ferrytimesA[i] && !boldA){
                    row1col2.style.fontWeight = "bold";  // bold
                    boldA = true;
                }
                if (gTimehhmm <= ferrytimesK[i] && !boldK) {
                    row1col3.style.fontWeight = "bold";  // bold 
                    boldK = true;
                }
            }

        }
    }
    row1 = table.insertRow(-1);
    row1col1 = row1.insertCell(0);
    row1col1.style.border.width = 1;
    row1col1.style.border = "thin solid black";
    row1col1.innerHTML = rowcount.toFixed(0) + " rows";
    return;
}
// formathhmm - ensure 4 digit hhmm
function formathhmm(hhmm) {
    var s = hhmm.toFixed(0);
    if (s.length == 4) return s;
    else return "0" + s;
}

// build steilacoom/ai label
function InsertStAI(table) {
    row1 = table.insertRow(-1);
    row1.style.color = "darkblue";
    row1col1 = row1.insertCell(0);
    row1col1.style.border.width = 1;
    row1col1.style.border = "thin solid black";
    if (gFerryHighlight == 1 && gLocationOnAI == 0) row1col1.style.backgroundColor = "#ffff80";
    else row1col1.style.backgroundColor = "lightblue";
    row1col1.style.color = "black";
    row1col1.innerHTML = "&nbsp; Steilacoom &nbsp;";
    row1col1 = row1.insertCell(1);
    row1col1.style.border.width = 1;
    row1col1.style.border = "thin solid black";
    if (gFerryHighlight == 1 && gLocationOnAI == 1) row1col1.style.backgroundColor = "#ffff80";
    else row1col1.style.backgroundColor = "lightblue";
    row1col1.style.color = "darkblue";
    row1col1.innerHTML = "&nbsp;Anderson&nbsp;";
    row1col1 = row1.insertCell(2);
    row1col1.style.border.width = 1;
    row1col1.style.border = "thin solid black";
    row1col1.style.backgroundColor = "lightblue";
    row1col1.style.color = "maroon";
    row1col1.innerHTML = "&nbsp; Ketron &nbsp;";
    }

/////////////////////////////////////////////////////////////////////////////////////////
// ValidFerryRun return true if a valid ferry time, else false.
//  alternate to having the rules special cased
// flag: *=always, 0-6=days of week, (xxxx) = eval rules in javascript
// ferrytime: ferry run time, used only for error message
//  eval rules are javascript, returning true for a valid run, else false
//    can use global variables gMonthDay, gDayofWeek, gWeekofMonth,...
//    e.g. ((gDayofWeek>0)&&(gDayofWeek<6)&&!InList(gMonthDay,1225,101,704,laborday,1123))

function ValidFerryRun(flag, ferrytime) {
    if (flag == undefined || flag == "") return false;
    if (flag.indexOf("*") > -1) return true; // good every day
    if (flag.substr(0, 1) != "(") {
        if (flag.indexOf(gLetterofWeek) > -1) return true;  // if day of week is encoded
        return false;
    }

    // (eval rules ).
    try {
        var t = eval(flag);
    } catch (err) {
        var msg = "Invalid Ferry Eval Rule for " + ferrytime + "\n" + flag + "\n" + err.message;
        alert(msg);
        t = false;
    }
    return t;
    }
//////////////////////////////////////////////////////////////////////////////////////
//  timeAdd - increments time by nn minutes. Use -nn to decrement time.
//  Entry   timehhmm as hhmm, addmm as minutes (positive or negative);
//  Exit    new time
function timeAdd(timehhmm, addmm) {
    var tm = (Math.floor(timehhmm / 100) * 60) + (timehhmm % 100) + addmm; // time in min
    return Math.floor(tm / 60) *100 + (tm % 60);
}
/////////////////////////////////////////////////////////////////////////////////////////
// initilize all date variables.  
// entry: dateincr = 0 for today, 1 to go to last date + 1 (i.e. increment date by 1 and reset time).
//          mm/dd/yyyy for an arbitrary date
// sets the date globals above
function InitializeDates(dateincr) {
    if (dateincr == 0) Gd = new Date();
    else if (dateincr == 1) {
        Gd.setDate(Gd.getDate() + 1); // bump by 1
        Gd.setHours(0); Gd.setMinutes(0); Gd.setSeconds(0);
    } else {
        Gd = new Date(dateincr);
    }
    gDateString = Gd.toString(); 
    gTimeStampms = Gd.getTime(); // milisec since 1970
    gDayofWeek = Gd.getDay();  // day of week in 0-6
    gLetterofWeek = "0123456".charAt(gDayofWeek); // letter for day of week
    gTimehh = Gd.getHours();
    gTimemm = Gd.getMinutes();
    gTimehhmm = gTimehh * 100 + gTimemm;  // hhmm in 24 hour format
    gMonth = Gd.getMonth() + 1;  // month 1-12. IMPORTANT: note starts with 1
    gDayofMonth = Gd.getDate(); // day of month 1-31
    gMonthDay = gMonth * 100 + gDayofMonth;
    gYear = Gd.getFullYear();
    gYYmmdd = gMonthDay + (gYear-2000)*10000; // yymmdd
    gWeekofMonth = Math.floor((gDayofMonth - 1) / 7) + 1;  // nth occurance of day within month: 1,2,3,4,5
    // build holidays once only
    if (laborday == 0) BuildHoliday(gYear);
    // compute holidays
    holiday = IsHoliday(gMonthDay);
}

///////////////////////////////////////////////////////////////////////////////////////
// return true if a holiday for the ferry schedule. input = month*100+day
function IsHoliday(md) {
    if (md == 1231 || md == 1232 || md == 101) return true;
    if (md == memorialday || md == 703 || md == 704 || md == laborday || md == thanksgiving || md == 1224 || md == 1225) return true;
    return false;
    }
//////////////////////////////////////////////////////////////////////////////////////
//  BuildHolidays - calculate laborday, memorial day, thanksgiving.  rev 1/5/18.
//  entry: year = year.   
//  exit: sets laborday, memorialday, thansgiving to mmdd.
function BuildHoliday(year) {
    // laborday // first monday in sept.  we need to compute this dyanmically
    var dlabordate, dlabor;
    dlabordate = new Date(year, 8, 1); // earlies possible date
    dlabor = dlabordate.getDay();
    if (dlabor > 1) laborday = 909 - dlabor;  // monday = 1... Sat=6
    else if (dlabor == 0) laborday = 902;  // monday = 1... Sat=6
    else laborday = 901;
    // memorial day last monday in may
    var dmemdate, memdate;
    dmemdate = new Date(year, 4, 25); // earliest possible date memorial day
    memday = dmemdate.getDay();
    if (memday > 1) memorialday = 525 + 8 - memday;  // monday = 1... Sat=6
    else if (memday == 0) memorialday = 526;  // monday = 1... Sat=6
    else memorialday = 525;
    // thanksgiving calculation.  Fixed on 01/05/18.
    // thanksgiving = 11/22 – 11/28
    var dthanksdate, dthanks;
    dthanksdate = new Date(year, 10, 1);// 1st day of nov
    dowthanks = dthanksdate.getDay(); // 0 – 6, thur=4
    if (dowthanks <= 4) thanksgiving = 1126 - dowthanks;//  4 = 22,3=23,2=24,1=25,0=26
    else thanksgiving = 1133 - dowthanks;;//  5 ->1128,  6->11/27
    }
/////////////////////////////////////////////////////////////////////////
//  GetFerryTimeArray - select proper ferry time array (S or A) NO DATE TEST
//  entry   SA = "S" for Steilacoom, A for Anderson, K for Ketron
//  exit    returns if SA=A: ferrytimeA, S: ferrytimeS,
function UseFerryTime(SA) {
    switch (SA) {
        case "S":
            return ferrytimeS;
            break;
        case "A":
            return ferrytimeA;
            break;
        case "K":
            return ferrytimeK;
            break;
    }
}
    </script>

</body>
</html>