<!DOCTYPE html>
<!--
    Copyright (c) 2012-2014 Adobe Systems Incorporated. All rights reserved.

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=medium-dpi" /> <!--device-dpi" />-->
    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <title>Anderson Island Assistant</title>
    <style>
        button {
            font-size: 18px;
        }

        p {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="app">
        <div data-role="content"></div>
        <h1 style="font-size:24px">Anderson Island Assistant <button onclick="LocalMenu();">&#8801</button></h1>
         <div style="background-color:azure"><hr />
        <!--<p>All sorts of usefull information in an up-to-date easy-to-use app.</p>-->
        <p style="font-size:18px;color:blue;margin-left:2%">
            FERRY
            <button onclick="window.open('localferryschedule.html');">Times</button>
            <button onclick="ShowFerryCams();">Cams</button>
            <button onclick="ShowFerry();">Home</button>
            <p id="ferrytimes" style="font-size:small;margin-left:4%">Next Ferry: </p>
       </div>
     <div style="background-color:honeydew"> <hr />
            <span style="font-size:18px;color:darkgreen;margin-left:2%">
            OUTSIDE </span>
            <button onclick="ShowTides();">Tides</button>
            <button onclick="ShowWeather();">Weather</button>
            <button onclick="ShowBurnBan();">Burn</button>
            <button onclick="ShowMap();">Map</button>

               

        </div><div style="background-color:floralwhite"><hr />
        <span style="font-size:18px;color:darkmagenta;margin-left:2%">
            CALENDAR </span>
            <button onclick="window.open('comingevents.html?events');">Events</button>
                  <button onclick="window.open('comingevents.html?activities');">Activities</button>
            <p id="nextevent">Next Event:</p>
        </div>
        <div style="background-color:beige"> <hr />
            <span style="font-size:18px;color:darkslateblue;margin-left:2%">OPEN HOURS</span>
            <button onclick="window.open('openhours.html');">Show all</button><br />
             <p id="openhours" style="font-size:small;margin-left:4%">
            </p>

          </div><div style="background-color:antiquewhite">  <hr />
            <span style="font-size:18px;color:darkred;margin-left:2%">
             EMERGENCY </span><button onclick="window.open('emergencycontacts.html');">Contacts</button>
             <button onclick="window.open('http://www.tannerelectric.coop/outages');">Tanner</button>

         </div><div style="margin-left:2%"><hr />
             <span style="font-size:18px;color:black">ISLAND INFORMATION </span><br />

            <button style="width:100%" onclick="window.open('http://andersonislandhs.org');">Historical Society</button><br />
            <button style="width:100%" onclick="window.open('http://www.andersonislandcc.org');">Community Club</button><br />                    
            <button style="width:100%" onclick="window.open('http://rivieracommunityclub.com');">Riviera</button><br />
            <button style="width:100%" onclick="window.open('http://andersonislandparks.org');">Parks</button><br />
            <button style="width:100%" onclick="window.open('http://www.andersonislandgeneralstore.com');">Store</button><br />
            <button style="width:100%" onclick="window.open('http://www.aicab.org');">Citizens Advisory Board</button><br />
            <button style="width:100%" onclick="window.open('http://www.andersonislandsafety.org');">Island Patrol</button><br />
            <button style="width:100%" onclick="window.open('http://www.tannerelectric.coop');">Tanner Electric</button><br />
 
       </div><hr />
            <button style="width:100%" onclick="window.open('aboutus.html');">About Us</button><br />
 

    <div id="deviceready" class="blink">
        <p class="event listening">Connecting to Device</p>
        <p class="event received">Device is Ready</p>
    </div>
</div>

    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript" src="js/AIA.js"></script>

    <script>
        // global date variables. note: scope is for one page only.
        //var d; // date object
        //var dayofweek;  // day of week in 0-6
        //var letterofweek; // letter for day of week
        //var timehhmm;  // hhmm in 24 hour format
        //var month;  // month 1-12. note starts with 1
        //var day; // day of month 1-31
        //var year; // year nnnn
        //var monthday; // mmdd
        //var laborday; // first monday in sept.  we need to compute this dyanmically
        //var memorialday;  // last monday in may
        //var thanksgiving;
        //var holiday;  // true if  holiday

        /////////////////////////////////////////////////////////////////////////////////////////
        // load web pages
        function ShowFerry() {
            window.open("http://www.co.pierce.wa.us/index.aspx?NID=1793");
        }

        //function ShowFerrySchedule() {
        //    window.open("localferryschedule.html");
        //    //window.open("http://www.co.pierce.wa.us/index.aspx?NID=2200");
        //}
        function ShowFerryCams() {
            window.open("ferrywebcams.html");
        }
        //function ShowComingEvents() {
        //    window.open("comingevents.html"); //("http://www.andersonislandcc.org/calendar/");
        //}
        // query for tide times at noaa
        function ShowTides() {
             window.open("tides.html");
        }
        // query for tide times at noaa
        function ShowWeather() {
            window.open("aiweather.html");
        }
        function ShowMap() {
            window.open("https://www.google.com/maps/place/Anderson+Island,+Washington+98303/@47.1559337,-122.7429194,13z/data=!3m1!4b1!4m2!3m1!1s0x5491a7e3857e1e6f:0x9800502f110113b4")
        }
        
        function ShowBurnBan() {
            window.open("http://www.pscleanair.org/priorities/woodheating/Pages/burnbans.aspx")
        }

        function LocalMenu() {

        }

        /////////////////////////////////////////////////////////////////////////////////////////
        // return the next ferry time as a string. ferrytimes is the array of times and days;
        function FindNextFerryTime(ferrytimes) {
            InitializeDates(0);
            var i;
            // roll through the ferry times, skipping runs that are not valid for today
            for (i = 0; i < ferrytimes.length; i = i + 2) {
                if (timehhmm >= ferrytimes[i]) continue;  // skip ferrys that have alreaedy run
                // now determine if the next run will run today.  If it is a valid run, break out of loop.
                if (ValidFerryRun(ferrytimes[i + 1])) break;
            }

            // we ran out of the schedule today so give the 1st run for tomorrow
            if (i >= ferrytimes.length) {
                i = 0;
                // need to compute if tomorrow is a holiday
                if (!IsHoliday(monthday + 1) && (dayofweek == 6)) i = 2; // special case kludge. on saturday, start sunday at 
            }

            // convert to a string and add am or pm and optionally tomorrow
            var ft;
            ft = ShortTime(ferrytimes[i]);
            if (ferrytimes[i] < timehhmm) ft = ft + " tomorrow";
                
            else {
                ft = ft + " (in " + timeDiff(timehhmm, ferrytimes[i]) + ")";
            }
            return ft;
        }

        /////////////////////////////////////////////////////////////////////////////////////////
        // Finds the next ferry times and puts them into the Dom.
        function WriteNextFerryTimes() {
            // ferrytimes = time in 24 hours, S=Steilacoom, A=Anderson Island, 
            // ferrydays:  *=always, H=holiday, 0-6=days of week, AFXY=special rules H=(12/31,1/1,Mem day, 7/3,7/4,labor day,thanksgiving, 12/24,12/25),F=Fuel run 1,3 Wednesday, X=Friday Only labor day-6/30, Y=Fridays only 7/1=labor day
            //var ferrytimeS = [545, "H123456A", 645, "*", 800, "*", 900, "*", 1000, "F", 1200, "*", 1410, "*", 1510, "*", 1610, "*", 1710, "*", 1830, "*", 1930, "*", 2040, "4560H", 2200, "X6H", 2300, "Y"];
            //var ferrytimeA = [615, "H123456A", 730, "*", 830, "*", 930, "*", 1030, "F", 1230, "*", 1440, "*", 1540, "*", 1640, "*", 1740, "*", 1900, "*", 2000, "*", 2110, "4560H", 2230, "X6H", 2330, "Y"];
            // at this point, i = the next valid ferry run
            var v;
            v = "Next Steilacoom: ";
            if (holiday) v = "Hoilday Steilacoom: "
            v = v + FindNextFerryTime(ferrytimeS) + "<br/>Next AI: " + FindNextFerryTime(ferrytimeA);
            document.getElementById("ferrytimes").innerHTML = v;

        }

        /////////////////////////////////////////////////////////////////////////////////////////
        // ShowOpenHours - shows whether something is open or closed
        function ShowOpenHours() {
            // openHours format is array of strings, 1 string per business Defined in AIA.js.
            // each string is: name (phone),Suntime,Montime,Tuetime,Wedtime,Thurtime,Fritime,Sattime,closedholidays
            //   where xxxtime = hhmm-hhmm in 24 hour format. closedholidays = mmdd/mmdd/mmdd...
            var j;
            var openlist;
            var a;
            var store;
            var opentimetoday, opentime, closetime;
            openlist = "";
            // read open hours from master source
            //  1. load it from browser persistant store. 
            //  2. if not there, use the hardwired default.
            //  3. read latest version from anderson-island.org asynchronously and update persistant store and then rerun loop below if it has changed.

            // loop through the openHours array (each string entry is one business)
            for (var i = 0; i < openHours.length; i++) {
                a = openHours[i].split(",");  // parse it into an array
                store = a[0].split("("); // strip out phone number
                openlist += store[0] + ":";
                opentimetoday = a[dayofweek + 1]; // hhmm-hhmm open today
                opentime = Number(opentimetoday.substring(0,4)); // open time hhmm
                closetime = Number(opentimetoday.substring(5, 9)); // close time hhmm
                //alert(openlist );
                // test for closed
                if (opentimetoday = "" || (timehhmm > closetime) || (timehhmm < opentime)) {
                    openlist += " <span style='color:darkred'> Closed. </span>";
                    if (timehhmm < opentime) {
                        openlist += " Opens today at " + ShortTime(opentime) + "<br/>";
                        continue;
                    }
                    // find next open time
                    j = dayofweek + 1; if (j == 7) j = 0;
                    // if it opens tomorrow
                    if (a[j + 1] != "") {  
                        openlist += " Opens tomorrow at " + ShortTime(a[j + 1].substring(0, 4)) + "<br/>";
                        continue;
                    }
                    // not open tomorrow. find next open day.
                    while (true) {
                        j++;  if (j == 7) j = 0; // handle day rollover
                        if (a[j + 1] != "") { // open day found
                            openlist += " Opens " + dayofweekname[j] + " at " + ShortTime(a[j + 1].substring(0, 4)) + "<br/>";
                            break;
                        }
                    } // while loop
                    
                } else {
                    // its open
                    openlist += " <span style='color:green'> Open </span>till " + ShortTime(closetime) + " today<br/>";
                }
            } // end for
            return openlist;
        }

        /////////////////////////////////////////////////////////////////////////////////////
        //  update the next ferry times every minute
        function timerUp() {
            WriteNextFerryTimes();
            // anything else you want to do every minute.
        }
    </script>

    <!-- actual javascript execution begins here:-->
    <script type="text/javascript">
        app.initialize();
        InitializeDates(0);
        WriteNextFerryTimes();
        ShowOpenHours(); //  open hours
        document.getElementById("openhours").innerHTML = ShowOpenHours(); //  open hours
        setInterval("timerUp()", 60000);  // timeout in milliseconds. currently 60 seconds
    </script>
</body>
</html>
