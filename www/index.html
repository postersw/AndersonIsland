<!DOCTYPE html>
<!--
    Anderson Island Assistant.  Single page version.
    Robert Bedoll. 2/23/16. 
	ver 1.1.319: Web. fix weather forecast gmt time conversion
	ver 1.2: Web. add weather icons
	ver 1.3.0414: Web add pushbots
    ver 1.3.0422: Android & IOS release. add pushbots.resetBadge
    ver 1.4.0430: Web only. Add tide graph.  Color code events and add filter.  Add Alert Cancel. 
                  Remove App Store message from non-mobile devices.
    ver 1.5.0509: add OpenHours object (multiple date ranges and time ranges).  Fix weather month.
	
    Copyright (c) 2016 Robert Bedoll, Poster Software LLC.

    Copyright (c) 2012-2014 Adobe Systems Incorporated. All rights reserved.

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  
-->
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
    <!-- removed user-scalable=no, maximum-scale=1 -->
    <meta name="viewport" content="initial-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=medium-dpi" /> <!--device-dpi" />-->
<link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <title>Anderson Island Assistant</title>
    <style>
        button {
            font-size: 14px;
            text-align: left;
        }

        .buttonback {
            background-color: blue;
            border: none;
            color: white;
            float: left;
        }

        p {
            font-size: 14px;
        }

        tr {
            border-style: solid;
            border-width: thin;
            border-color: gray;
            padding-top: 6px;
            padding-bottom: 6px;
        }

        td {
            padding-top: 6px;
            padding-bottom: 6px;
        }

        li {
            border-style: solid;
            border-width: thin;
            border-color: gray;
            padding-top: 6px;
            padding-bottom: 6px;
            padding-left: 6px;
        }
        h1 {
    font-size:18px; /*24px;*/
    font-weight:normal;
    overflow:visible;
    padding:8px;
    margin: 0px;
    text-align:center;
    background-color: blue;
    color:white;
}
    </style>


</head>
<body style="margin:0;padding:0">
    <div class="app">
        <div id="mainpage"  style="display:block">
        <h1 id="appheader">Anderson Island Assistant </h1>

        <span id="topline" style="font-size:small;margin-top:0;margin-bottom:0px;margin-left:6px">Tap an entry for more information.</span>

        <!--App message-->
        <div id='androidapp' style="display:none;background-color:gray;margin-top:0;" onclick="window.open('https://play.google.com/store/apps/details?id=org.anderson_island.andersonislandassistant', '_system');" >
            <strong>Tap for free Install from Google Play Store</strong><br />
        </div>
       <div id='iphoneapp' style="display:none;background-color:gray;margin-top:0;" onclick="window.open('https://itunes.apple.com/us/app/anderson-island-assistant/id1092687892?ls=1&mt=8', '_system');" >
            <strong>Tap for free Install from Apple App Store</strong><br />
        </div>

        <!--Alerts-->
        <div id='alertdiv' onclick="DisplayAlertDetail()" style="display:none;padding-left: 6px">
            <span style="font-size:18px;font-weight:bold;color:red;padding-left: 6px;">ALERT</span>
            <span id='alerttext' style="font-size:small;font-weight:bold;color:red;">alert information goes here</span>
            <!--<div id="alertdetail" style="display:none;font-size:small">Alert detail goes here</div>-->
        </div>

 <table align="center" style="width:100%;padding:0;border-collapse:collapse";>
        <tr style="background-color:azure;" onclick="DisplayFerrySchedulePage();" >
            <td style="padding-left:6px;font-size:18px;font-weight:bold;color:darkblue;padding-left:6px">FERRY </td>
            <td id="ferrytimes" style="font-size:small;margin-top:4px;margin-bottom:4px;">Next : </td>
        </tr>

        <tr style="background-color:azure" >
            <td style="font-size:18px;font-weight:bold;color:darkblue;padding-left:0" colspan="2"> 
                <span onclick="ShowFerryWebCam()">&nbsp&nbsp  WEBCAM&nbsp&nbsp</span>
                <span onclick="ShowFerryLocation()">&nbsp&nbsp LOCATION&nbsp</span>
              </td>
        </tr>

         <tr style="background-color:lightcyan"  onclick="TidesDataPage();"> 
            <td id="tidestitle" style="font-size:18px;font-weight:bold;color:blue;padding-left:6px">
            TIDES </td>
            <td id="tides" style="font-size:small;margin-top:2px;margin-bottom:4px">Next tides:</td>
         </tr>

        <tr style="background-color:honeydew"  onclick="ShowWeatherPage();"> 
            <td style="font-size:18px;font-weight:bold;color:darkgreen;padding-left:6px">
            WEATHER </td>
            <td style="font-size:small;margin-top:4px;margin-bottom:0px">
                <span id="weather" >Current weather:</span><br />
                <span id="forecast" style="font-size:small;margin-top:4px;margin-bottom:0px">Forecast: </span>
            </td> 

         </tr>

        <tr style="background-color:floralwhite;"  onclick="DisplayComingEventsPage('events');">
            <td style="font-size:18px;font-weight:bold;color:darkmagenta;padding-left:6px">
            EVENTS </td>
            <td id="nextevent" style="font-size:small;margin-top:4px;margin-bottom:4px">Next Event:</td>
        </tr>
        <tr style="background-color:floralwhite;"  onclick="DisplayComingEventsPage('activity');">
            <td style="font-size:18px;font-weight:bold;color:darkmagenta;padding-left:6px">
            ACTIVITY </td>
            <td id="nextactivity" style="font-size:small;margin-top:4px;margin-bottom:4px">Next Activity:</td>
        </tr>

     <tr style="background-color:#f0f0f5" onclick="ShowOpenHoursPage();">
            <td style="font-size:18px;font-weight:bold;color:black;padding-left:6px">OPEN<br /> HOURS</td>
             <td id="openhours" style="font-size:small;margin-top:4px;margin-bottom:4px">
            </td>
         </tr>
     
        <tr style="background-color:lightyellow"  onclick="ShowBurnBan();"> 
            <td style="font-size:18px;font-weight:bold;color:darkorange;padding-left:6px">
            BURNBAN </td>
            <td id="burnban" style="font-size:small;margin-top:2px;margin-bottom:4px">Tap for burn ban status.</td>
         </tr>
                
        <tr style="background-color:#fff4b3;" onclick="window.open('http://www.tannerelectric.coop/andersonisland', '_blank' )">  
            <td style="font-size:18px;font-weight:bold;color:#802b00;padding-left:6px">TANNER</td>
            <td id="tanneroutages" style="font-size:small;margin-top:2px;margin-bottom:4px">Tap for outage status.</td>
        </tr>
        <tr style="background-color:white;" onclick="ShowNews()")>  
            <td style="font-size:18px;font-weight:bold;color:black;padding-left:6px" colspan="2">
             NEWS</td>
         </tr>
         <tr style="background-color:antiquewhite;" onclick="ShowEmergencyPage();">  
            <td style="font-size:18px;font-weight:bold;color:darkred;padding-left:6px" colspan="2">
             EMERGENCY CONTACTS</td>
         </tr>

          <tr style="background-color:#cce4ff" onclick="ShowMap();"> 
            <td style="font-size:18px;font-weight:bold;color:darkblue;padding-left:6px" colspan="2">
            MAP </td>  
         </tr>
         <tr style="background-color:lightgray;" onclick="ShowLinksPage();">
             <td style="font-size:18px;font-weight:bold;padding-left:6px" colspan="2">ISLAND INFORMATION LINKS
             </td>            
         </tr>
         <tr> <td style="font-size:18px;font-weight:bold;color:black;padding-left:6px" colspan="2" onclick="ShowPage('helppage')">Help</tr>
             <tr><td style="font-size:18px;font-weight:bold;color:gray;padding-left:6px" colspan="2" onclick="ReloadCachedDataButton();">Reload Data</td></tr>
            <tr> <td style="font-size:18px;font-weight:bold;color:gray;padding-left:6px" colspan="2" onclick="UpdateApp()">Update App</td></tr>
            <tr> <td id="notifyswitch" style="font-size:18px;font-weight:bold;color:gray;padding-left:6px;" colspan="2"> Notifications:
                <span id="notifyon" onclick="NotifyOn()">&nbsp&nbsp  ON&nbsp&nbsp</span>
                <span id="notifyoff" onclick="NotifyOff()">&nbsp&nbsp OFF&nbsp&nbsp</span>
                </td></tr>

            <tr> <td style="font-size:18px;font-weight:bold;color:gray;padding-left:6px" colspan="2">
                <a style="text-decoration:none;color:gray" href="mailto:AIAfeedback@anderson-island.org?Subject=AIAFeedback">Feedback</a></td></tr>
            <tr> <td style="font-size:18px;font-weight:bold;color:gray;padding-left: 6px" colspan="2" onclick="ShowAboutPage();">About</td></tr>
            </table>

    </div>
        

<!------------------------------------------------------------------------------------------------------------------------------------------>
 <!-- FERRY ------------------------------------------------------------------------------------------>
   <div id="ferryschedulepage" style="display:none">

    <h1 > <button class="buttonback" onclick="ShowMainPage()">&larr;BACK</button>
        Ferry Schedule
    </h1>
    <div style="margin:10px">
        <button style="width:40%" onclick="ScheduleByDate();">Other Dates</button>
        <button style="width:40%" onclick="ShowFerry();">Web Site</button>
        <p> </p>
        <table id='ferrytable' style="border:thin solid black;border-collapse:collapse;padding-left:10px">
            <tr style="background-color:black;color:white">
                <td>Steilacoom</td>
                <td>| Anderson Island&nbsp</td>
                <td>| Ketron&nbsp</td>
            </tr>
        </table>
        <hr />
        <p id="schdate"></p>
        <button style="width:32%" onclick="ShowMainPage();">&larr;BACK</button>
      </div>
    </div>

 <!-- OPEN HOURS ------------------------------------------------------------------------------------------>
    <div id="openhourspage" style="display:none">
        <h1>
            <button class="buttonback" onclick="ShowMainPage();">&larr;BACK</button>
            Open Hours
        </h1>
        <div style="margin:10px">
        <button onclick="ShowYRHours()">Show year-round hours and info</button>
        <br /><br />
        <table id='openhourstable' style="border:thin solid black;border-collapse:collapse">
            <tr style="background-color:black;color:white">
                <td>Location</td>
            </tr>
        </table>
        <button style="width:32%" onclick="ShowMainPage();">&larr;BACK</button>
        </div>
   </div>

<!-- COMING EVENTS ------------------------------------------------------------------------------------------>

   <div id="comingeventspage" style="display:none">
        <h1 id="comingeventsH1" style="display:none">
            <button class="buttonback" onclick="ShowMainPage();">&larr;BACK</button>
            COMING EVENTS
           <button style="background-color:blue;color:white;float:right" onclick="ShowOtherCalendars();">MORE</button>
        </h1>
        <h1 id="comingactivitiesH1" style="display:none">
            <button style="background-color:blue;color:white;float:left" onclick="ShowMainPage();">&larr;BACK</button>
            COMING ACTIVITIES
            <button style="background-color:blue;color:white;float:right" onclick="ShowOtherCalendars();">MORE</button>
        </h1>
        <div style="margin:10px">
        <div id="othercalendars" style="display:none">
            <p>CALENDARS:<br />
            <button onclick="window.open('http://www.andersonislandcc.org/calendar/', '_blank');">Comm Club</button>
            <button onclick="window.open('http://rivieracommunityclub.com/event-calendar', '_blank');">Riviera</button>
            <button onclick="window.open('http://andersonislandhs.org', '_blank');">Hist Society</button>
            </p> 
         </div>

       <button style="width:22%" onclick="DisplayComingEventsList( GetEvents())">List</button>
       <button style="width:22%" onclick="DisplayComingWeek( GetEvents())">Week</button>
       <button style="width:22%" onclick="DisplayComingMonth( GetEvents())">Month</button>
        <p></p>
        Tap an item for more information.<br />
        <div id="showevents" style="display:none">
            Items on this page occur once/month or less. <br />
            <strong>SHOW: </strong><span id='eventA' style="color:DarkGreen" onclick="SetEventFilter('')">All</span> |  
            <span  id='eventM' style="color:black" onclick="SetEventFilter('M')">Meetings</span> | 
            <span  id='eventE' style="color:blue" onclick="SetEventFilter('E')">Events</span> | 
            <span  id='eventS' style="color:darkred" onclick="SetEventFilter('S')">Entertainment</span>  
         </div>
        <table id='comingeventstable' style="border:thin solid black;border-collapse:collapse">
            <tr style="background-color:black;color:white">
                <td></td>
            </tr>
        </table>
        <button style="width:32%" onclick="ShowMainPage();">&larr;BACK</button>
        </div>
   </div>
<!--TIDES ------------------------------------------------------------------------------------------>

   <div id="tidespage" style="display:none">
        <h1>
            <button class="buttonback" onclick="ShowMainPage();">&larr;BACK</button>
            Tides at Yoman Point (ferry)
        </h1>
        <div style="margin:10px">
        <p id="tidepagecurrent">Please wait for tide data .... </p>
        <canvas id="tidecanvas" width="300" height="300"></canvas>
        <hr />
        <table id='tidestable' style="border:thin solid gray;border-collapse:collapse;padding-left:10px">
            <tr style="background-color:blue;color:white">
                <td>Date</td>
                <td>| Time&nbsp</td>
                <td>| Type&nbsp</td>
                <td>| Feet&nbsp</td>
                <td>| Range&nbsp</td>
            </tr>
        </table>
        <hr />
        <p id="demo">
        <button id="tideButton" onclick="ShowCustom();" hidden="hidden">Get Tides for other days</button>
        </p>

     <p>These tide predictions are provided for station id 9446705 by Aeris Inc. <br />
         'Range' is the total difference between a high or low tide and the NEXT low or high tide.<br />
         Current height calculated using sine wave fitted between high and low tides.</p>
        <a href="http://opendap.co-ops.nos.noaa.gov/axis/webservices/highlowtidepred/">Tap for NOAA tides for any station and date.</a><br />
        <button style="width:32%" onclick="ShowMainPage();">&larr;BACK</button>
    </div>
  </div>

<!--EMERGENCY ------------------------------------------------------------------------------------------>

  <div id="emergencypage" style="display:none">
        <h1><button class="buttonback" onclick="ShowMainPage();">&larr;BACK</button>
            Emergency Contacts</h1>
     <div style="margin:10px">
        <p>Tap a phone number to dial it.</p>
        <table id="emergencytable">
        </table>
        <button style="width:32%" onclick="ShowMainPage();">&larr;BACK</button>
        </div>
  </div>
<!--WEATHER -------------------------------------------------------------------------------------------->
 <div id="weatherpage" style="display:none">
    <h1>
        <button class="buttonback" onclick="ShowMainPage();">&larr;BACK</button>
        Anderson Island Weather
    </h1>
        <div style="margin:10px">
        <p id="currentweatherpage", style="font-size:12pt; font-weight:bold">Current weather: </p>
        <p id="forecastpage">Please wait for the forecast.</p>
       <table id='forecasttable' style="border:thin solid black;border-collapse:collapse">
            <tr style="background-color:black;color:white;">
                <td>DAY TIME</td>
                <td>TEMP&nbsp</td>
                <td>FORECAST</td>
                <td>RAIN in. </td>
                <td>WIND mph</td>
            </tr>
        </table>
        <p>
            Forecast data provided by OpenWeatherMap.
        </p>
             <button style="width:32%" onclick="ShowMainPage();">&larr;BACK</button>
     </div>
  </div>

<!-- FERRY WEBCAMS ------------------------------------------------------------------------------------->
  <div id="ferrywebcampage" style="display:none">
      <h1>      
          <button class="buttonback" onclick="ShowMainPage();">&larr;BACK</button>
          FERRY WEBCAMS
      </h1>
        <div style="margin:10px">
        <strong>Steilacoom Camera </strong>- refreshes every minute<br>
        <br />
        <img id="steilacoomcam"  alt="Steilacoom Camera " src="icon.png"> 
        <hr/>
        <strong>Anderson Island Camera </strong>- refreshes every minute<br /><br>
        <img id="aicam" src="icon.png"><br />
           <button style="width:32%" onclick="ShowMainPage();">&larr;BACK</button>
        </div>
</div>
 <!-- ABOUT ------------------------------------------------------------------------------------->
  <div id="aboutpage" style="display:none;padding-left:10px">
    <h1> 
      <button class="buttonback" onclick="ShowMainPage();">&larr;BACK</button>
      About
    </h1>
    <p>The <span style="font-weight:bold">Anderson Island Assistant</span> gives you
        instant access to a wealth of time-sensitive Anderson Island information.  
        <p><strong>iPhone/iPad users:</strong>  Install the free iPhone/iPad app from the
            <a href="https://itunes.apple.com/us/app/anderson-island-assistant/id1092687892?ls=1&mt=8"> Apple App Store.</a>
        <p><strong>Android phone users:</strong> Install the free Android phone app from 
            <a href="https://play.google.com/store/apps/details?id=org.anderson_island.andersonislandassistant">Google Play.</a><br />
        </p>
        <hr />
        <p>The Anderson Island Assistant is created and produced by island resident Bob Bedoll at Poster Software, LLC. (www.postersw.com).</p>
        <p> <a style="text-decoration:none;background-color:lightgray;width:50%;padding:12px" href="mailto:support@anderson-island.org">Send Email</a>
            <a style="text-decoration:none;background-color:lightgray;width:50%;padding:12px" href="tel:253-267-4936">Call Us</a></p>
        <p>Email: support@anderson-island.org<br />  Phone: 253-267-4936</p>
        <hr />
          <p style="font-size:small">Anderson Island Assistant" Copyright (c) 2016 Robert Bedoll, Poster Software LLC.
          <br />"PhoneGap/Cordova" libraries Copyright (c) 2012-2014 Adobe Systems Incorporated. All rights reserved.</p>
      <hr />
        <div style="font-size:x-small">
            <span id="phoneweb" >Web version.</span>
            <span id="reloadtime">Data reload time.</span>
            <span id="reloadreason" ></span>
            <span id="currentweathertime" ></span>
            <br />Weather from OpenWeatherMap
      </div>

</div>
<!-- ISLAND INFORMATION LINKS ---------------------------------------------------------------------->
<div id="linkspage" style="display:none">
    <h1> 
        <button class="buttonback" onclick="ShowMainPage();">&larr;BACK</button>
        ISLAND INFORMATION LINKS
    </h1>
            <button style="width:100%;padding:6px;text-align:left" onclick="window.open('http://www.aicab.org', '_system');">Citizens Advisory Board</button><br />
            <button style="width:100%;padding:6px" onclick="window.open('http://www.andersonislandcc.org', '_system');">Community Club</button><br />   
            <button style="width:100%;padding:6px" onclick="window.open('http://www.pcfd27.com', '_system');">Fire and Rescue</button><br />   
            <button style="width:100%;padding:6px" onclick="window.open('http://andersonislandhs.org', '_system');">Historical Society</button><br />                 
            <button style="width:100%;padding:6px" onclick="window.open('http://www.andersonislandsafety.org', '_system');">Island Patrol</button><br />
            <button style="width:100%;padding:6px" onclick="window.open('http://andersonislandparks.org', '_system');">Parks</button><br />
            <button style="width:100%;padding:6px" onclick="window.open('http://www.doh.wa.gov/ehp/sf/biotoxin.htm', '_system');">Redtide Status (WA DOH)</button><br />
            <button style="width:100%;padding:6px" onclick="window.open('http://rivieracommunityclub.com', '_system');">Riviera</button><br />
            <button style="width:100%;padding:6px" onclick="window.open('http://wdfw.wa.gov/fishing/shellfish/', '_system');">Shellfish (WDFW)</button>
            <button style="width:100%;padding:6px" onclick="window.open('http://www.andersonislandgeneralstore.com', '_system');">Store</button><br />
            <button style="width:100%;padding:6px" onclick="window.open('http://www.tannerelectric.coop', '_system');">Tanner Electric</button><br />
</div>
 <!-- HELP ------------------------------------------------------------------------------------->
  <div id="helppage" style="display:none">
    <h1> 
      <button class="buttonback" onclick="ShowMainPage();">&larr;BACK</button>
      Help
    </h1>
    <div style="margin:10px">
    <p>The Anderson Island Assistant is a handy little mobile app that provides instant access 
        to a wealth of up-to-the-minute Anderson Island information.  
       </p>
<table>
    <tr>
        <td style="color:darkblue;vertical-align:text-top">FERRY</td>
        <td>Displays the time of next 2 ferrys to arrive at Anderson Island and Steilacoom, based on the <a href="http://www.co.pierce.wa.us/index.aspx?NID=2200">Pierce County PUBLISHED ferry schedule.</a>.
            It is NOT updated if the ferry is late or out of service.
            (Use the LOCATION button to see where the ferry actually is.)
            <br />The time becomes red within 12 minutes of the departure time.<br />
        <br />TAP to display the ferry schedule computed for the next 7 days, based on the 
            <a href="http://www.co.pierce.wa.us/index.aspx?NID=2200">published ferry schedule.</a>
            The schedule automatically factors in day-of-the-week, holidays, and other unique rules.
            However, it is NOT updated if the ferry is late or out of service.
            <br />"DATES" lets you get the ferry schedule for an arbitrary date. You will be prompted for the date.
            <br />"FERRY LOCATION" displays the current location of the ferry. This information is maintained by Pierce County.
            <br />"FERRY WEB SITE" brings up the full Pierce County Ferry web site, including fares, schedule, ticket purchase, etc.</br>
    </tr>
    <tr>
        <td style="color:darkblue;vertical-align:text-top">WEBCAMS</td>
        <td>Displays the web cams showing the ferry lines. These pictures are automatically updated every minute.</td>
    </tr>
    <tr>
        <td style="color:darkblue;vertical-align:text-top">LOCATION</td>
        <td>Displays the actual current location of the ferry in real time. This information is maintained by Pierce County and is updated every 5 seconds.</td>
    </tr>
    <tr>
        <td style="color:blue;vertical-align:text-top">TIDES</td>
        <td>Displays the computed current tide, and estimated next high and low tides, at Yoman Point (the ferry dock, 
            station id 9446705).  This information is updated every minute.  
            The current tide is interpolated using the 'rule of twelves'.
         <br />TAP to display the projected tides for the next 3 days. Tides are provided by Aeris.com.
            <br />"GET TIDES FOR DATE" will prompt you for a date, and return the projected tides.</td>
    </tr>
    <tr>
        <td style="color:darkgreen;vertical-align:text-top">WEATHER</td>
        <td>Displays the current weather at Steilacoom, and the forcasted weather for 9 hours from now. 
            Forecasted highs and lows are for the next 24 hours. This information is updated every 15 minutes.
        <br />TAP to display the forecast for the next 5 days, in 3 hour increments. Data is provided by 'OpenWeatherMap'.
            <br />'yellow' rows represent daytime periods; 'gray' rows represent nighttime periods.
    </td>
    <tr>
        <td style="color:#ff3300;vertical-align:text-top">BURNBAN</td>
        <td>Tap to display the current PS Clean Air Agency burn-ban status. Anderson Island is part of "Peninsula". 
            Note that this is the air-pollution burn ban only - it is NOT the burn-ban due to fire risk.
            <a href="www.pscleanair.org">Click here for the full site.</a>
        </td>
    </tr>
    <tr>
        <td style="color:darkmagenta;vertical-align:text-top">EVENTS</td>
        <td>Displays all the coming events for today, or the next coming event for any later day.<br />
            TAP to display all the coming events for the next 6 months, in a scrolling list.
            <br />"WEEK" will show the coming events for this week in a one-week grid.
            <br />"MONTH" will show the coming events for the next 6 weeks in a monthly-calendar format.
            <br />'Events' generally occur once/month or less frequently, and are usually meetings, entertainment, 
            or special events.
            <br /><a href="email:support@anderson-island.org">To add your events to this calendar, email us.</a>
        </td>
    </tr>
        <tr>
        <td style="color:darkmagenta;vertical-align:text-top">ACTIVITY</td>
        <td>Activities are similar to EVENTS, but generally occur multiple times/month, often weekly.
            <br /><a href="email:support@anderson-island.org">To add your activities to this calendar, email us.</a>
        </td>
    </tr>
        <tr>
        <td style="color:black;vertical-align:text-top">OPEN HOURS</td>
        <td>Displays the 'open' status for the major island businesses.
            <br />TAP to display the full weekly hours for each business, including easy contact information.
            <br /><a href="email:support@anderson-island.org">To update your business hours, email us.</a>
        </td>
    </tr>
        <tr>
        <td style="color:brown;vertical-align:text-top">TANNER</td>
        <td>TAP to display the current Anderson Island Outage status as maintained by TANNER Electric. 
            This takes you to the Tanner web site.
        </td>
    </tr>
     <tr>
        <td style="color:black;vertical-align:text-top">News</td>
        <td>Displays news articles for Anderson Island.  To submit a news article, send it to 
            support@anderson-island.org.
        </td>
    </tr>

    <tr>
        <td style="color:darkred;vertical-align:text-top">EMERGENCY CONTACTS</td>
        <td>TAP to display a list of emergency contacts.  Tap an entry to dial the phone number.
            <br /><a href="email:support@anderson-island.org">To update this list, email us.</a>
        </td>
    </tr>
    <tr>
        <td style="color:blue;vertical-align:text-top">MAP</td>
        <td>TAP to display a Google map of anderson island.</td>
    </tr>
    <tr>
        <td style="color:black;vertical-align:text-top">ISLAND<br />INFORMATION </td>
        <td>TAP to display a list of links to important Anderson Island web sites.
            Taping on a link opens that web site in your phone's browser.
            <br /><a href="email:support@anderson-island.org">To update this list, email us.</a>
        </td>
    </tr>
    <tr>
        <td style="color:gray;vertical-align:text-top">Reload Data</td>
        <td>TAP to reload the following data from the servers: Tides, Events, Activities, Open Hours, and the Weather.
        </td>
    </tr>
    <tr>
        <td style="color:black;vertical-align:text-top">Notify</td>
        <td>Controls the PC Ferry Alert messages that show up on your phone's main screen. Tap 'OFF' to
            turn these messages off. The ferry alerts will still show at the top of the screen for the AI App.
        </td>
    </tr>
</table>
</div>
</div>
<!-- debugging times ----------------------------------------------------------------------------------->


         <p> &nbsp  Updates every minute.&nbsp  
        <span id="updatetime" >Screen update time.</span><br />        
        <span style="font-size:x-small">  &nbsp  &nbsp   AIA Ver: 1.5.0514.2300		</span>


        </p>


    <div id="deviceready"  style="display:none"> <!-- removed class="blink"-->
        <p class="event listening">Connecting to Device</p>
        <p class="event received">Device is Ready</p>
    </div>
</div>


    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <!-- <script type="text/javascript" src="js/AIA.js"></script> Moved to index.js on 4/25/16 -->

    <script>
        // global date variables in AIA.js. note: scope is for one page only.
        var updateCounter = 0; // counter of timer updates
        var LastUpdatems = 0; // last update time in MS
        var forceCacheReload; // true to force a cache reload
        var forceTideReload;  // true to force tide reload
        var mytimer; // timer number
        var AppStartedTime; // time app started in sec
        var DisplayPage; // name of page being displayed
        var tabletoclear; // name of table to clear

        var datesunrise; // sunrise date object
        var datesunset; // sunset date object
        var daysinmonth = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

        // ferry run times and flags. Heirarchy is:
        //  1. * overrides everything and means always.
        //  2. If a holidays, the run MUST have an H (or *).
        //  3. not a holiday. it goes if it has the day of the week (0-6).
        //  4. otherwise the special case rules are checked (AFHGXY)
        var ferrytimeS = [545, "H123456A", 645, "*", 800, "*", 900, "*", 1000, "HF", 1200, "*", 1410, "*", 1510, "*", 1610, "*", 1710, "*", 1830, "*", 1930, "*", 2040, "4560H", 2200, "X6H", 2300, "Y"];
        var ferrytimeA = [615, "H123456A", 730, "*", 830, "*", 930, "*", 1030, "HF", 1230, "*", 1440, "*", 1540, "*", 1640, "*", 1740, "*", 1900, "*", 2000, "*", 2110, "4560H", 2230, "X6H", 2330, "Y"];
        var ferrytimeK = [000, "        ", 655, "*", 000, " ", 000, " ", 1010, "G", 1255, "*", 000, " ", 0000, " ", 0000, " ", 1800, "*", 0000, " ", 0000, " ", 2130, "40", 2250, "X6H", 2350, "Y"];
        var ferrytimeS2 = [545, "H123456A", 645, "*", 800, "*", 900, "*", 1000, "HF", 1200, "*", 1410, "*", 1510, "*", 1610, "*", 1710, "*", 1830, "*", 1930, "*", 2040, "4560H", 2200, "X6H", 2300, "Y"];
        var ferrytimeA2 = [615, "H123456A", 730, "*", 830, "*", 930, "*", 1030, "HF", 1230, "*", 1440, "*", 1540, "*", 1640, "*", 1740, "*", 1900, "*", 2000, "*", 2110, "4560H", 2230, "X6H", 2330, "Y"];
        var ferrytimeK2 = [000, "        ", 655, "*", 000, " ", 000, " ", 1010, "G", 1255, "*", 000, " ", 0000, " ", 0000, " ", 1800, "*", 0000, " ", 0000, " ", 2130, "40", 2250, "X6H", 2350, "Y"];
        var ferrydate2 = 0;  // cutover time to ferrytimex2

        // OpenHours Array object. Array of openhours for the store hours.  This array is loaded by a JSON.parse
        //      of the OpenHoursJSON string in 'dailycache'
        //  Properties: Name, Phone, Desc, Href: http..., Addr, Map: http for google maps, 
        //      SC[ {From: mmdd, To: mmdd, H[sun open hhmm, sun close hhmm, mo, mc, to, tc, wo, wc, to, tc, fo, fc, so, sc], H2[same as h1] }... ],
        //      Closed [mmdd, ...]
        //      H and H2 are arrays of open and close times as hhmm, indexed by day of week*2.  H2 is optional.
        //      
        var ShowAllOpenHours = false; // true to show all open hours
        var OpenHours = [];
        OpenHours = [{  // single preload for testing and if there is no connectivity
            Name: 'Store', Phone: '884-4001', Desc: 'Groceries, Deli, Hardware, Gas',
            Href: 'https://www.co.pierce.wa.us/index.aspx?NID=1541',
            Addr: '10202 Eckenstam Johnson Rd',
            Map: 'https://www.google.com/maps?q=Anderson+Island+General+Store,+10202+Eckenstam+Johnson+Rd,+Anderson+Island,+WA',
            Sc: [{ From: 101, To: 1231, H: [1000, 1800, 700, 2000, 700, 2000, 700, 2000, 700, 2000, 700, 2100, 800, 2100] }],
            Closed: [1225]
        }];

        /////////////////////////////////////////////////////////////////////////////////////////
        // load web pages
        function ShowFerry() {
            window.open("http://www.co.pierce.wa.us/index.aspx?NID=1793", "_system");
        }

        function ShowMap() {
            window.open("https://www.google.com/maps/place/Anderson+Island,+Washington+98303/@47.1559337,-122.7429194,13z/data=!3m1!4b1!4m2!3m1!1s0x5491a7e3857e1e6f:0x9800502f110113b4", "_blank");
        }

        function ShowBurnBan() {
            window.open("http://wc.pscleanair.org/burnban411/", "_blank");
        }

        function LocalMenu() {

        }

        function ShowNews() {
            window.open('http://www.anderson-island.org/news.html', "_blank");
        }

        // open the correct web page for an upgrade. If its web, force a page reload.
        function UpdateApp() {
            if (isPhoneGap()) {
                if (isAndroid()) {
                    window.open('https://play.google.com/store/apps/details?id=org.anderson_island.andersonislandassistant', '_system');
                } else {
                    window.open('https://itunes.apple.com/us/app/anderson-island-assistant/id1092687892?ls=1&mt=8', '_system');
                }
            } else {
                window.open('http://www.anderson-island.org/?' + Date.now(), '_parent');
            }
        }

        /////////////////////////////////////////////////////////////////////////////////////////////
        // Notify.  Normal situation is notification is on, and the 'NotifyOff' flag is not there.
        //          If notification is off, then 'NotifyOff' is present in local storage.
        function NotifyOn() {
            localStorage.removeItem('notifyoff');
            if (isPhoneGap()) {
                window.plugins.PushbotsPlugin.initialize("570ab8464a9efaf47a8b4568", { "android": { "sender_id": "577784876912" } });
                NotifyColor(1);
            }
        }
        function NotifyOff() {
            localStorage.setItem('notifyoff', 'OFF');
            if (isPhoneGap()) {
                window.plugins.PushbotsPlugin.unregister();
                NotifyColor(0);
            }
        }
        //  Set the color of the notify on/off button.  
        //      onoff = 1 for on, 0 for off.
        function NotifyColor(onoff) {
            if (onoff == 1) {
                document.getElementById('notifyon').setAttribute("style", "color:black");
                document.getElementById('notifyoff').setAttribute("style", "color:gray")
            } else {
                document.getElementById('notifyon').setAttribute("style", "color:gray");
                document.getElementById('notifyoff').setAttribute("style", "color:black")
            }
        }

        //////////////////////////////////////////////////////////////////////////////////////////////
        // Determine whether the file loaded from PhoneGap or the web
        //  exit    true if phonegap, otherwise undefined. So test for true only.
        function isPhoneGap() {
            var test = /^file:\/{3}[^\/]/i.test(window.location.href)
            && /ios|iphone|ipod|ipad|android/i.test(navigator.userAgent);
            return test;
            //(window.cordova || window.PhoneGap || window.phonegap) this returned undefined. 
        }
		function isAndroid() {
		            return ((navigator.userAgent.toLowerCase().indexOf('chrome') > -1) ||
					(navigator.userAgent.toLowerCase().indexOf('android') > -1));
		}

        //isMobile - returns true if a Mobile browser (even if not PhoneGap), else false.  INDEPENDENT OF PHONEGAP.
		function isMobile() {
		    return /ios|iphone|ipod|ipad|android/i.test(navigator.userAgent);
		}
        /////////////////////////////////////////////////////////////////////////////////////////////
        // FixURL = make URL fully qualified if a phonegap app
        //  entry   url = the url
        //  eixt    returns url
        function FixURL(url) {
            url += "?" + Date.now(); // turn off cache
            if (isPhoneGap() == false) {
                if (document.URL.substr(0, 4) == "file") return document.URL.replace("index.html", "") + url;
                else return url;
            }
            return 'http://anderson-island.org/' + url;
        }
        //////////////////////////////////////////////////////////////////////////////////////////////
        // DisplayAlertDetail() - show the alert detail
        //  if user clicks CANCEL, the alert will be hidden until it changes
        //  Exit:  alerthide set if user clicks cancel
        function DisplayAlertDetail() {
            var r = confirm(localStorage.getItem('alerttext') + "\n" + localStorage.getItem('alertdetail')
                + "\n\nClick CANCEL to hide this Alert");
            if (r == false) {
                localStorage.setItem("alerthide", "t");
                DisplayAlertInfo();  // this will hide the alert
            }

        }

        ////////////////////////////////////////////////////////////////////////////////////////////////
        // DisplayAlertInfo()  - sets the alerttext and sets the alertdiv = display:block if there is an alert
        //  NOTE: if 'alerthide' exists, the alert will NOT be displayed.
        function DisplayAlertInfo() {
            if (localStorage.getItem("alerttext") == null || localStorage.getItem("alerttext") == "" ||
                localStorage.getItem("alerthide") != null) {
                document.getElementById("alertdiv").setAttribute('style', 'display:none;');
            } else {
                document.getElementById("alerttext").innerHTML = localStorage.getItem("alerttext");
                document.getElementById("alertdiv").setAttribute('style', 'display:bock;');
            }
        }
        /////////////////////////////////////////////////////////////////////////////////////////////////
        // getAlertInfo - gets the alert info from the server every 12 minutes and save it in alerttext and alertdetail
        //  Entry   'alerthide' = true to hide the alert in 'alerttext'
        //  Exit    'alerttext', 'alertdetail' set.  'alerthide' cleared if the alert has changed.
        function getAlertInfo() {
            var alerttimeout = 720; // alert timeout in sec 12 minutes
            var timestamp = Date.now() / 1000; // time in sec
            var t = localStorage.getItem("alerttime");
            if (t != null && (timestamp - t) < alerttimeout) return; // gets alert async every 12 min.
            var myurl = FixURL('alert.txt');

            $.ajax({
                url: myurl,
                dataType: 'text',
                success: function (r) {
                    var timestamp = Date.now() / 1000; // time in sec
                    localStorage.setItem("alerttime", timestamp); // save the cache time so we don't keep asking forever
                    if (r == "") {  // if the alert is gone, clear it
                        if (isPhoneGap()) {  // if the alert has disappeared, clear the badge
                            var a = localStorage.getItem('alerttext');
                            if ((a != null) && (a != "")) window.plugins.PushbotsPlugin.resetBadge();  // clear ios counter
                        }
                        localStorage.setItem("alerttext", "");
                        localStorage.setItem("alertdetail", "");
                        localStorage.removeItem("alerthide");  // turn off hide
                    } else {  // if there is an alert, save it
                        r = r + "\n";
                        var i = r.indexOf("\n");
                        var atext = r.substr(0, i);
                        if(atext != localStorage.getItem("alerttext")) {  // if alert changed
                            localStorage.setItem("alerttext", atext);
                            localStorage.setItem("alertdetail", r.substr(i));
                            localStorage.removeItem("alerthide");  // turn off hide because alert changed
                        }
                    }
                    DisplayAlertInfo();
                }
            });
        }

        /////////////////////////////////////////////////////////////////////////////////////////
        // return the next ferry time as a string. 
        //      entry ferrytimes is the array of times and days (see ferrytimeA)
        //            ferrytimeK = is the array of times and days for ketron
        function FindNextFerryTime(ferrytimes, ferrytimeK) {
            var ShowTimeDiff = false;
			InitializeDates(0);	
            var i = 0;
			var ketron = false; //ketron run ;
			var nruns = 0; 
			var ft = ""; var ketront = "";
            // roll through the ferry times, skipping runs that are not valid for today
            for (i = 0; i < ferrytimes.length; i = i + 2) {
                if (timehhmm >= ferrytimes[i]) continue;  // skip ferrys that have alreaedy run
                // now determine if the next run will run today.  If it is a valid run, break out of loop.
                if (ValidFerryRun(ferrytimes[i + 1])){
					if(RawTimeDiff(timehhmm, ferrytimes[i])<13) {
						ft = ft + "<span style='color:red'>" + VeryShortTime(ferrytimes[i]) + "</span>";
					} else {
						ft = ft + VeryShortTime(ferrytimes[i]);
					}

					if (ferrytimeK!="") { // add ketron time for this run

						if ((ferrytimeK[i] != 0) && (ValidFerryRun(ferrytimeK[i+1]))){
							ketron = true;
							ketront = ketront + VeryShortTime(ferrytimeK[i]);
						} else ketront = ketront + " --- ";
					}
					if(nruns > 0) break;  // show 2 runs
					ft = ft + ", "; 
					ketront = ketront + ", "; 
					nruns++;
				};
            }

            // we ran out of the schedule today so give the 1st run for tomorrow
            if (i >= ferrytimes.length) {
                i = 0;
                // need to compute if tomorrow is a holiday
                if (!IsHoliday(monthday + 1) && (dayofweek == 6)) i = 2; // special case kludge. on saturday, start sunday at 
                //handle ferry schedule cutover
				ft = ft + VeryShortTime(ferrytimes[i]) + " tomorrow";
            }
			
            if(ShowTimeDiff) ft = ft + " (in " + timeDiff(timehhmm, ferrytimes[i]) + ")";

            // ketron only if there is a ketron run, and it is valid. note iketron ponts to 1st run
            if((ferrytimeK != null) && ketron) ft = ft + "<br><span style='font-weight:bold;color:gray'>Ketron:&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp " + ketront + "</span>";
			return ft;
        }

        /////////////////////////////////////////////////////////////////////////////////////////
        // Finds the next ferry times and puts them into the Dom for the FRONT PAGE
        function WriteNextFerryTimes() {
            // ferrytimes = time in 24 hours, S=Steilacoom, A=Anderson Island, 
            // ferrydays:  *=always, H=holiday, 0-6=days of week, AFXY=special rules H=(12/31,1/1,Mem day, 7/3,7/4,labor day,thanksgiving, 12/24,12/25),F=Fuel run 1,3 Wednesday, X=Friday Only labor day-6/30, Y=Fridays only 7/1=labor day
            //var ferrytimeS = [545, "H123456A", 645, "*", 800, "*", 900, "*", 1000, "F", 1200, "*", 1410, "*", 1510, "*", 1610, "*", 1710, "*", 1830, "*", 1930, "*", 2040, "4560H", 2200, "X6H", 2300, "Y"];
            //var ferrytimeA = [615, "H123456A", 730, "*", 830, "*", 930, "*", 1030, "F", 1230, "*", 1440, "*", 1540, "*", 1640, "*", 1740, "*", 1900, "*", 2000, "*", 2110, "4560H", 2230, "X6H", 2330, "Y"];
            // at this point, i = the next valid ferry run
            var v;
            var str;
            v = "Steilacoom: ";
            if (holiday) v = "Hoilday Steilacoom: "
            if (UseFerryTime1()) v = v + FindNextFerryTime(ferrytimeS, "");
            else v = v + FindNextFerryTime(ferrytimeS2, "");
            // make it bold if not tomorrow
            if (v.indexOf('tomorrow') < 0) v = "<span style='font-weight:bold'>" + v + "</span>";
            var a = "</br>Anderson:&nbsp&nbsp&nbsp " 
            if (UseFerryTime1()) a = a + FindNextFerryTime(ferrytimeA, ferrytimeK);
            else a = a + FindNextFerryTime(ferrytimeA2, ferrytimeK2);
            if (a.indexOf('tomorrow') < 0) a = "<span style='font-weight:bold;color:darkblue'>" + a + "</span>";
            //v = v + FindNextFerryTime(lftS) + "</br>Next Anderson Is: " + FindNextFerryTime(lftA);
            document.getElementById("ferrytimes").innerHTML = v + a;
        }

        ////////////////////////////////////////////////////////////////////////
        //  ParseFerryTimes - convert the ferrytimesx strings into arrays ferrytimex
        //  Entry   localStorage items ferrytimesxx are set
        //  Exit    arrays ferrytimexx are set 
        function ParseFerryTimes() {
            var str = localStorage.getItem("ferrytimess");
            if (str != null) ferrytimeS = str.split(",");
            str = localStorage.getItem("ferrytimesa");
            if (str != null) ferrytimeA = str.split(",");
            str = localStorage.getItem("ferrytimesk");
            if (str != null) ferrytimeK = str.split(",");
            var str = localStorage.getItem("ferrytimess2");
            if (str != null) ferrytimeS2= str.split(",");
            str = localStorage.getItem("ferrytimesa2");
            if (str != null) ferrytimeA2 = str.split(",");
            str = localStorage.getItem("ferrytimesk2");
            if (str != null) ferrytimeK2 = str.split(",");
            str = localStorage.getItem("ferrydate2");
            if (str == null) return;
            var d = new Date(str);  // convert ferry date 2 to ms
            ferrydate2 = d.getTime(d); // ms till cutover
        }

        /////////////////////////////////////////////////////////////////////////
        //  UseFerryTime1 - select ferrytime 1 or ferry time 2 based on cutover date
        //  entry   ferrydate2 = cutover time in ms
        //          timestampms = 'current' time for this function
        //  exit    true to use ferrytime1, false to use ferrydate2
        function UseFerryTime1() {
            if ((ferrydate2 == 0) || (timestampms < ferrydate2)) return true
            else return false;
        }


        

        /////////////////////////////////////////////////////////////////////////////////////////
        // ShowOpenHours - shows whether something is open or closed. 
        //  Entry: OpenHours is an array of objects, loaded from OpenHoursJSON in 'dailycache.txt'
        //  exit: sets the openhours element to the open hours string
        // openHours format is array of objects, 1 object per business.
        // each object is: name, phone, desc, href, 
        //      array of H: from (mmdd), to (mmdd), H [array of 7 hhmm-hhmm opentime-closetime], 
        //                  optional D2 [array of 7 additional hhmm-hhmm opentime-closetime]
        //   where xxxtime = hhmm-hhmm in 24 hour format. 
        //   List more restrictive from/to dates first.
        //     
        function ShowOpenHours() {
            var openlist;
            openlist = "";

            // loop through the openHours array (each array entry is one business)
            for (var i = 0; i < OpenHours.length; i++) {
                Oh = OpenHours[i];  // entry for 1 business
                openlist += "<span style='font-weight:bold'>" + Oh.Name + "</span>:";
                openlist += GetOpenStatus(Oh, monthday, timehhmm) + "<br/>";
                if (i == 2) break; // only do 1st 3 on main page
            } // end for
            openlist += "More ...";
            document.getElementById("openhours").innerHTML = openlist;
            return;
        }

 
        ///////////////////////////////////////////////////////////////////////////////////////
        // GetOpenStatus - determine if business is open & return string.
        //      honors opendates, openhours, and openhours2
        //  entry: Oh = OpenHours object for 1 business
        //          mmdd = month day
        //          hhmm = hours minutes
        //  exit: returns html display string
        function GetOpenStatus(Oh, mmdd, hhmm) {
            var i, j;
            var  opentime, closetime, opentime2, closetime2;
            if (IsClosed(Oh.Closed, mmdd)) return " <span style='color:red'> Closed today. </span>"
            // loop through the oh.Sch entries. Each entry is for 1 date range.
            for (i = 0; i < Oh.Sc.length; i++) {
                if (((mmdd >= Oh.Sc[i].From) && (mmdd <= Oh.Sc[i].To)) ||
                    ((Oh.Sc[i].From > Oh.Sc[i].To) && ((mmdd <= Oh.Sc[i].To) || (mmdd >= Oh.Sc[i].From)))) {

                    // ok we have the H entry for the date, now check it
                    // array is [sunopen, sunclose, monopen, monclose, tueopen, tueclose,.....satopen, satclose]
                    var H = Oh.Sc[i].H;  // array indexed by day of week
                    if (H == null) return " <span style='color:red'> Closed. </span>";  // if no times, its closed
                    opentime = H[dayofweek * 2]; // open time hhmm
                    closetime = H[dayofweek * 2 + 1]; // close time hhmm
                    opentime2 = 0; closetime2 = 0;
                    if (Oh.Sc[i].H2 != null) {  // if there is H 2nd shift
                        opentime2 = Oh.Sc[i].H2[dayofweek * 2];
                        closetime2 = Oh.Sc[i].H2[dayofweek * 2 + 1];
                    }
                    var openlist; openlist = "";
                    // test for open
                    if ((hhmm >= opentime) && (hhmm < closetime))
                        return " <span style='color:green'> Open </span>till " + VeryShortTime(closetime) + " today";
                    else if ((hhmm >= opentime2) && (hhmm < closetime2))  // 2nd shift for Post Office
                        return " <span style='color:green'> Open </span>till " + VeryShortTime(closetime2) + " today";
                    else {
                        // closed right now. Find next open time.
                        openlist += " <span style='color:red'> Closed. </span>";
                        if (hhmm < opentime) return " Opens today " + VeryShortTime(opentime);
                        if (hhmm < opentime2) return " Reopens today " + VeryShortTime(opentime2);
                        //  closed today find next open time
                        j = dayofweek + 1; if (j == 7) j = 0;
                        // if it opens tomorrow
                        if (H[j * 2] > 0) return " Opens tomorrow " + VeryShortTime(H[j * 2]);
                        // not open tomorrow. find next open day.
                        for (var k = 0; k < 7; k++) {  // ensure we check each day only once
                            j++; if (j == 7) j = 0; // handle day rollover
                            if (H[j * 2] > 0) return " Opens " + dayofweekshort[j] + " " + VeryShortTime(H[j * 2]);
                        } // find open day
                    }
                }
            }
            return " <span style='color:red'> Closed. </span>";
        }

        ////////////////////////////////////////////////////////////////////////////////////////
        //  IsClosed - returns true if today is a closed date
        //  entry   Array of closed dates, usually holidays
        //          mmdd = date
        //  exit    True if closed today, else false
        function IsClosed(CA, mmdd) {
            if (CA == null) return false; // not closed
            for (var i = 0; i < CA.length; i++) { // loop through the closed array
                if (mmdd == CA[i]) return true;
            }
            return false;
        }

        

        ////////////////////////////////////////////////////////////////////////////////////////////////////
        // StripDecimal - strips out the decimal part of a numeric text string
        function StripDecimal(n) {
            var ns = String(n);
            var i = ns.indexOf(".");
            if (i < 0) return ns;
            if (i == 0) return "";
            ns = ns.substring(0, i); // strip it
            return ns;
        }
        ////////////////////////////////////////////////////////////////////////////////////////////////////
        //  DegToCompassPoints - converts degrees to compass points
        function DegToCompassPoints(d) {
            var cp = ["N", "NE", "E", "SE", "S", "SW", "W", "NW", "N"];
            if (d == undefined) return "";
            return cp[Math.floor((Number(d) + 22.5) / 45)];
        }

        //////////////////////////////////////////////////////////////////////////////////////////////////////
        // getCurrentWeather  using WorldWeatherMap free service
        //  entry: "currentweathertime" = hhmm of last weather.  null to force now. otherwise we ask every 20 min
        //  exit: saves "currentweathertime" and "currentweather"
        // actual json response {"coord":{"lon":-122.6,"lat":47.17},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"base":"cmc stations","main":{"temp":54.18,"pressure":1023.6,"humidity":69,"temp_min":54.18,"temp_max":54.18,"sea_level":1034.45,"grnd_level":1023.6},"wind":{"speed":3.36,"deg":351.002},"clouds":{"all":0},"dt":1456447797,"sys":{"message":0.0082,"country":"US","sunrise":1456498595,"sunset":1456537846},"id":5812092,"name":"Steilacoom","cod":200}
        function getCurrentWeather() {
            var timestamp = Date.now() / 1000; // time in sec
            var t = localStorage.getItem("currentweathertime");
            if (t != null && ((timestamp - t) < (15 * 60))) return; // gets weather async every 15 min.
            localStorage.setItem("currentweathertime", timestamp); // save the cache time so we don't keep asking forever

            $.ajax({
                url: 'http://api.openweathermap.org/data/2.5/weather?id=5812092&units=imperial&APPID=f0047017839b75ed3d166440bef52bb0',
                dataType: 'jsonp',
                success: function (r) {
                    // short form
                    var rain;
					var icon = "<img src='img/" + r.weather[0].icon + ".png' width=30 height=30>";
                    if (typeof r.rain == 'undefined' || typeof r.rain["3h"] == 'undefined') rain = "0";
                    else rain = (Number(r.rain["3h"]) / 25.4).toFixed(2);
                    var current = icon + " " + StripDecimal(r.main.temp) + "&degF, " + r.weather[0].description + ", " + DegToCompassPoints(r.wind.deg) + " " +
                        StripDecimal(r.wind.speed) + " mph, " + rain + " rain";// + ", " + r.precipitation.value + r.precipitation.value
                    localStorage.setItem("currentweather", current);
                    $("#weather").html(current); // jquery equivalent. Is this really easier?
                    // detailed
                    datesunrise = new Date(Number(r.sys.sunrise) * 1000);
                    datesunset = new Date(Number(r.sys.sunset) * 1000);
                    localStorage.setItem("sunrise", datesunrise.getTime()); // save
                    localStorage.setItem("sunset", datesunset.getTime()); // save
                    var currentlong = icon + r.weather[0].description + ", " + StripDecimal(r.main.temp) + "&degF, " +
                        r.main.humidity + "% RH<br/>Wind " + DegToCompassPoints(r.wind.deg) + " " + StripDecimal(r.wind.speed) + " mph " +
                         ", " + rain + " in. rain" +
                        "<br/>Sunrise: " + datesunrise.toLocaleTimeString() + ", Sunset: " + datesunset.toLocaleTimeString();

                    localStorage.setItem("currentweatherlong", currentlong);
                }
            });
        } // end of function

 
        //////////////////////////////////////////////////////////////////////////////////////////////////////////
        // getForecast using WorldWeatherMap. License for 
        // get weather data using the aeris api and returning a jsonp structure. This is the only way to get data from a different web site.
        // License as of 2/25/16 is for 60 hits/min for free. http://openweathermap.org/price
        //  exit: forecastjson = json full forecast structure, used on full forecast page
        //        forecastjsontime = timestamp
        //        forecast = short form of forecast for main page
        function getForecast() {
            // kludge to prevent over fishing of forecast
            var timestamp = Date.now() / 1000; // time in sec
            var t = localStorage.getItem("forecasttime");
            if (t != null && ((timestamp - t) < (60 * 60))) return; // gets weather forecast async every 60 min.

            $.ajax({
                url: 'http://api.openweathermap.org/data/2.5/forecast?id=5812092&units=imperial&APPID=f0047017839b75ed3d166440bef52bb0',
                dataType: 'jsonp',
                success: function (json) {
                    localStorage.setItem("forecastjson", JSON.stringify(json));  // save it for full forecast
                    localStorage.setItem("forecastjsontime", timehhmm);
                    var timestamp = Date.now() / 1000; // time in sec
                    localStorage.setItem("forecasttime", timestamp); // save the cache time so we don't keep asking forever
                    // get hi and low
                    var i, t;
                    var mint = 9999; var maxt = 0;
                    // scan 8 periods for min and max
                    for (i = 0; i < 8; i++) {
                        t = Math.ceil(Number(json.list[i].main.temp_max));
                        if (t > maxt) maxt = t;
                        if (t < mint) mint = t;
                    }
                    var r = json.list[0];
                    var forecast = "Forecast: " + maxt + "&deg/" + mint + "&deg, " +
                        r.weather[0].description + ", " + DegToCompassPoints(r.wind.deg) + " " + StripDecimal(r.wind.speed) + " mph ";
                    localStorage.setItem("forecast", forecast);
                    $("#forecast").html(forecast);
                }
            });  // end of ajax call
        }  // end of function

        /////////////////////////////////////////////////////////////////////////////////////////////
        // get tide data using the aeris api and returning a jsonp structure. This is the only way to get data from a different web site.
        // License as of 2/8/16 is for 750 hits/day for free.
        //  entry: localStorage "jsontides" = tide data  (refreshed nightly)
        //  exit: forceCacheReload = true to reload tide data.  
        //          html populated.
        function ShowNextTides() {
            var hilow;
            var nextTides;
            var oldtide = -1;
            var newtidetime, oldtidetime, newtideheight, oldtideheight;
            var json = localStorage.getItem("jsontides");
            // get tide data
            if (json === null) {
                forceTideReload = true;
                document.getElementById("tides").innerHTML = "Tide data not available.";
                return;
            }

            var periods = JSON.parse(json); // parse it
            // roll through the reply in jason.response.periods[i]
            var i;
            for (i = 0; i < periods.length; i++) {
                var thisperiod = periods[i];
                var m = Number(thisperiod.dateTimeISO.substring(5, 7));
                var d = Number(thisperiod.dateTimeISO.substring(8, 10));
                var h = Number(thisperiod.dateTimeISO.substring(11, 13)); // tide hour
                var mi = Number(thisperiod.dateTimeISO.substring(14, 16));  // time min
                var tidehhmm = ((h) * 100) + (mi);
                if (thisperiod.type == 'h') hilow = 'High';
                else hilow = 'Low';
                // if tide is past, color row gray
                if ((month > m) || (month == m && dayofmonth > d) || (month == m && dayofmonth == d && (timehhmm > tidehhmm))) {
                    oldtide = 0;
                    oldtidetime = tidehhmm; oldtideheight = thisperiod.heightFT;
                } else if (oldtide != 1) {
                    var cth = CalculateCurrentTideHeight(tidehhmm, oldtidetime, thisperiod.heightFT, oldtideheight);
                    if (thisperiod.type == 'h') {
                        nextTides = "Incoming. Now ";
                        document.getElementById("tidestitle").innerHTML = "TIDE &uarr;";
                    } else {
                        nextTides = "Outgoing. Now ";
                        document.getElementById("tidestitle").innerHTML = "TIDE &darr;";
                    }
                    nextTides += cth.toFixed(1) + "ft.<br/>Next: " + hilow + " " + thisperiod.heightFT + " ft. at " + ShortTime(tidehhmm) +
                         " (in " + timeDiff(timehhmm, tidehhmm) + ")<br/>";
                    oldtide = 1;
                } else if (oldtide == 1) {  // save next tide
                    nextTides += hilow + " " + thisperiod.heightFT + " ft. at " + ShortTime(tidehhmm) + " (in " + timeDiff(timehhmm, tidehhmm) + ")";
                    document.getElementById("tides").innerHTML = nextTides;
                    return;
                }
            }
            forceTideReload = true; // if we haven't gotten today's tides, reload it
        }

        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        // getTideData - call the aeri api and store the response as a local storage string
        //
        function getTideData() {
            var hilow;
            var nextTides;
            var oldtide = -1;
            var t = localStorage.getItem("tidesloadedmmdd");
            if (t != null && (Number(t) == monthday)) return; // gets tides async every day
            //url: 'http://api.aerisapi.com/tides/9446705?client_id=pSIYiKH6lq4YzlsNY54y0&client_secret=vMb1vxvyo7Z96DSn7niwxVymzOxPN6qiEEdBk7vS&from=-20hours&to=+96hours',
            //                url: 'gettides.php',

            $.ajax({
                url: 'http://api.aerisapi.com/tides/9446705?client_id=pSIYiKH6lq4YzlsNY54y0&client_secret=vMb1vxvyo7Z96DSn7niwxVymzOxPN6qiEEdBk7vS&from=-15hours&to=+96hours',
                dataType: 'jsonp',
                success: function (json) {

                    if (json.success == true) {
                        localStorage.setItem("jsontides", JSON.stringify(json.response.periods)); // store the full json structure
                        localStorage.setItem("tidesloadedmmdd", monthday);
                        ShowNextTides();
                    } else {
                        // error
                        alert("cant get tides");
                        //localStorage.setItem("tidesloadedmmdd", monthday);
                    }
                }
            });
        }


        ////////////////////////////////////////////////////////////////////////////////////////////
        // DisplayNextEvent


        ///////////////////////////////////////////////////////////////////////////////////////////////
        // DisplayComingEvents - display the events in the 'comingevents'  or 'comingactivities' local storage object
        //  object consists of rows (separated by /n) 1 for each event or activity
        function DisplayNextEvents(CE) {
            var datefmt = ""; // formatted date
            var iCE; // iterator through CE
            var aCE; // CE split array 
            var aCEmonthday;
            if (CE === null) return;
            // break CE up into rows
            CE = CE.split("\n");  // break it up into rows
            if (CE == "") return;
            // roll through the next 30 days
            for (iCE = 0; iCE < CE.length; iCE++) {
                aCE = CE[iCE].split(';');  // split the string
                //  advance schedule date to today
                aCEmonthday = Number(aCE[0]);
                if (aCEmonthday < monthday) continue; // not there yet
                // if the entry is for today and it is done, skip it
                if (aCEmonthday == monthday && Number(aCE[2]) < timehhmm) continue; // if today and it is done, skip it
                // found it
                if (aCEmonthday != monthday && datefmt != "") return datefmt; // don't return tomorrow if we all the stuff for today
                if (aCEmonthday == monthday) datefmt += "<span style='font-weight:bold'>Today</span>";
                else if (aCEmonthday == (monthday + 1)) datefmt += "Tomorrow";
                else if (aCEmonthday <= (monthday + 6)) datefmt += dayofweekshort[GetDayofWeek(aCE[0])];  // fails on month chagne
                else datefmt += dayofweekshort[GetDayofWeek(aCE[0])] + " " + aCE[0].substring(0, 2) + "/" + aCE[0].substring(2, 4);
                datefmt += " " + VeryShortTime(aCE[1]) + "-" + VeryShortTime(aCE[2]) + " " + aCE[4] + " @ " + aCE[5] + "<br/>";
                // show all events for today
                //if (Number(aCE[0]) == monthday) datefmt += "<br/>";  // event is for today, so go on to the next one
                //else return datefmt;
            }
            return datefmt; // end case
        }


        ///////////////////////////////////////////////////////////////////////////////////////////////
        //  GetComingEvents - retrieves the coming events into the comingevents local storage object
        //  Load from server using ajax async request.
        //  Store into local cache at 'comingevents' and 'comingactivities'  monthday of load stored into local cache at 'comingeventsloaded'
        function GetComingEvents() {
            // ajax async request
            //$.get("comingevents.txt", ComingEventsReceived());
            //                 url: "http://anderson-island.org/comingevents.txt" for phone use fully qualified url
            // changed 3/8/16 to use a php script;
            //var myurl = FixURL("comingevents.txt");
            var myurl = FixURL("getcomingevents.php");
            $.ajax({
                url: myurl,
                success: function (data) {
                    //alert("Data: " + data + "\nStatus: " + status);
                    var i = data.indexOf("ACTIVITIES");
                    if (i == 0) i = data.length;
                    localStorage.setItem("comingevents", data.substring(0, i));
                    if (i < data.length) localStorage.setItem("comingactivities", data.substring(i + 11, data.length));
                    localStorage.setItem("comingeventsloaded", monthday); // save event loaded date/time
                    //alert("coming events loaded at " + monthday);
                    $("#nextevent").html(DisplayNextEvents(localStorage.getItem("comingevents")));
                    $("#nextactivity").html(DisplayNextEvents(localStorage.getItem("comingactivities")));
                }
            });
            //alert("comingevents.txt requested");
            return;
        }

        ///////////////////////////////////////////////////////////////////////////////////////////////
        //  GetDailyCache - retrieves the daily cache into the local storage objects 
        //  Load from server using ajax async request.
        //  FERRYTIMESS,FERRYTIMESA,OPENHOURS,OPENHOURSEND,EMERGENCY,EMERGENCYEND
        function GetDailyCache() {
            // ajax async request
            var myurl = FixURL("dailycache.txt"); 
            $.ajax({
                url: myurl, // for phone use fully qualified url http://anderson-island.org/
                success: function (data) {
                    InitializeDates(0);
                    ReloadDailyCache(data);
                    localStorage.setItem("dailycacheloaded", monthday); // save event loaded date/time
                    localStorage.setItem("dailycacheloadedtime", timehhmm); // save event loaded date/time
                    // now update stuff on mainpage that uses daily cache data
                    ShowOpenHours();
                    WriteNextFerryTimes();
                    DisplayLoadTimes();
                }
            });

            return;
        }

        ////////////////////////////////////////////////////////////////////////////////////////
        // ReloadDailyCache - parses the daily cache into its parts in local storage
        //  note: data must be in the order of FERRYTIMESS,FERRYTIMESA,OPENHOURS,OPENHOURSEND,EMERGENCY,EMERGENCYEND
        function ReloadDailyCache(data) {
            var s;

            data = data.replace(/\r/g, ""); // remove all crs regular expression with global flag
            //var rows = data.split("\n"); //split into lines
            if (data.substring(0, 10) != "DAILYCACHE") {
                //alert("could not load updated values for ferry times and open hours");
                document.getElementById("reloadreason").innerHTML = "Could not load dailycache data.";
                return;
            }

            localStorage.setItem("dailycacheloaded", monthday); // remember date time
            parseCache(data, "ferrytimess", "FERRYTIMESS", "\n");
            parseCache(data, "ferrytimesa", "FERRYTIMESA", "\n");
            parseCache(data, "ferrytimesk", "FERRYTIMESK", "\n");
            //parseCache(data, "openhours", "OPENHOURS", "OPENHOURSEND");  obsolete in ver 1.5 5/2016.
            //parseCache(data, "morehours", "MOREHOURS", "MHEND");
            parseCache(data, "emergency", "EMERGENCY", "EMERGENCYEND");
            parseCache(data, "links", "LINKS", "LINKSEND");
            s = parseCache(data, "openhoursjson", "OPENHOURSJSON", "OPENHOURSJSONEND");
            if (s > 0) OpenHours = JSON.parse(localStorage.getItem("openhoursjson"));  // parse it
            // new ferry schedule 
            parseCache(data, "ferrytimess2", "FERRYTIMESS2", "\n");
            parseCache(data, "ferrytimesa2", "FERRYTIMESA2", "\n");
            parseCache(data, "ferrytimesk2", "FERRYTIMESK2", "\n");
            parseCache(data, "ferrydate2", "FERRYDATE2", "\n"); // cutover date to ferrtimes2 as 'mm/dd/yyyy'
            ParseFerryTimes();
        }
        /////////////////////////////
        // parseCache - returns the string from the daily cache
        //  name = name of local storage item
        //  startstr = starting string, endstr = ending string
        //  exit    returns length of string
        function parseCache(data, name, startstr, endstr) {
            var s = data.indexOf(startstr);
            if (s < 0) return 0;
            var e = data.indexOf(endstr, s + startstr.length + 1);
            if (e < 0) return 0;
            var len = e - s - startstr.length - 1;
            localStorage.setItem(name, data.substring(s + startstr.length + 1, e));
            return len;
        }

        /////////////////////////////////////////////////////////////////////////////////////
        //  update all data on a regular basis. 
        //  also redisplay the next ferry times & tides & open hours every minute
        //  update current weather every 15 minutes. update forecast every 30 minutes.
        //  Called every 60 secs and every time the main page is redisplayed.
        function timerUp() {

            // everything you want to do every minute. These all go against localStorage strings, so no query
            InitializeDates(0);
            LastUpdatems = timestampms;
            updateCounter++;
            document.getElementById("updatetime").innerHTML = "Updated " + FormatTime(timehhmm);

            // special handling for other than the main page
            switch (DisplayPage) {
                case "comingeventspage":
                    return;
                case "emergencypage":
                    return;
                case "ferryschedulepage":
                    return;
                case "openhourspage":
                    return;
                case "tidespage":
                    if (usertideselection) return;
                    TidesDataPage();
                    //var periods = JSON.parse(localStorage.getItem("jsontides"));
                    //ShowTideDataPage(periods, true);
                    return;
                case "weatherpage":
                    return;
                case "ferrywebcampage":
                    ShowFerryWebCam();
                    return; // how to force redisplay
                case "aboutpage":
                    DisplayLoadTimes();
                    return;

            }

            // main page update

            ShowCachedData();

            // reload daily stuff - ferry schedule, store hours, coming events, tides
            var dailycacheloaded = localStorage.getItem("dailycacheloaded");
            if ((dailycacheloaded == null) || (Number(dailycacheloaded) != monthday)) {
                ReloadCachedData();
            }

            // get tides once/day
            getTideData();

            // current weather every 20 
            getCurrentWeather(); // gets weather async every 20 min. Timer is in routine.

            // forecast every 4 hours
            getForecast(); // gets weather async every 4 hour. Timer is in routine.

            // alerts every 12 minutes
            getAlertInfo();

            DisplayLoadTimes();
        }

        /////////////////////////////////////////////////////////////////////////////
        // focus and blur events
        function focusEvent() {
            if (mytimer == null) {  // if timer is off
                mytimer = setInterval("timerUp()", 60000);  // restart timeout in milliseconds. currently 60 seconds
                timerUp(); // restart the timer if needed
            } else {  
				var d = new Date();
				if((d.getTime() - LastUpdatems) > 60000) timerUp(); // if > 60 secs
			}
        }

        function blurEvent() {
            clearInterval(mytimer); // TURN OFF TIMER WHEN FOCUS IS LOST
            mytimer = null;
        }

	/////////////////////////////////////////////////////////////////////////////////////////
	//  onResume
	function onPause() {
	}

	function onResume() {
		focusEvent();
	}

        function backKeyDown() {
            // Call my back key code here.
            if (DisplayPage == 'mainpage') navigator.app.exitApp();
            ShowMainPage();
        }

        //////////////////////////////////////////////////////////////////////////////////
        // show all cached data, i.e. all data in localStorage.
        // 
        function ShowCachedData() {
            WriteNextFerryTimes();  // show cached ferry schedule
            ShowNextTides(); // show cached tide data
            DisplayAlertInfo();
            ShowOpenHours(); //  open hours
            $("#nextevent").html(DisplayNextEvents(localStorage.getItem("comingevents")));
            $("#nextactivity").html(DisplayNextEvents(localStorage.getItem("comingactivities")));

            s = localStorage.getItem("forecast");
            if (s != null) document.getElementById("forecast").innerHTML = s;

            s = localStorage.getItem("currentweather"); // cached current weather
            if (s != null) document.getElementById("weather").innerHTML = s;

            DisplayLoadTimes();
        }

        ////////////////////////////////////////////////////////////////////////////////////
        // Reload cached data - calls all the ajax calls to get the data and recache it in localStorage.
        //
        function ReloadCachedData() {
            //alert("reload cached data");
            InitializeDates(0);
            GetDailyCache();  // no limit
            GetComingEvents();// no limit
            localStorage.removeItem("alerttime");
            getAlertInfo();
            localStorage.removeItem("tidesloadedmmdd"); // force tides
            getTideData();// no limit
            localStorage.removeItem("forecasttime"); // force forecast reload at start of new day
            getForecast();// limited to every 120 min
            localStorage.removeItem("currentweathertime"); // force weather reload at start of new day
            getCurrentWeather();// limited to every 20 min
            DisplayLoadTimes();
        }

        function ReloadCachedDataButton() {
            ReloadCachedData();
            alert("Data has been reloaded.");
        }

        //////////////////////////////////////////////////////////////////////////////////////
        // DisplayLoadTimes() displays time data loaded
        function DisplayLoadTimes() {
            document.getElementById("reloadtime").innerHTML = "App started " + AppStartedDate +
                ", update counter: " + updateCounter +
                ",<br/>Cached reloaded " + localStorage.getItem("dailycacheloaded") + " @" + localStorage.getItem("dailycacheloadedtime") +
                ", Tides:" + localStorage.getItem("tidesloadedmmdd") +
                "<br/>Forecast:" + Math.ceil(((timestampms / 1000) - Number(localStorage.getItem("forecasttime"))) / 60) + " min ago, " +
                "CurrentWeather:" + Math.ceil(((timestampms / 1000) - Number(localStorage.getItem("currentweathertime"))) / 60) + " min ago ";

        }

        ////////////////////////////////////////////////////////////////////////////////////////
        // show page (new page name). Turns off the page currently being displayed (displaypage) and turns on newpage.
        //  newpage = id of div for page, 'displaypage' = name of currently displaying page, 
        //  'tabletoclear' = name of table to clear in former page
        //  exit    displaypage = the new page
        function ShowPage(newpage) {
            if (DisplayPage == newpage) return;
            // clear out rows of table for former page
            if (tabletoclear != null) {
                var table = document.getElementById(tabletoclear);
                if (table != null) clearTable(table);
                tabletoclear = null;
            }
            // now switch to new page
            document.getElementById(DisplayPage).setAttribute('style', 'display:none;');
            document.getElementById(newpage).setAttribute('style', 'display:block;');
            DisplayPage = newpage; // remember it
        }

        ///////////////////////////////////////////////////////////////////////////////////////////////////
        // show main page
        function ShowMainPage() {
            ShowPage("mainpage");
            timerUp();
        }

    </script>

    <!-- FERRY ------------------------>
    <script>
        //==== FERRY SCHEDULE =======================================================================================

        // FERRY SCHEDULE PAGE as a DIV.  Replaces 'localferryschedule.html'

        // loads the ferry schedule at pierce web page
        function ShowFerrySchedule() {
            window.open("http://www.co.pierce.wa.us/index.aspx?NID=2200", "_blank");
        }
        function ShowFerryLocation() {
            window.open("http://matterhorn11.co.pierce.wa.us/FerryStatus/", "_blank");
        }


        /////////////////////////////////////////////////////////////////////////////////////////
        // Loads the next ferry times into the global 'table' as a row for each run. 
        // ferrytimesS, ferrytimesA is the array of times and days for Steelacoom and AI;
        function BuildFerrySchedule(ferrytimesS, ferrytimesA, ferrytimesK) {
            var i;
            var ft;
            // roll through the ferry times, skipping runs that are not valid for today
            for (i = 0; i < ferrytimesS.length; i = i + 2) {
                if (timehhmm >= ferrytimesS[i] && timehhmm >= ferrytimesA[i]) continue;  // skip ferrys that have alreaedy run
                // now determine if the next run will run today.  If it is a valid run, break out of loop.
                if (ValidFerryRun(ferrytimesS[i + 1])) {
                    // Steelacoom
                    var row1, row1col1, row1col2;
                    row1 = table.insertRow(-1);
                    row1col1 = row1.insertCell(0);
                    row1col1.style.border.width = 1;
                    row1col1.innerHTML = "&nbsp&nbsp" + FormatTime(ferrytimesS[i]);
                    row1col1.style.border = "thin solid black";
                    // Anderson Island;
                    row1col2 = row1.insertCell(1);
                    row1col2.innerHTML = "&nbsp&nbsp" + FormatTime(ferrytimesA[i]);
                    row1col2.style.color = "darkblue";
                    row1col2.style.border = "thin solid black";
                    // Ketron
                    var row1col3 = row1.insertCell(2);
                    if (ferrytimesK[i] != 0) {
                        if (ValidFerryRun(ferrytimesK[i + 1])) {
                            row1col3.innerHTML = "&nbsp&nbsp" + FormatTime(ferrytimesK[i]);
                            row1col3.style.color = "brown";
                            row1col3.style.border = "thin solid black";
                        }
                    }

                }
            }
            return;
        }

        //////////////////////////////////////////////////////////////////////////////////
        // ScheduleByDate - ask for date and then run schedule
        function ScheduleByDate() {
            var userdate = GetDateFromUser();
            if (userdate == "") return;
            DisplayFerrySchedule(userdate);
        }

        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        // Display the page
        function DisplayFerrySchedulePage() {
            ShowPage("ferryschedulepage");
            DisplayFerrySchedule("");
        }

        ////////////////////////////////////////////////////////////////
        // DisplayFerrySchedule displays the grid
        //  entry date = "" for today, else mm/dd
        function DisplayFerrySchedule(userdate) {
            if (userdate == "") InitializeDates(0);
            else InitializeDates(userdate);


            table = document.getElementById("ferrytable");
            tabletoclear = "ferrytable";
            clearTable(table);

            row1 = table.insertRow(-1);
            row1col1 = row1.insertCell(0);
            row1col1.style.backgroundColor = "blue";
            row1col1.style.color = "white";
            if (userdate == "") row1col1.innerHTML = 'TODAY';
            else row1col1.innerHTML = dayofweekname[dayofweek];
            row1col1 = row1.insertCell(1);
            row1col1.style.backgroundColor = "blue";
            row1col1.style.color = "white";
            row1col1.innerHTML = month + "/" + dayofmonth + (holiday ? " Holiday" : "");
            row1col1 = row1.insertCell(2);
            row1col1.style.backgroundColor = "blue";

            if (UseFerryTime1()) BuildFerrySchedule(ferrytimeS, ferrytimeA, ferrytimeK);
            else BuildFerrySchedule(ferrytimeS2, ferrytimeA2, ferrytimeK2);
            // build next 6 days
            timehhmm = 0;  // ignore current time
            var i;
            for (i = 0; i < 7; i++) {
                InitializeDates(1);  // tomorrow
                //alert(monthday + " dow " + dayofweek);
                row1 = table.insertRow(-1);
                row1col1 = row1.insertCell(0);
                row1col1.style.backgroundColor = "blue";
                row1col1.style.color = "white";
                row1col1.innerHTML = dayofweekname[dayofweek];
                row1col1 = row1.insertCell(1);
                row1col1.style.backgroundColor = "blue";
                row1col1.style.color = "white";
                row1col1.innerHTML = month + "/" + dayofmonth + (holiday ? " Holiday" : "");
                row1col1 = row1.insertCell(2);
                row1col1.style.backgroundColor = "blue";
                if (UseFerryTime1()) BuildFerrySchedule(ferrytimeS, ferrytimeA, ferrytimeK);
                else BuildFerrySchedule(ferrytimeS2, ferrytimeA2, ferrytimeK2);
            }
            InitializeDates(0);  // reset dates back
            //alert("build ferry sch done");
            //Append Table into div.
            //document.getElementById('divTable').appendChild(table);
            //document.getElementById('schdate').innerHTML = "Based on schedule as of " + scheduledate[0];             // mark schedule date
            //alert("appended table to divTable");
        }
    </script>

    <!-- OPEN HOURS -->
    <script>
        //======== OPEN HOURS ============================================================================

        /////////////////////////////////////////////////////////////////////////////////////////
        // ShowOpenHours - shows whether something is open or closed
        // openHours (global) is a string consisting of strings (rows) of store hours, separated by /n.
        // each string is: name,Suntime,Montime,Tuetime,Wedtime,Thurtime,Fritime,Sattime,closedholidays
        //   where xxxtime = hhmm-hhmm in 24 hour format. closedholidays = mmdd/mmdd/mmdd...
        function ShowOpenHoursPage() {
            var openlist;
            ShowAllOpenHours = false;
            ShowPage("openhourspage");
            InitializeDates(0);
            ShowOpenHoursTable(ShowAllOpenHours);
            return;
        }

        /////////////////////////////////////////////////////////////////////////////////////////
        // ShowOpenHours - Displays all businesses in the OpenHours Object
        //  Entry showall = true to show all dates, false to only show hours for current dates

        function ShowOpenHoursTable(showall) {
            table = document.getElementById("openhourstable");
            tabletoclear = "openhourstable";
            clearTable(table);
            openlist = "";

            // loop through the openHours array for each business
            var i;
            for (i = 0; i < OpenHours.length; i++) {
                var Oh = OpenHours[i];  // entry for 1 business
                openlist = FormatOneBusiness(Oh, monthday, showall);
                var row = table.insertRow(-1);
                var cell = row.insertCell(0);
                cell.innerHTML = openlist;
                cell.style.border = "thin solid black";
                //cell.id = i;
                //cell.onclick = function () { showdiv (this.id)}
            }
            return;
        }

        //function showdiv(id) {
        //    var i = Number(id);
        //    alert(OpenHours[i].Name + "\n" + OpenHours[i].Desc + "\n" + OpenHours[i].Addr) 
        //}

        //////////////////////////////////////////////////////////////////////////////////////
        // FormatOneBusiness - formats one OpenHours object
        //  Entry   Oh = one OpenHours object,  showall = true for all dates
        //  Exit    returns html for a table entry                                onclick="alert('abc')" 
        function FormatOneBusiness(Oh, mmdd, showall) {
            var openlist = "<span style='font-weight:bold;font-size:18px;color:blue'>" + Oh.Name + "&nbsp&nbsp</span><span style='font-weight:bold'>" + GetOpenStatus(Oh, mmdd, timehhmm) + " </span><br/>";
            if (showall) openlist += Oh.Desc + "<br/>" + Oh.Addr + "<br/>";
            var mmdd7 = newDate(mmdd + 7);  // 7 days after

            // loop through the Oh.Sc entries. Each entry is for 1 date range.
            // We could hit multiple date ranges
            var nr = 0; // number of ranges
            for (var i = 0; i < Oh.Sc.length; i++) {
                if (showall || ((mmdd7 >= Oh.Sc[i].From) && (mmdd <= Oh.Sc[i].To)) ||
                    ((Oh.Sc[i].From > Oh.Sc[i].To) && ((mmdd <= Oh.Sc[i].To) || (mmdd7 >= Oh.Sc[i].From)))) {  // if we are in range
                    // print date range if there is > 1  (Oh.Sc.length>1)
                    if (showall || (nr > 0)) openlist += "<strong>Open " + formatDate(Oh.Sc[i].From) + " - " + formatDate(Oh.Sc[i].To) + ":</strong><br/>";
                    var H = Oh.Sc[i].H; // H is the hours array, indexed by day of week*2
                    var H2 = Oh.Sc[i].H2; // 2nd hours
                    nr = nr + 1;
                    // loop through Sun - Sat
                    for (var j = 0; j < 7; j++) {
                        var opentimetoday;
                        opentimetoday = H[j * 2]; // hhmm-hhmm open today
                        if (opentimetoday > 0) {
                            openlist += "<nobr>" + dayofweekshort[j] + ":" + VeryShortTime(opentimetoday) + "-" + VeryShortTime(H[j * 2 + 1]);
                            if (H2 != null) {
                                if (H2[j * 2] > 0) openlist += ", " + VeryShortTime(H2[j * 2]) + "-" + VeryShortTime(H2[j * 2 + 1]);
                            }
                            openlist += "</nobr>";
                            if (j < 6) openlist += ", ";
                        }
                    } // for loop for each day
                    openlist += "<br/>";

                }
            } // end for  for 1 date range

            // find any closed dates in this week range and list them
            var closedlist = "";
            if (Oh.Closed != null) {
                for (var i = 0; i < Oh.Closed.length; i++) {
                    if ((Oh.Closed[i] >= mmdd) && (Oh.Closed[i] <= mmdd7)) closedlist += "this " + dayofweekshort[GetDayofWeek(Oh.Closed[i])] + " " + formatDate(Oh.Closed[i]) + ", ";
                    else if(showall) closedlist += dayofweekshort[GetDayofWeek(Oh.Closed[i])] + " " + formatDate(Oh.Closed[i]) + ", ";
                }
                if (closedlist != "") openlist += "<span style='color:red;font-weight:bold'>Closed </span>" + closedlist + "<br/>";
            }
            // buttons for call and web site
            return openlist + "<br/>&nbsp&nbsp" +
                "<a style='display:normal;text-decoration:none;background-color:lightgray;padding:8px;width:300px' href='tel:" + Oh.Phone + "'>Call " + Oh.Phone + "</a>&nbsp&nbsp&nbsp&nbsp" +
                "<a style='display:normal;text-decoration:none;background-color:lightgray;padding:8px;width:300px' href='" + Oh.Href + "'>Web Site</a>&nbsp&nbsp&nbsp&nbsp" +
                "<a style='display:normal;text-decoration:none;background-color:lightgray;padding:8px;width:300px' href='" + Oh.Map + "'>Map</a><br/>&nbsp";
                

        } // end of function


        function ShowYRHours() {
            ShowAllOpenHours = !ShowAllOpenHours;
            ShowOpenHoursTable(ShowAllOpenHours);
        }

        ////////////////////////////////////////////////////////////////////////////
        // newDate - returns the date as mmdd based on mmdd where dd could be > 28
        function newDate(oldmmdd) {
            if ((oldmmdd % 100) < 28) return oldmmdd; // if we didn't change month, just return
            var d = new Date(2016, Math.floor(oldmmdd / 100) - 1, oldmmdd % 100); // calculate new month
            return (d.getMonth() + 1) * 100 + d.getDate();
        }
        //////////////////////////////////////////////////////////////////////////////////
        // formatDate - transforms mmdd into string: mm/dd
        //  entry   integer date in mmdd form
        //  exit    string: mm/dd
        function formatDate(nmmdd) {
            return Math.floor(nmmdd / 100).toFixed(0) + "/" + (nmmdd % 100).toFixed(0);
        }

        //////////////////////////////////////////////////////////////////////////
        // parseOpenHours - parse the json structure in 'openhoursjson' and populate OpenHours
        //  entry   local storage "openhoursjson"
        //  exit    OpenHours object array is set
        function ParseOpenHours() {
            var s = localStorage.getItem("openhoursjson");
            if (s != null) {
                try {
                    OpenHours = JSON.parse(s);  // parse it  
                } catch (e) {
                    alert(e);
                    forceCacheReload = true;
                }
            } else forceCacheReload = true;
        }

        ////    // read open hours from master source
        ////    var openHours = localStorage.getItem("openhours") + localStorage.getItem("morehours");
        ////    openHours = openHours.split("\n");

        ////    // loop through the openHours array (each string entry is one business)
        ////    var i;
        ////    for (i = 0; i < openHours.length - 1; i++) {
        ////        var a; a = openHours[i].split(",");  // parse it into an array
        ////        openlist = "<span style='font-weight:bold'>" + a[0] + GetOpenStatus(a) + " </span><br/>";  // name of business
        ////        var phonenumber = a[0].split("(");
        ////        phonenumber[1] = phonenumber[1].replace(")", ""); // remove closing paren
        ////        // loop through Sun - Sat
        ////        for (j = 0; j < 7; j++) {
        ////            var opentimetoday, opentime, closetime;
        ////            opentimetoday = a[j + 1]; // hhmm-hhmm open today
        ////            if (opentimetoday != "") {
        ////                opentime = opentimetoday.substring(0, 4); // open time hhmm
        ////                closetime = opentimetoday.substring(5, 9); // close time hhmm
        ////                openlist += "<nobr>" + dayofweekshort[j] + ":" + VeryShortTime(opentime) + "-" + VeryShortTime(closetime) + "</nobr>";
        ////                if (j < 6) openlist += ", ";
        ////            }
        ////        } // for loop for each day
        ////        var row = table.insertRow(-1);
        ////        var s = '' + a[8] + '';
        ////        //if (a[8] != "") row.onclick = function () { window.open(s); };
        ////        var cell = row.insertCell(0);
        ////        cell.innerHTML = openlist + "<br/><br/>&nbsp&nbsp" +
        ////            "<a style='display:normal;text-decoration:none;background-color:lightgray;padding:8px;width:300px' href='tel:" + phonenumber[1] + "'>Call " + phonenumber[1] + "</a>&nbsp&nbsp&nbsp&nbsp" +
        ////            "<a style='display:normal;text-decoration:none;background-color:lightgray;padding:8px;width:300px' href='" + a[8] + "'>Web Site</a><br/>&nbsp";
        ////        cell.style.border = "thin solid black";
        ////    } // for loop for each business
        ////}


    </script>
    <!-- COMING EVENTS ---------------->
    <script>
        //========= COMING EVENTS ===========================================================================

        ////////////////////////////////////////////////////////////////////////////////////////////////
        // DisplayComingEventsPage(type)
        //  entry   type = 'events' or 'activities'
        var EventFilter = ""; //letter to filter for
        var EventDisp = ""; // event display type, L, W, M

        function DisplayComingEventsPage(type) {
            localStorage.setItem("eventtype", type);
            document.getElementById("othercalendars").setAttribute("style", "display:none");
            ShowPage("comingeventspage");
            InitializeDates(0);
            EventFilter = ""; // clear filter
            document.getElementById("eventA").style.fontWeight = "bold";
            if (type == "events") {
                document.getElementById("comingeventsH1").setAttribute('style', 'display:normal;');
                document.getElementById("showevents").setAttribute('style', 'display:normal;');
                document.getElementById("comingactivitiesH1").setAttribute('style', 'display:none;');
            } else {
                document.getElementById("comingeventsH1").setAttribute('style', 'display:none;');
                document.getElementById("showevents").setAttribute('style', 'display:none;');
                document.getElementById("comingactivitiesH1").setAttribute('style', 'display:normal;');
            }
            DisplayComingEventsList(GetEvents())
        }

        ////////////////////////////////////////////////////////////////////////////////////////
        // GetEvents gets the events and returns them, based on the activities parameter in the url
        function GetEvents() {
            if (localStorage.getItem("eventtype") == "events") {
                return localStorage.getItem("comingevents");  //display stored data in case we can't successfully reload the comingevents cache
            } else {
                return localStorage.getItem("comingactivities");  //display stored data in case we can't successfully reload the comingevents cache\
            }
        }

        function ShowOtherCalendars() {
            document.getElementById("othercalendars").setAttribute("style", "display:normal");
        }

        ////////////////////////////////////////////////////////////////////////////////
        // SetEventFilter - sets the filter letter and regenerates the display
        //  Entry   f = A, M, S, E
        function SetEventFilter(f) {
            // bold the selection
            document.getElementById("eventA").style.fontWeight = "normal";
            document.getElementById("eventM").style.fontWeight = "normal";
            document.getElementById("eventS").style.fontWeight = "normal";
            document.getElementById("eventE").style.fontWeight = "normal";
            switch (f) {
                case "": document.getElementById("eventA").style.fontWeight = "bold"; break;
                case "M": document.getElementById("eventM").style.fontWeight = "bold"; break;
                case "S": document.getElementById("eventS").style.fontWeight = "bold"; break;
                case "E": document.getElementById("eventE").style.fontWeight = "bold"; break;
            }
            EventFilter = f;

            switch (EventDisp) {
                case "L": DisplayComingEventsList(GetEvents()); break;
                case "W": DisplayComingWeek(GetEvents()); break;
                case "M": DisplayComingMonth(GetEvents()); break;
            }
        }

        ///////////////////////////////////////////////////////////////////////////////////////////////
        // DisplayComingEventsList - display the events in the CE string, which is a copy of the comingevents txt file
        //  or the 'ACTIVITIES' section of the comingevents text file. These are cached in the 'comingevents' 
        // or 'comingactivities' localStorage items. 
        //  entry   CE is a single big string containing multiple lines, so we split the string by \n.
        function DisplayComingEventsList(CE) {
            var i;
            var row;
            var col;
            var idayofweek;
            var lastweek = 0;
            var lastdayofweek = 100; // 0-6 of previous row
            var previouseventdate; // date of previous event
            var datefmt; // formatted date
            var table // ref to table
            EventDisp = "L";
            table = document.getElementById("comingeventstable");
            tabletoclear = "comingeventstable";
            var iCE; // iterator through CE
            iCE = 0;
            var aCE; // CE split array 
            if (CE == null) return;
            CE = CE.split("\n");  // break it up into rows
            if (CE == "") return;
            clearTable(table); // clear table
            table.deleteRow(-1);
            // add a new week header
            row = table.insertRow(-1);
            row.style.border = "solid thin gray";
            row.style.backgroundColor = "lightblue";
            row.style.fontWeight = "bold";
            col = row.insertCell(0); col.innerHTML = "Day";
            col = row.insertCell(1); col.innerHTML = "Time";
            col = row.insertCell(2); col.innerHTML = "Event";
            col = row.insertCell(3); col.innerHTML = "Location";
            // calculate end month day. 6 for events, 1 for activities.
            var endmmdd;
            if (localStorage.getItem("eventtype") == "events") endmmdd = (month + 6) * 100 + dayofmonth;
            else endmmdd = (month + 1) * 100 + dayofmonth;
            var thisweek = GetWeekofYear(monthday); // this week #

            // roll through the CE array
            for (iCE = 0; iCE < CE.length; iCE++) {
                aCE = CE[iCE].split(';');  // split the string
                if ((EventFilter != "") && (EventFilter != aCE[3])) continue;  // skip entry if it doesnt match
                //  advance schedule date to today
                var dateCE = Number(aCE[0]); // mmdd
                if (dateCE > endmmdd) return; // past one month
                if (dateCE < monthday) continue; // if before today
                if (dateCE == monthday && Number(aCE[2]) < (timehhmm + 10)) continue; // end time not reached.
                // found it
                datefmt = aCE[0].substring(0, 2) + "/" + aCE[0].substring(2, 4);

                var dd = new Date(datefmt + "/" + year); // wont work for next year
                iweek = GetWeekofYear(dateCE);
                idayofweek = GetDayofWeek(dateCE);

                // add a row for new week. won't work if schedule days are both same day of week
                if (iweek != lastweek) {
                    row = table.insertRow(-1);
                    row.style.backgroundColor = "azure";
                    col = row.insertCell(0);
                    // test for this week
                    if (iweek == thisweek) col.innerHTML = "This Week";
                    else col.innerHTML = "";
                    col.colSpan = "4";
                }

                // add a new table row
                row = table.insertRow(-1);
                row.style.border = "thin solid gray";//
                if (dateCE == monthday && Number(aCE[2]) > (timehhmm + 10)) row.style.fontWeight = "bold"; // end time not reached.
                col = row.insertCell(0);
                if (aCE[0] != previouseventdate) col.innerHTML = dayofweekshort[idayofweek] + " " + datefmt; // day of week
                else col.innerHTML = "";
                col = row.insertCell(1);
                col.innerHTML = VeryShortTime(aCE[1]) + "-" + VeryShortTime(aCE[2]); // compressed tim
                var col2 = row.insertCell(2);
                col2.innerHTML = aCE[4];//event
                //col.onclick = function(){tabletext(this);}
                col = row.insertCell(3); col.innerHTML = aCE[5];//where
                var color;
                color = eventcolor(aCE[3]);
                col2.style.color = color;
                col.style.color = color;
                row.id = aCE[0] + aCE[1];
                row.onclick = function () { tabletext (this.id)}
                lastweek = iweek;
                previouseventdate = aCE[0];
            } // end loop through CE
        }


        ///////////////////////////////////////////
        //  tabletext - display all details for the row or item that was clicked. Works for list, week, and month views.
        //  tc = cell id: date (mmdd) time (hhmm) as a string. mmdd9999 to match all times on mmdd. mmddhh99 to match all minutes
        //  The date and time are used to look up the entry in the CE array.
        function tabletext(tc) {
            //alert(tc);
            var d = tc.substr(0, 4);  // mmdd part of id
            var t = tc.substr(4, 8); // hhhmm part of id. could be hh99 or 9999
            var as = "";
            CE = GetEvents().split("\n");
            for (iCE = 0; iCE < CE.length; iCE++) {
                aCE = CE[iCE].split(';');  // split the string
                if (d < aCE[0]) break;
                if (d != aCE[0]) continue;
                var t99 = aCE[1].substr(0, 2) + '99'; // hh99
                if((t == aCE[1]) || (t=='9999') || (t == t99) ) {
                    as += formatDate(aCE[0]) + " " + VeryShortTime(aCE[1]) + "-" + VeryShortTime(aCE[2]) + ": " +
                         aCE[4] + "\nLocation: " + aCE[5] + ", Sponsor: " + aCE[6] + "\n";
                    if (aCE.length >= 8) as += aCE[7] + "\n";
                    as += "\n";
                }

            }
            if (as == "") return;
            alert(as);
        }

        ///////////////////////////////////////////////////////////////////////////////////////////////
        // DisplayComingWeek - display the events in the CE structure in a 1 week form
        // CE = string of events, \n separated.
        function DisplayComingWeek(CE) {

            var i, h;
            var row;
            var col;
            var startmmdd;
            var table // ref to table
            EventDisp = "W";
            table = document.getElementById("comingeventstable");
            var iCE; // iterator through CE
            iCE = 0;
            var aCE; // CE split array 
            var CE;

            if (CE == null) return;
            CE = CE.split("\n");  // break it up into rows

            // build table
            clearTable(table);
            table.deleteRow(-1);

            var mmdd = Bumpmmdd(monthday, -dayofweek);  // reset mmdd to 1st day of week

            // loop for each week
            for (var nw = 0; nw < 2; nw++) {
                startmmdd = mmdd;
                // add a new week header
                row = table.insertRow(-1);
                row.style.border = "solid thin gray";
                row.style.border.width = 1;
                row.style.backgroundColor = "lightblue";
                row.style.fontWeight = "bold";

                var dd = mmdd % 100;
                col = row.insertCell(0); col.innerHTML = ""; col.style.width = "5%"; //
                for (i = 0; i < 7; i++) {
                    col = row.insertCell(-1);
                    col.innerHTML = dayofweekshort[i] + "<br/>" + dd.toFixed(0);
                    col.style.width = "13%"// 
                    mmdd = Bumpmmdd(mmdd, 1); var dd = mmdd % 100;
                }


                // build the week table with all hour rows and day columns, but no events

                for (h = 7; h < 23; h++) {  // for hours 7 - 22
                    row = table.insertRow(-1);
                    //row.style.border = "thin solid blue";
                    col = row.insertCell(0);
                    // time row
                    if (h < 13) col.innerHTML = h + 'am';
                    else col.innerHTML = (h - 12) + 'pm';
                    if (timehh == h) col.style.backgroundColor = "pink";
                    else col.style.backgroundColor = "azure";
                    col.style.border = "thin solid lightblue";
                    mmdd = startmmdd;
                    // add day columns (add  one for each hour row)
                    for (i = 0; i < 7; i++) {
                        col = row.insertCell(-1);
                        var id = Leading4(mmdd) + Leading0(h) + "99";
                        col.id = id;
                        col.onclick = function () { tabletext(this.id) }
                        col.innerHTML = "";
                        if (mmdd == monthday) col.style.backgroundColor = "yellow";  // make today yellow
                        col.style.border = "thin solid lightblue";
                        mmdd = Bumpmmdd(mmdd, 1); var dd = mmdd % 100;
                    }
                }

                // roll through the CE array for 7 days and populate the week table with events from CE
                var endmmdd = mmdd;  // end day + 1
                for (iCE = 0; iCE < CE.length; iCE++) {
                    aCE = CE[iCE].split(';');  // split the string
                    var dateCE = Number(aCE[0]); // mmdd
                    if (dateCE >= endmmdd) break; // past one week
                    if (dateCE < startmmdd) continue; // if before today
                    if ((EventFilter != "") && (EventFilter != aCE[3])) continue;  // skip entry if it doesnt match
                    // add to entry. entries have an id of: mmddhh99
                    var e = "";
                    if (aCE[1].substring(2, 4) != "00") e = ShortTime(aCE[1]) + " "; // add time if not one the hour
                    e += "<span style=color:" + eventcolor(aCE[3]) + ">" + aCE[4] + "</span>";
                    var id = aCE[0] + aCE[1].substring(0, 2) + "99";
                    var c = document.getElementById(id);
                    c.innerHTML += e + "<br/>";
                } // end for 1 week

            }  // end for 2 weeks
            return;
        } // end function

        function Leading4(n) {
            var s = n.toFixed();
            if (s.len == 4) return s;
            else return "0" + s;

        }

        ///////////////////////////////////////////////////////////////////////////////////////////////
        // DisplayComingMonth - display the events in the CE structure in a 1 month form
        // CE = string of events, \n separated.
        function DisplayComingMonth(CE) {
            var i, w;
            var row;
            var col;
            var table // ref to table
            EventDisp = "M";
            table = document.getElementById("comingeventstable");
            var iCE; // iterator through CE
            iCE = 0;
            var aCE; // CE split array 
            var CE;

            if (CE == null) return;
            CE = CE.split("\n");  // break it up into rows

            var startmmdd = Bumpmmdd(monthday, -dayofweek); // back up to beginning of month
            //if (year % 4 == 0) daysinmonth[2] = 29; // leap year
            // compute starting date
            //var dd = dayofmonth - dayofweek; // starting dayy of the month
            //var mm = month;
            //if (dd <= 0) { mm--; dd = daysinmonth[mm] + dd; } // if we had to back of
            //var startmmdd = mm * 100 + dd;
            var mmdd = startmmdd;

            // build table
            clearTable(table);
            table.deleteRow(-1);
            // add a new week header
            row = table.insertRow(-1);
            row.style.border = "solid thin gray";
            row.style.border.width = 1;
            row.style.backgroundColor = "lightblue";
            row.style.fontWeight = "bold";
            col = row.insertCell(0); col.innerHTML = "Sun"; col.style.width = "14%"// 
            col = row.insertCell(1); col.innerHTML = "Mon"; col.style.width = "14%"  // 
            col = row.insertCell(2); col.innerHTML = "Tue"; col.style.width = "14%" // 
            col = row.insertCell(3); col.innerHTML = "Wed"; col.style.width = "14%"//
            col = row.insertCell(4); col.innerHTML = "Thur"; col.style.width = "14%"//
            col = row.insertCell(5); col.innerHTML = "Fri"; col.style.width = "14%"
            col = row.insertCell(6); col.innerHTML = "Sat"; col.style.width = "14%"
            ;

            // build the month table with all rows and columns. Each day has an id of 'mmdd9999'.
            for (w = 1; w < 12; w++) {
                var rowN = table.insertRow(-1);
                row = table.insertRow(-1);
                //row.style.border = "thin solid blue";
                // day rows with date
                for (i = 0; i < 7; i++) {
                    // cell with date
                    col = rowN.insertCell(i);

                    if (Math.floor(mmdd / 100) != month) col.innerHTML = formatDate(mmdd);
                    else col.innerHTML = (mmdd % 100).toFixed(0);
                    col.style.color = "darkblue";
                    if (mmdd == monthday) col.style.backgroundColor = "yellow";
                    else col.style.backgroundColor = "azure";
                    col.style.border = "thin solid lightblue";
                    // cell that will hold the events
                    col = row.insertCell(i);
                    col.innerHTML = "&nbsp";
                    col.style.border = "thin solid lightblue";
                    col.id = Leading4(mmdd) + '9999';
                    col.onclick = function () { tabletext(this.id) }
                    if (mmdd == monthday) col.style.backgroundColor = "lightyellow";  // make today yellow
                    mmdd = Bumpmmdd(mmdd, 1); // quick bump of mmdd//
                }
            }

            var endmmdd = mmdd;
            // roll through the CE array for the month days
            for (iCE = 0; iCE < CE.length; iCE++) {
                aCE = CE[iCE].split(';');  // split the string
                //  advance schedule date to today
                var dateCE = Number(aCE[0]); // mmdd
                if (dateCE > endmmdd) break; // past end of mothb
                if (dateCE < startmmdd) continue; // if before start of month
                if ((EventFilter != "") && (EventFilter != aCE[3])) continue;  // skip entry if it doesnt match

                // add to entry
                var e;
                e = "<span style=color:" + eventcolor(aCE[3]) + "><strong>" + VeryShortTime(aCE[1]) + "</strong> " +
                      aCE[4] + "</span>";// add time 
                var id = aCE[0] + "9999";
                var c = document.getElementById(id);
                c.innerHTML += e + "<br/>";
            } // end for
        } // end function

        // eventcolor - return the color for an event, based on the key (M, S, E)
        function eventcolor(key) {
            switch (key) {
                case "E": return "#0000ff"; break; // special events
                case "S": return "darkred"; break; // entertainment
                default: return "#000000";
            }
        }

        ///////////////////////////////////////////////////////////////////////////
        //  Bumpmmdd  add days to mmdd and adjust mm and dd
        //  entry   mmdd = original mmdd
        //          n = days to add or subtract, up to one month
        //  exit    returns new mmdd
        function Bumpmmdd(mmdd, n) {
            if (n == 0) return mmdd;
            var mm = Math.floor(mmdd / 100);
            var dd = mmdd % 100;
            dd = dd + n;
            if (dd > 0) {  // increasing to next month
                if (dd <= daysinmonth[mm]) return mmdd + n;
                else return (mm + 1) * 100 + dd - daysinmonth[mm];
            }
            // handle subtract which rolls the month backward
            mm = mm - 1; if (mm == 0) mm = 12;
            return (mm * 100) + daysinmonth[mm] - dd;
        }

    </script>

    <!-- TIDES ------------------------>
    <script>
        //===== TIDES =======================================================================================
        var usertideselection = false; // true when user sets tides
        //////////////////////////////////////////////////////////////////////////////////////////////////
        // TidesDataPage
        function TidesDataPage() {
            InitializeDates(0);
            ShowPage("tidespage");
            // show the tide data in the jsontides global
            usertideselection = false;
            var periods = JSON.parse(localStorage.getItem("jsontides"));
            var i = ShowTideDataPage(periods, true);
            GraphTideData(periods[i - 1].heightFT, periods[i].heightFT, periods[i+1].heightFT, 
                periods[i-1].dateTimeISO, periods[i].dateTimeISO, periods[i+1].dateTimeISO, true);
        }

        ////////////////////////////////////////////////////////////////////////////////////////////////////////////
        // ShowTideData - show the data in the periods array
        //  entry periods = array of data returned by aeris. Each array entry is one tide period.
        //        showcurrent = true to show current tides, else false
        //  exit  returns periods index of NEXT tide
        //        fills the tidestable
        //        sets tidepagecurrent to current tide
        function ShowTideDataPage(periods, showcurrent) {

            var table = document.getElementById("tidestable");
            tabletoclear = "tidestable";
            clearTable(table);
            olddate = periods[0].dateTimeISO.substring(5, 10);
            var oldtide = -1;
            var i;
            var nexttidei;
            var currentTide;

            // roll through the reply in jason.response.periods[i]
            for (i = 0; i < periods.length; i++) {
                // if date changed, add a blank row
                newdate = periods[i].dateTimeISO.substring(5, 10);
                if (newdate != olddate) {
                    var row1; row1 = table.insertRow(-1);
                    var row1col1; row1.insertCell(0).innerHTML = " ";
                    row1.insertCell(1).innerHTML = " ";
                    row1.insertCell(2).innerHTML = " ";
                    row1.insertCell(3).innerHTML = " ";
                    olddate = newdate;
                }
                // Insert New Row for table at end of table.

                var row1 = table.insertRow(-1);

                // Insert New Column for date
                var row1col1 = row1.insertCell(0);
                var m = Number(periods[i].dateTimeISO.substring(5, 7));
                var d = Number(periods[i].dateTimeISO.substring(8, 10));
                row1col1.innerHTML = dayofweekshort[GetDayofWeek(m * 100 + d)] + " " + m + "/" + d + '&nbsp';
                row1col1.style.border = "thin solid gray";
                // time
                row1col1 = row1.insertCell(1);
                var h = Number(periods[i].dateTimeISO.substring(11, 13)); // tide hour
                var mi = Number(periods[i].dateTimeISO.substring(14, 16));  // time min
                tidehhmm = (Number(h) * 100) + Number(mi);
                row1col1.innerHTML = "&nbsp" + ShortTime(tidehhmm);
                row1col1.style.border = "thin solid gray";
                if (periods[i].type == 'h') {
                    hilow = 'HIGH';
                    row1.style.background = "azure";
                } else {
                    hilow = 'Low';
                    row1.style.background = "lightyellow";
                }
                // if tide is past, color row gray and show current tide info
                if (showcurrent) {
                    if ((month > m) || (month == m && dayofmonth > d) || (month == m && dayofmonth == d && (timehhmm > tidehhmm))) {
                        row1.style.color = "gray";
                        //currentTide = "<span style='font-size:16px;font-weight:bold;color:blue'>";
                        if (periods[i].type == 'h') currentTide = "Outgoing since: ";  // incoming outgoing flag
                        else currentTide = "Incoming since: ";
                        currentTide += ShortTime(tidehhmm) + " (for " + timeDiff(tidehhmm, timehhmm) + ")";
                        oldtideheight = Number(periods[i].heightFT);
                        oldtidetime = tidehhmm;
                        oldtide = 0;
                    } else if ((oldtide < 1)) {

                        // this is the next tide, bold it and calculate approx height                             
                        row1.style.fontWeight = "bold";
                        oldtide = 1;
                        nexttidei = i;
                        // calculate current tide height
                        if (showcurrent) {
                            var tideheight = CalculateCurrentTideHeight(tidehhmm, oldtidetime, Number(periods[i].heightFT), oldtideheight);
                            currentTide = "<span style='font-size:16px;font-weight:bold;color:blue'>" +
                                "Now: " + tideheight.toFixed(1) + " ft. &nbsp Date:" + formatDate(monthday) +
                                "<span style='color:darkgray' onclick='ShowCustom()'>&nbsp&nbsp&nbsp [ Change Date... ]</span><br/>" + currentTide;
                            // calculate time till next tide                                 
                            currentTide += "<br/>" + hilow + " tide: " + periods[i].heightFT + " ft. at " + ShortTime(tidehhmm) + " (in " + timeDiff(timehhmm, tidehhmm) + ")";
                            nextTides = "Tides: " + hilow + " " + periods[i].heightFT + " ft. at " + ShortTime(tidehhmm) + ";";
                        }
                    } else if (oldtide == 1) {  // save next tide
                        oldtide = 2;
                        if (showcurrent) {
                            nextTides += hilow + " " + periods[i].heightFT + " ft. at " + ShortTime(tidehhmm) + ";";
                            localStorage.setItem("nextTides", nextTides); // save tide
                        }
                    }
                }

                // type
                row1col1 = row1.insertCell(2);
                row1col1.innerHTML = hilow;
                row1col1.style.border = "thin solid gray";
                // height
                row1col1 = row1.insertCell(3);
                row1col1.innerHTML = periods[i].heightFT;
                row1col1.style.border = "thin solid gray";
                //// range ()
                if (i < periods.length-1) {
                    row1col1 = row1.insertCell(-1);
                    row1col1.innerHTML = "<span style='color:#bfbfbf'>" + Math.abs(periods[i].heightFT - periods[i + 1].heightFT).toFixed(1) + "</span>";
                    row1col1.style.border = "thin solid gray";
                }
            }
            // now save the current tide
            if (!showcurrent) currentTide = "<span style='font-size:16px;font-weight:bold;color:blue'> Date:" +
                periods[0].dateTimeISO.substring(5, 7) + "/" + periods[0].dateTimeISO.substring(8, 10) +
                "<span style='color:darkgray' onclick='ShowCustom()'>&nbsp&nbsp&nbsp [ Change Date ]";
            document.getElementById("tidepagecurrent").innerHTML = currentTide + "</span>";
            $("#tideButton").show();

            return nexttidei; // return index
        }

        /////////////////////////////////////////////////////////////////////////
        //  GraphTideData
        //  Entry: tide1t, tide2t, tide3t = 3 tide points in feet, text (HLH or LHL)
        //         t1, t2, t3 = corresponding times in dateTimeISO text format: 2016-05-15T19:55:00-07:00
        //         NOTE: current tide must be between t1 and t2
        function GraphTideData(tide1t, tide2t, tide3t, t1t, t2t, t3t, showtoday) {
            var canvas = document.getElementById("tidecanvas");
            var axes = {}, ctx = canvas.getContext("2d");
            var w = canvas.width; var h = canvas.height;
            ctx.textAlign = "start";

            // convert tides to numbers
            tide1 = Number(tide1t); tide2 = Number(tide2t); tide3 = Number(tide3t);
            var LB = tide1; if (tide2 < LB) LB = tide2; if (tide3 < LB) LB = tide3; LB = Math.floor(LB - .9); // lower bound
            var UB = tide1; if (tide2 > UB) UB = tide2; if (tide3 > UB) UB = tide3; UB = Math.floor(UB + 1.99); // upper bound
            var pixelsfoot = h / (UB - LB);  // pixels per foot

            // convert time to numbers as fp hours from 0 to 48.
            var t1hhmm = Number(t1t.substring(11, 13)) * 100 + Number(t1t.substring(14, 16));
            var t2hhmm = Number(t2t.substring(11, 13)) * 100 + Number(t2t.substring(14, 16));
            var t1 = tHours(t1t); var t2 = tHours(t2t); var t3 = tHours(t3t);
            if (t2 < t1) t2 += 24; if (t3 < t2) t3 += 24;
            var tLB = Math.floor(t1-1); // time lower bound
            var tUB = Math.floor(t3 + .99); // time upper bound

            var pixelshour = w / (tUB - tLB);
            var x0 = 0; // x offset to 0

            // draw background
            ctx.fillStyle = "#A0D2FF";
            ctx.fillRect(0, 0, w, h);
            // do sunnrise lighter
            var sunrisefp = datesunrise.getHours() + datesunrise.getMinutes() / 60; // convert to floating pt
            var sunsetfp = datesunset.getHours() + datesunset.getMinutes() / 60;
            // from 0 to 24
            ctx.fillStyle = "#B0E2FF"; //"#B8EAFF"; //"#C0F2FF";  // snrise times
            if (sunrisefp <= tLB) ctx.fillRect(0, 0, (sunsetfp - tLB) * pixelshour, h);
            else ctx.fillRect((sunrisefp - tLB) * pixelshour, 0, (sunsetfp - tLB) * pixelshour, h);
            // from 24 to 48
            ctx.fillRect((sunrisefp - tLB+24) * pixelshour, 0, (sunsetfp - tLB+24) * pixelshour, h);

            // draw y axis (tide feet)
            ctx.beginPath();
            ctx.strokeStyle = "rgb(128,128,128)";
            ctx.moveTo(x0, 0); ctx.lineTo(x0, h);  // Y axis
            ctx.stroke();

            // draw tide grid lines
            ctx.strokeStyle = "#ffffff";
            // label x axis. skip bottom number because the time is shown there.
            var y = h - pixelsfoot;
            ctx.font = "12px Arial";
            ctx.fillStyle = "#0000ff";
            for (i = LB+1; i <= UB; i++) {
                ctx.beginPath();
                ctx.moveTo(x0, y); ctx.lineTo(w, y);
                ctx.stroke();
                ctx.fillText(i + " ft", x0, y);
                y -= pixelsfoot;  // bump to next one
            }

            // Draw x axis (time)
            var y0 = h;
            ctx.strokeStyle = "rgb(128,128,128)";
            ctx.fillStyle = "#000000";
            ctx.beginPath();
            ctx.moveTo(x0, y0); ctx.lineTo(w, y0);  // Y axis
            ctx.stroke();
            var x = pixelshour; var hr;
            ctx.strokeStyle = "#ffffff";
            // label the time
            for (i = tLB + 1; i < tUB; i++) {
                hr = VeryShortTime(i < 24 ? i * 100 : (i - 24) * 100).substr(0, 2);
                if (hr == "no") hr = "12";
                // draw verticals for time every 4 hours
                if ((i % 4) == 0) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, h);
                    ctx.stroke();
                }
                ctx.fillText(hr, x-8, h-3);
                x += pixelshour;  // bump to next one
            }

            // draw the 2 sine waves
            DrawCurve(ctx, tide1, tide2, t1, t2, pixelsfoot, pixelshour, h, tLB, LB);
            DrawCurve(ctx, tide2, tide3, t2, t3, pixelsfoot, pixelshour, h, tLB, LB);
            DrawCurve(ctx, tide3, tide2, t3, t3 + 6, pixelsfoot, pixelshour, h, tLB, LB); // fill out last hour with made up tide

            // draw vertical for t2 which is next high/low
            ctx.lineWidth = 1;
            ctx.strokeStyle = "#A0A0A0";
            ctx.beginPath();
            x = (t2 - tLB) * pixelshour;
            ctx.moveTo(x, h-(tide2-LB)*pixelsfoot); ctx.lineTo(x, h);
            ctx.stroke();

            // draw vertical now for current time
            if (showtoday) {
                ctx.strokeStyle = "#ff0000";
                var now = (timehh + timemm / 60);
                if (now < tLB) now += 24;
                now = (now - tLB) * pixelshour;
                ctx.beginPath();
                ctx.moveTo(now, 14); ctx.lineTo(now, h);
                ctx.stroke();
                // calculate and display current value
                var up = "\u2191"; if (tide2 < tide1) up = "\u2193";  // up down arrow
                tide = CalculateCurrentTideHeight(t2hhmm, t1hhmm, tide2, tide1);
                ctx.fillStyle = "#ff0000";
                ctx.font = "16px Arial";
                ctx.fillText("@ " + tide.toFixed(1) + " ft " + up, now - pixelshour, 14);
            }

            // label the date using the date for tide2 
            //var mmdd = monthday;
            //if (tUB > 25) mmdd = Bumpmmdd(mmdd, 1);  // if we roll to the next day
            ctx.fillStyle = "#0000ff";
            ctx.fillText(t2t.substring(5,7) + "/" + t2t.substring(8,10), w*0.7, 14);
        }

        /////////////////////////////////////////////////////////////////////////////////////
        // DrawCurve - draw 1/2 a sine wave for tide1@t1 to tide2@t2
        //  Entry: ctx = draw context;
        //          tide1, tide2 = tide height in fp feet
        //          t1, t2 = times in fp hours (0 - 48)
        //          pixelsfoot, pixelshour = pixel scale
        //          h = height in pixels, tLB = time lower bound in hours
        function DrawCurve(ctx, tide1, tide2, t1, t2, pixelsfoot, pixelshour, h, tLB, tideLB){
            ctx.beginPath();
            //ctx.lineWidth = thick;
            var mtide = (tide1 + tide2) / 2; // mid
            var dtide = Math.abs(tide2 - tide1) / 2; // delta
            var dtide = (tide2 - tide1) / 2; // delta
            var dt = t2 - t1;
            var tide = tide1;
            var t = t1;
            var xscale = pixelshour; var yscale = pixelsfoot;
            ctx.strokeStyle = "rgb(0, 0, 255)";
            ctx.lineWidth = 2;
            ctx.moveTo(xscale * (t - tLB), h - yscale * (tide - tideLB));
            // loop througth time from t1 to t2 by .25 hour (15 min)
            for (t = t1; t < (t2 + .25) ; t = t + .25) {
                if (t > t2) t = t2;
                var c = (t - t1) / dt * Math.PI;
                /////if (tide2 > tide1) c = Math.cos(Math.PI - c);
                /////else c = Math.cos(c);
                c = Math.cos(Math.PI - c);
                //if (tide2 < tide1) c = c * -1;
                tide = mtide + dtide * c;
                ctx.lineTo(xscale * (t - tLB), h - yscale * (tide-tideLB));
            }
            ctx.stroke();
        }

        // tHours: convert ISO datetime to floating point hours
        function tHours(tISO) {
            return Number(tISO.substring(11, 13)) + Number(tISO.substring(14, 16)) / 60;
        }

        
        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        // ShowCustom - get date for custom tides, call the aeris query, and display the result.
        //
        function ShowCustom() {
            InitializeDates(0);
            tidedate = GetDateFromUser();
            if (tidedate == "") return;
            usertideselection = true;
            getCustomTideData(tidedate);

        }

        ///////////////////////////////////////////////////////////////////
        // GetDateFromUser - asks user for date and returns as mm/dd/yy
        //  return mm/dd/yy or ""
        function GetDateFromUser() {
            var tidedate = prompt("Please enter the date as mm/dd or mm/dd/yyyy", month + "/" + dayofmonth);
            if (tidedate == null) return "";
            // validate the date
            var tda = tidedate.split("/");
            if (tda.length != 2 && tda.length != 3) {
                alert("Invalid date. An example of a valid date is: 1/22");
                return "";
            }
            var m = Number(tda[0]); // month
            var d = Number(tda[1]);  // day
            if (isNaN(m) || isNaN(d) || (m < 1) || (m > 12) || (d < 1) || (d > 31)) {
                alert("Invalid date. An example of a valid date is: 1/22");
                return;
            }
            if (tda.length == 3) return tidedate;
            else return tidedate + "/" + year;
        }

        /////////////////////////////////////////////////////////////////////////////////////////////
        // getCustomTideData get tide data using the aeris api and returning a jsonp structure. This is the only way to get data from a different web site.
        // used only for custom date queries, not for normal tides.
        // License as of 2/8/16 is for 750 hits/day for free.
        //  fromdate = optional starting date for the tides
        //  data is used to display tide data. It is not stored.
        function getCustomTideData(fromdate) {
            var olddate, newdate; // dates
            var ampm; // am or pm
            var oldtide = -1; // true for tides older than current time
            var oldtideheight, oldtidetime; // saved tide hight for last tide
            var hilow;
            var nextTides;
            $("#tideButton").hide();  // hide the user button
            $.ajax({
                url: 'http://api.aerisapi.com/tides/9446705?client_id=U7kp3Zwthe8dc19cZkFUz&client_secret=4fHoJYS6m9T7SERu7kkp7iVwE0dewJo5zVF38tfW&from=' + fromdate + '&to=+48hours',
                dataType: 'jsonp',
                success: function (json) {

                    if (json.success == true) {
                        ShowTideDataPage(json.response.periods, false);
                        GraphTideData(json.response.periods[1].heightFT, json.response.periods[2].heightFT, json.response.periods[3].heightFT,
    json.response.periods[1].dateTimeISO, json.response.periods[2].dateTimeISO, json.response.periods[3].dateTimeISO, false);
                    }
                    else {
                        document.getElementById("tidepagecurrent").innerHTML = "Tides not available." + json.error.description;
                        //alert('Could not retrieve tide information: ' + json.error.description);
                    }
                }
            });
        }
        /////////////////////////////////////////////////////////////////////////////////////
        // ShowNOAA - query NOAA for the tide page
        function ShowNOAA() {
            InitializeDates(0);
            window.open("http://opendap.co-ops.nos.noaa.gov/axis/webservices/highlowtidepred/response.jsp?stationId=9446705&beginDate=" + year + month + dayofmonth + "&endDate=" + year + month + dayofmonth + "&datum=MLLW&unit=0& =0&format=html&Submit=Submit", "_blank");
        }

     </script>

    <!-- EMERGENCY -------------------->
    <script>
        //====EMERGENCY=====================================================================================

        //////////////////////////////////////////////////////////////////////////////////////
        // ShowEmergency
        function ShowEmergencyPage() {
            ShowPage("emergencypage");
            document.getElementById("emergencytable").innerHTML = localStorage.getItem("emergency");
        }
    </script>

    <!-- WEATHER ---------------------->
    <script>
        //====WEATHER=====================================================================================
        // Weather
        function ShowWeatherPage() {
            ShowPage("weatherpage");
            InitializeDates(0);
            document.getElementById("currentweatherpage").innerHTML = localStorage.getItem("currentweatherlong");
            getWeatherForecastPage("today");
        }
        
        /////////////////////////////////////////////////////////////////////////////////////////////
        // get weather data using the OpenWeatherMap api and returning a jsonp structure. This is the only way to get data from a different web site.
        // License as of 2/25/16 is for 60 hits/minute for free.
        //  fromdate = optional starting date for the weather
        //  Note: json data is cached in 'forecastjson', and time stamped in 'forecastjsontime'.
        //      cached data is always used. A new request is allowed only after 12 minutes.
        function getWeatherForecastPage(fromdate) {
            var olddate, newdate; // dates
            var ampm; // am or pm
            var currentTemp;
            generateWeatherForecastPage(); // display page from cache
            if (localStorage.getItem("forecastjsontime") != null) {
                var td = RawTimeDiff(localStorage.getItem("forecastjsontime"), timehhmm); // age of forecast in min
                if (td < 12) return; // don't update more than every 12 minutes
            }

            //update the forecast from ajax. 

            $.ajax({
                url: 'http://api.openweathermap.org/data/2.5/forecast?id=5812092&units=imperial&APPID=f0047017839b75ed3d166440bef52bb0',
                dataType: 'jsonp',
                success: function (json) {
                    // save the data
                    localStorage.setItem("forecastjson", JSON.stringify(json));
                    localStorage.setItem("forecastjsontime", timehhmm);
                    generateWeatherForecastPage();
                }
            });  // end of ajax call
        }  // end of function

        function generateWeatherForecastPage() {
            if (localStorage.getItem("forecastjson") == null) return;
            var json = JSON.parse(localStorage.getItem("forecastjson")); // retrieve saved data and turn it into an object again
            if (json == null) return;
            //var r = json.list[0];
            //var forecast = "Forecast: " + StripDecimal(r.main.temp_max) + "&deg/" + StripDecimal(r.main.temp_min) + "&deg, " +
            //   r.weather[0].description + ", " + DegToCompassPoints(r.wind.deg) + " " + StripDecimal(r.wind.speed) + " mph ";
            var resp = json.list;
            var mydayofweek = dayofweek;
            var firstrow = true;  // true for first row
            var olddate = "";
            var row1;
            // roll through the reply in jason.list[i]
            var table = document.getElementById("forecasttable");
            // don't clear the table so it is there in case we don't have network coverage for a new forecast
            clearTable(table);
            var fdate = new Date();
            for (var i = 0; i < resp.length; i++) {
                // if date changed, add a blank row
                var r = resp[i];
                //var row1 = table.insertRow(-1);
                //var t = r.dt_txt.substring(11, 13) * 100;  // hh00
                var timef = Number(r.dt);// unix gmt time in sec since 1970

                fdate.setTime(timef * 1000);// force UTC
                newdate = fdate.getDate(); //dd
                var t = fdate.getHours() * 100 + fdate.getMinutes(); //hhmm

                // Insert New Row for table for new day 

                //var newdate = r.dt_txt.substring(5, 11);// date
                if (newdate != olddate) {
                    row1 = table.insertRow(-1); // dummy row
                    var row1col1 = row1.insertCell(0);
                    row1col1.colSpan = "6";
                    //row1.insertCell(1); row1.insertCell(2); row1.insertCell(3); row1.insertCell(4);
                    var dow = fdate.getDay();;
                    row1col1.innerHTML = dayofweekshort[dow] + " " + (fdate.getMonth()+1) + "/" + newdate;
                    olddate = newdate;
                }
                var row1 = table.insertRow(-1);
                if ((t < 600) || (t > 1800)) row1.style.backgroundColor = "lightgray";
                else row1.style.backgroundColor = "lightyellow";

                // Insert New Column for time
                var row1col1 = row1.insertCell(0);
                row1col1.innerHTML = "&nbsp&nbsp&nbsp" + VeryShortTime(t);  // time
                firstrow = false;
                row1col1.style.border = "thin solid gray";
                // high/low
                row1col1 = row1.insertCell(-1);
                row1col1.innerHTML = StripDecimal(r.main.temp_max) + "&deg";
                row1col1.style.border = "thin solid gray";
                // icon
                var icon = r.weather[0].icon.substr(0, 2);
                if ((t < 600) || (t > 1800)) icon += 'n';
                else icon += 'd';
                icon = "<img src='img/" + icon + ".png' width=30 height=30>";
                // weather
                row1col1 = row1.insertCell(-1);
                row1col1.innerHTML = icon + "&nbsp " + r.weather[0].description;
                row1col1.style.border = "thin solid gray";
                // rain
                row1col1 = row1.insertCell(-1);
                var rain;
                if (typeof r.rain == 'undefined' || typeof r.rain["3h"] == 'undefined') rain = "0";
                else rain = (Number(r.rain["3h"]) / 25.4).toFixed(2);
                row1col1.innerHTML = rain;
                row1col1.style.border = "thin solid gray";
                // wind
                row1col1 = row1.insertCell(-1);
                row1col1.innerHTML = DegToCompassPoints(r.wind.deg) + " " + StripDecimal(r.wind.speed);
                row1col1.style.border = "thin solid gray";
            }  // for end

            document.getElementById("forecastpage").innerHTML = "Data from " + FormatTime(localStorage.getItem("forecastjsontime"));
        }




    </script>

    <!-- ABOUT ------------------------>
    <script>
        //====ABOUT=========================================================================================

        // FERRY WEB CAM
        function ShowFerryWebCam() {
            ShowPage("ferrywebcampage");
            document.getElementById("steilacoomcam").setAttribute("src", "http://online.co.pierce.wa.us/xml/abtus/ourorg/PWU/Ferry/Steilacoom.jpg?random" + timehhmm.toFixed(0));
            document.getElementById("aicam").setAttribute("src", "http://online.co.pierce.wa.us/xml/abtus/ourorg/PWU/Ferry/AndersonIsland.jpg?random" + timehhmm.toFixed(0));
        }

        //====ABOUT=========================================================================================
        /////////////////////////////////////////////////////////////////////////////////////
        // About
        function ShowAboutPage() {
            ShowPage("aboutpage");
            if (isPhoneGap()) document.getElementById("phoneweb").innerHTML = "Phone version.";
            DisplayLoadTimes();
        }

        //====LINKS=========================================================================================
        /////////////////////////////////////////////////////////////////////////////////////
        // About
        function ShowLinksPage() {
            ShowPage("linkspage");
        }
    </script>

    <!-- MAIN ---------------------------------->
    <script type="text/javascript">
        //======================================================================================================
        /////////////////////////////////////////////////////////////////////////////////////////////////
        //  MAIN APP CODE
        //
        var cacheReloadEvery = 720; // minutes

        app.initialize();
		//alert("started");
        DisplayPage = "mainpage";
        InitializeDates(0);
        if (year % 4 == 0) daysinmonth[2] = 29; // leap year
        datesunrise = new Date(Number(localStorage.getItem("sunrise"))); // reload sunrise and sunset
        datesunset = new Date(Number(localStorage.getItem("sunset"))); // reload sunrise and sunset
        AppStartedTime = timestampms;
        AppStartedDate = monthday * 10000 + timehhmm;
        LastUpdatems = timestampms;
        document.getElementById("updatetime").innerHTML = "Updated " + FormatTime(timehhmm);
        forceCacheReload = false; // cache reload not needed
        forceTideReload = false;


        // point user to google play only if a mobile browser that is NOT PhoneGap
        if (!isPhoneGap() && isMobile()) {  // if not phonegap
            if (isAndroid()) { // if chrome for android
                //document.getElementById("androidapp").setAttribute('style', 'display:block;');
                //document.getElementById("topline").innerHTML = "";
            } else {
                document.getElementById("iphoneapp").setAttribute('style', 'display:block;');
                document.getElementById("topline").innerHTML = "";				
			}
        }

		//  pushbots - set the notify switch. hide it for web.
        if (isPhoneGap()) {
		    if (localStorage.getItem("notifyoff") == null) NotifyColor(1);// set that notify on/off flag
		    else NotifyColor(0);
        } else document.getElementById("notifyswitch").setAttribute('style', 'display:none;');

        //  Show the cached data immediately. 
        ParseFerryTimes();  // moved saved data into ferry time arrays
        ParseOpenHours();

        ShowCachedData();

        //reload the 'dailycache' cache + coming events + tides + forecast if the day has changed or > 3 hour.
        getCurrentWeather(); // gets weather async every 20 min.
        getForecast(); // updates forecast every 2 hrs
        getAlertInfo(); // always get alert info every 12 minutes (time check is in routine)

        var reloadreason = "";
        var dailycacheloaded = localStorage.getItem("dailycacheloaded");
        if (dailycacheloaded == null) {
            forceCacheReload = true;
            reloadreason = "initial cache load";
        } else if (Number(dailycacheloaded) != monthday) {
            reloadreason = "dailycacheloaded != monthday";
            forceCacheReload = true;
        }
        if (forceCacheReload) {
            document.getElementById("reloadreason").innerHTML = reloadreason;
            ReloadCachedData();
        }

        // tide reload every day
        getTideData();


        // set refresh timners
        mytimer = setInterval("timerUp()", 60000);  // timeout in milliseconds. currently 60 seconds
        window.addEventListener("focus", focusEvent);
        window.addEventListener("blur", blurEvent);
        document.addEventListener("backbutton", backKeyDown, true);
		document.addEventListener("pause", onPause, false);
		document.addEventListener("resume", onResume, false);
		DisplayLoadTimes();


    </script>
</body>
</html>

