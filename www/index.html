<!DOCTYPE html>
<!--
    Anderson Island Assistant.  Single page version.
    Robert Bedoll. 2/23/16.   (indexMultipage is the old version with multiple HTML pages).

    Copyright (c) 2016 Robert Bedoll.

    Copyright (c) 2012-2014 Adobe Systems Incorporated. All rights reserved.

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=medium-dpi" /> <!--device-dpi" />-->
<link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <title>Anderson Island Assistant</title>
    <style>
        button {
            font-size: 14px;
            text-align:left;
        }

        p {
            font-size: 14px;
        }
        tr {border-style:solid;border-width:thin;border-color:gray;padding-top:6px;padding-bottom:6px;}
        td {padding-top:6px;padding-bottom:6px;}
        li {border-style:solid;border-width:thin;border-color:gray;padding-top:6px;padding-bottom:6px;padding-left:6px}
    </style>


</head>
<body>
    <div class="app">
        <div id="mainpage" style="display:block">
        <div data-role="content"></div>
        <h1 style="font-size:18px;margin-bottom:0px;background-color:blue;color:white;">Anderson Island Assistant </h1>
        <span id="topline" style="font-size:small;padding-top:-4px;margin-bottom:0px">Tap an entry for more information.</span>
        <!--<p>All sorts of usefull information in an up-to-date easy-to-use app.</p>-->
 <table style="border-collapse:collapse";>
        <tr style="background-color:azure;" onclick="DisplayFerrySchedulePage();" >
            <td style="font-size:18px;font-weight:bold;color:darkblue;margin-left:0%">FERRY </td>
            <td id="ferrytimes" style="font-size:small;margin-top:4px;margin-bottom:4px;">Next : </td>
        </tr>

        <tr style="background-color:azure" onclick="ShowFerryWebCam();" >
            <td style="font-size:18px;font-weight:bold;color:darkblue;margin-left:0%" colspan="2">WEBCAMS </td>
        </tr>

         <tr style="background-color:lightcyan"  onclick="TidesDataPage();"> 
            <td id="tidestitle" style="font-size:18px;font-weight:bold;color:darkblue;margin-left:0%">
            TIDES </td>
            <td id="tides" style="font-size:small;margin-top:2px;margin-bottom:4px">Next tides:</td>
         </tr>

        <tr style="background-color:honeydew"  onclick="ShowWeatherPage();"> 
            <td style="font-size:18px;font-weight:bold;color:darkgreen;margin-left:0%">
            WEATHER </td>
            <td style="font-size:small;margin-top:4px;margin-bottom:0px">
                <span id="weather" >Current weather:</span><br />
                <span id="forecast" style="font-size:small;margin-top:4px;margin-bottom:0px">Forecast: </span>
            </td> 

         </tr>


        <tr style="background-color:lightyellow"  onclick="ShowBurnBan();"> 
            <td style="font-size:18px;font-weight:bold;color:#ff3300;margin-left:0%">
            BURNBAN </td>
            <td id="burnban" style="font-size:small;margin-top:2px;margin-bottom:4px">Tap for burn ban status.</td>
         </tr>

        <tr style="background-color:floralwhite;"  onclick="DisplayComingEventsPage('events');">
            <td style="font-size:18px;font-weight:bold;color:darkmagenta;">
            EVENTS </td>
            <td id="nextevent" style="font-size:small;margin-top:4px;margin-bottom:4px">Next Event:</td>
        </tr>
        <tr style="background-color:floralwhite;"  onclick="DisplayComingEventsPage('activity');">
            <td style="font-size:18px;font-weight:bold;color:darkmagenta;">
            ACTIVITY </td>
            <td id="nextactivity" style="font-size:small;margin-top:4px;margin-bottom:4px">Next Activity:</td>
        </tr>

     <tr style="background-color:#f0f0f5" onclick="ShowOpenHoursPage();">
            <td style="font-size:18px;font-weight:bold;color:black;">OPEN<br /> HOURS</td>
             <td id="openhours" style="font-size:small;margin-top:4px;margin-bottom:4px">
            </td>
         </tr>
                
         <tr style="background-color:#cce4ff" onclick="ShowMap();"> 
            <td style="font-size:18px;font-weight:bold;color:darkblue;margin-left:0%" colspan="2">
            MAP </td>  
         </tr>

        <tr style="background-color:antiquewhite;" onclick="window.open('http://www.tannerelectric.coop/andersonisland')">  
            <td style="font-size:18px;font-weight:bold;color:#802b00">TANNER</td>
            <td id="tanneroutages" style="font-size:small;margin-top:2px;margin-bottom:4px">Tap for outage status.</td>

        </tr>
         <tr style="background-color:antiquewhite;" onclick="ShowEmergencyPage();">  
            <td style="font-size:18px;font-weight:bold;color:darkred" colspan="2">
             EMERGENCY CONTACTS</td>
         </tr>
          
         <tr style="background-color:lightgray;" onclick="ShowLinksPage();">
             <td style="font-size:18px;font-weight:bold;margin-left:0%" colspan="2">ISLAND INFORMATION LINKS
             </td>            
            </tr>

             <tr><td style="font-size:18px;font-weight:bold;color:gray" colspan="2" onclick="ReloadCachedData();">Reload Data</td></tr>
            <tr> <td style="font-size:18px;font-weight:bold;color:gray" colspan="2" onclick="ShowAboutPage();">About</td></tr>
            <tr> <td style="font-size:18px;font-weight:bold;color:gray" colspan="2" onclick="window.open('http://www.anderson-island.org/?new','_parent');">Update App</td></tr>
            <tr> <td style="font-size:18px;font-weight:bold;color:gray" colspan="2">
                <a style="text-decoration:none;" href="mailto:AIAfeedback@postersw.com?Subject=AIAFeedback">Feedback</a></td></tr>
            </table>

            </div>
        
 <!-- FERRY ------------------------------------------------------------------------------------------>
    <div id="ferryschedulepage" style="display:none">

    <h1>
        <button style="background-color:blue;color:white;float:left" onclick="ShowMainPage();">&larr;BACK</button>
        Ferry Schedule
    </h1>
    <button style="width:32%" onclick="ShowFerryLocation();">Ferry Location</button>
     <button   style="width:32%" onclick="ShowFerry();">Ferry Web Site</button>
        <p> </p>
        <table id='ferrytable' style="border:thin solid black;border-collapse:collapse">
            <tr style="background-color:black;color:white">
                <td>Steilacoom</td>
                <td>| Anderson Island&nbsp</td>
            </tr>
        </table>
        <hr />
        <p id="schdate"></p>
        <button style="width:32%" onclick="ShowMainPage();">&larr;BACK</button>
    </div>

 <!-- OPEN HOURS ------------------------------------------------------------------------------------------>
    <div id="openhourspage" style="display:none">
        <h1>
            <button style="background-color:blue;color:white;float:left" onclick="ShowMainPage();">&larr;BACK</button>
            Open Hours
        </h1>
        <p>Touch an entry for more information.</p>
        <table id='openhourstable' style="border:thin solid black;border-collapse:collapse">
            <tr style="background-color:black;color:white">
                <td>Location</td>
            </tr>
        </table>
        <button style="width:32%" onclick="ShowMainPage();">&larr;BACK</button>
        </div>

<!-- COMING EVENTS ------------------------------------------------------------------------------------------>

    <div id="comingeventspage" style="display:none">
        <h1 id="comingeventsH1" style="display:none">
            <button style="background-color:blue;color:white;float:left" onclick="ShowMainPage();">&larr;BACK</button>
            COMING EVENTS
           <button style="background-color:blue;color:white;float:right" onclick="ShowOtherCalendars();">MORE</button>
        </h1>
        <h1 id="comingactivitiesH1" style="display:none">
            <button style="background-color:blue;color:white;float:left" onclick="ShowMainPage();">&larr;BACK</button>
            COMING ACTIVITIES
            <button style="background-color:blue;color:white;float:right" onclick="ShowOtherCalendars();">MORE</button>
        </h1>
         
        <div id="othercalendars" style="display:none">
            <p>CALENDARS:<br />
            <button onclick="window.open('http://www.andersonislandcc.org/calendar/');">Comm Club</button>
            <button onclick="window.open('http://rivieracommunityclub.com/event-calendar');">Riviera</button>
            <button onclick="window.open('http://andersonislandhs.org');">Hist Society</button>
            </p> 
         </div>

       <button style="width:22%" onclick="DisplayComingEventsList( GetEvents())">List</button>
       <button style="width:22%" onclick="DisplayComingWeek( GetEvents())">Week</button>
       <button style="width:22%" onclick="DisplayComingMonth( GetEvents())">Month</button>
        <p></p>

        <table id='comingeventstable' style="border:thin solid black;border-collapse:collapse">
            <tr style="background-color:black;color:white">
                <td></td>
            </tr>
        </table>
        <button style="width:32%" onclick="ShowMainPage();">&larr;BACK</button>
    </div>
<!--TIDES ------------------------------------------------------------------------------------------>

    <div id="tidespage" style="display:none">
        <h1>
            <button style="background-color:blue;color:white;float:left" onclick="ShowMainPage();">&larr;BACK</button>
            Tides at Yoman Point <br />(ferry dock)
        </h1>
        <p id="tidepagecurrent">Please wait for tide data .... </p>
        <table id='tidestable' style="border:thin solid gray;border-collapse:collapse">
            <tr style="background-color:gray;color:white">
                <td>Date</td>
                <td>| Time&nbsp</td>
                <td>| Type&nbsp</td>
                <td>| Feet&nbsp</td>
            </tr>
        </table>
        <hr />
        <p id="demo">
        <button id="tideButton" onclick="ShowCustom();" hidden="hidden">Get Tides for other days</button>
        </p>

     <p>These tide predictions are provided for 
         <a href="http://opendap.co-ops.nos.noaa.gov/axis/webservices/highlowtidepred/">station id 9446705 by NOAA</a>  through Aeris. <br />
         Approximate current height calculated using <a href="https://en.wikipedia.org/wiki/Rule_of_twelfths"> Rule of Twelves.</a><br />
        This page updates every minute.</p>
        <button style="width:32%" onclick="ShowMainPage();">&larr;BACK</button>
 

    </div>

<!--EMERGENCY ------------------------------------------------------------------------------------------>

    <div id="emergencypage" style="display:none">
        <h1><button style="background-color:blue;color:white;float:left" onclick="ShowMainPage();">&larr;BACK</button>
            Emergency Contacts</h1>
        <p>Tap a phone number to dial it.</p>
        <table id="emergencytable">
        </table>
        <button style="width:32%" onclick="ShowMainPage();">&larr;BACK</button>
        </div>
<!--WEATHER -------------------------------------------------------------------------------------------->
 <div id="weatherpage" style="display:none">
    <h1>
        <button style="background-color:blue;color:white;float:left" onclick="ShowMainPage();">&larr;BACK</button>
        Anderson Island Weather
    </h1>

        <p id="currentweatherpage">Current weather: </p>
        <p id="forecastpage">Please wait for the forecast.</p>
       <table id='forecasttable' style="border:thin solid black;border-collapse:collapse">
            <tr style="background-color:black;color:white;">
                <td>DAY TIME</td>
                <td>TEMP&nbsp</td>
                <td>FORECAST</td>
                <td>RAIN in. </td>
                <td>WIND mph</td>
            </tr>
        </table>
        <p>The forecast in yellow is for the 12 hour day.<br />
            The forecast in gray is for the 12 hour night.<br />
            Forecast data provided by AerisWeather.
        </p>
             <button style="width:32%" onclick="ShowMainPage();">&larr;BACK</button>
     </div>

<!-- FERRY WEBCAMS ------------------------------------------------------------------------------------->
  <div id="ferrywebcampage" style="display:none">
      <h1>      
          <button style="background-color:blue;color:white;float:left" onclick="ShowMainPage();">&larr;BACK</button>
          FERRY WEBCAMS
      </h1>
        <strong>Steilacoom Camera </strong>- refreshes every minute<br>
        <br />
        <img id="steilacoomcam"  alt="Steilacoom Camera " src="icon.png"> 
        <hr/>
        <strong>Anderson Island Camera </strong>- refreshes every minute<br /><br>
        <img id="aicam" src="icon.png"><br />
           <button style="width:32%" onclick="ShowMainPage();">&larr;BACK</button>

</div>
 <!-- ABOUT ------------------------------------------------------------------------------------->
  <div id="aboutpage" style="display:none">
    <h1> 
      <button style="background-color:blue;color:white;float:left" onclick="ShowMainPage();">&larr;BACK</button>
      About
    </h1>
    <p>The Anderson Island Assistant is a handy little mobile app whose purpose is to provide instant access 
        to all sorts of good Anderson Island stuff, especially time-sensitive information.  
        It is available now in beta-form as a web-based app from <a href="http://www.anderson-island.org">www.anderson-island.org</a>.
        It will be available soon as as an Android phone app on Google Play.
         It will be available after that as an app for iPhones on the iPhone App Store, and Windows phones at the Windows Store.
       </p>
        <hr />
        <p>The Anderson Island Assistant is created and produced by island resident Bob Bedoll at Poster Software, LLC. (www.postersw.com).</p>
        <p> <a style="text-decoration:none;background-color:lightgray;width:50%;padding:12px" href="mailto:support@postersw.com">Send Email</a>
            <a style="text-decoration:none;background-color:lightgray;width:50%;padding:12px" href="tel:253-267-4936">Call Us</a></p>
        <p>Email: support@postersw.com.  Phone: 253-267-4936</p>
        <p>2/23/2016.</p>

</div>
<!-- ISLAND INFORMATION LINKS ---------------------------------------------------------------------->
<div id="linkspage" style="display:none">
    <h1> 
        <button style="background-color:blue;color:white;float:left" onclick="ShowMainPage();">&larr;BACK</button>
        ISLAND INFORMATION LINKS
    </h1>
            <button style="width:100%;padding:6px;text-align:left" onclick="window.open('http://www.aicab.org');">Citizens Advisory Board</button><br />
            <button style="width:100%;padding:6px" onclick="window.open('http://www.andersonislandcc.org');">Community Club</button><br />   
            <button style="width:100%;padding:6px" onclick="window.open('http://andersonislandhs.org');">Historical Society</button><br />                 
            <button style="width:100%;padding:6px" onclick="window.open('http://www.andersonislandsafety.org');">Island Patrol</button><br />
            <button style="width:100%;padding:6px" onclick="window.open('http://www.yellowbook.com/local-business-directory/?where=anderson+island%2C+wa');">Local Businesses</button><br />
            <button style="width:100%;padding:6px" onclick="window.open('http://andersonislandparks.org');">Parks</button><br />
            <button style="width:100%;padding:6px" onclick="window.open('http://www.doh.wa.gov/ehp/sf/biotoxin.htm');">Redtide Status (WA DOH)</button>
            <button style="width:100%;padding:6px" onclick="window.open('http://rivieracommunityclub.com');">Riviera</button><br />
            <button style="width:100%;padding:6px" onclick="window.open('http://wdfw.wa.gov/fishing/shellfish/');">Shellfish (WDFW)</button>
            <button style="width:100%;padding:6px" onclick="window.open('http://www.andersonislandgeneralstore.com');">Store</button><br />
            <button style="width:100%;padding:6px" onclick="window.open('http://www.tannerelectric.coop');">Tanner Electric</button><br />
</div>
<!-- debugging times ----------------------------------------------------------------------------------->

        <p> This page updates every minute.<br />
            <span id="updatetime" style="font-size:x-small">Screen update time.</span>
            <span id="reloadtime" style="font-size:x-small">Data reload time.</span>
            <span id="reloadreason" style="font-size:x-small">Data reload reason.</span>
            <span id="currentweathertime" style="font-size:x-small"></span>
       <br /><span style="font-size:x-small">Weather from OpenWeatherMap<br />
           AIA Web Ver: 0.4.227-0925</span>


        </p>


    <div id="deviceready"  style="display:none"> <!-- removed class="blink"-->
        <p class="event listening">Connecting to Device</p>
        <p class="event received">Device is Ready</p>
    </div>
</div>


    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript" src="js/AIA.js"></script>

    <script>
        // global date variables. note: scope is for one page only.
        //var d; // date object
        //var dayofweek;  // day of week in 0-6
        //var letterofweek; // letter for day of week
        //var timehhmm;  // hhmm in 24 hour format
        //var month;  // month 1-12. note starts with 1
        //var day; // day of month 1-31
        //var year; // year nnnn
        //var monthday; // mmdd
        //var laborday; // first monday in sept.  we need to compute this dyanmically
        //var memorialday;  // last monday in may
        //var thanksgiving;
        //var holiday;  // true if  holiday
        var updateMinutes; // minutes since last update
        var forceCacheReload; // true to force a cache reload
        var forceTideReload;  // true to force tide reload
        /////////////////////////////////////////////////////////////////////////////////////////
        // load web pages
        function ShowFerry() {
            DisplayFerrySchedulePage();
            //window.open("http://www.co.pierce.wa.us/index.aspx?NID=1793");
        }

        //function ShowFerrySchedule() {
        //    window.open("localferryschedule.html");
        //    //window.open("http://www.co.pierce.wa.us/index.aspx?NID=2200");
        //}
        function ShowFerryCams() {
            window.open("ferrywebcams.html", '_parent');
        }
        //function ShowComingEvents() {
        //    window.open("comingevents.html"); //("http://www.andersonislandcc.org/calendar/");
        //}
        // query for tide times at noaa
        function ShowTides() {
            window.open("tides.html", '_parent');
        }
        // query for tide times at noaa
        function ShowWeather() {
            window.open("aiweather.html", '_parent');
        }
        function ShowMap() {
            window.open("https://www.google.com/maps/place/Anderson+Island,+Washington+98303/@47.1559337,-122.7429194,13z/data=!3m1!4b1!4m2!3m1!1s0x5491a7e3857e1e6f:0x9800502f110113b4")
        }
        
        function ShowBurnBan() {
            window.open("http://www.pscleanair.org/priorities/woodheating/Pages/burnbans.aspx")
        }

        function LocalMenu() {

        }

        /////////////////////////////////////////////////////////////////////////////////////////
        // return the next ferry time as a string. ferrytimes is the array of times and days;
        function FindNextFerryTime(ferrytimes) {
            ferrytimes = ferrytimes.split(",");
            InitializeDates(0);
            var i;
            // roll through the ferry times, skipping runs that are not valid for today
            for (i = 0; i < ferrytimes.length; i = i + 2) {
                if (timehhmm >= ferrytimes[i]) continue;  // skip ferrys that have alreaedy run
                // now determine if the next run will run today.  If it is a valid run, break out of loop.
                if (ValidFerryRun(ferrytimes[i + 1])) break;
            }

            // we ran out of the schedule today so give the 1st run for tomorrow
            if (i >= ferrytimes.length) {
                i = 0;
                // need to compute if tomorrow is a holiday
                if (!IsHoliday(monthday + 1) && (dayofweek == 6)) i = 2; // special case kludge. on saturday, start sunday at 
            }

            // convert to a string and add am or pm and optionally tomorrow
            var ft;
            ft = VeryShortTime(ferrytimes[i]);
            if (ferrytimes[i] < timehhmm) ft = ft + " tomorrow";
                
            else {
                ft =ft + " (in " + timeDiff(timehhmm, ferrytimes[i]) + ")";
            }
            return ft;
        }

        /////////////////////////////////////////////////////////////////////////////////////////
        // Finds the next ferry times and puts them into the Dom.
        function WriteNextFerryTimes() {
            // ferrytimes = time in 24 hours, S=Steilacoom, A=Anderson Island, 
            // ferrydays:  *=always, H=holiday, 0-6=days of week, AFXY=special rules H=(12/31,1/1,Mem day, 7/3,7/4,labor day,thanksgiving, 12/24,12/25),F=Fuel run 1,3 Wednesday, X=Friday Only labor day-6/30, Y=Fridays only 7/1=labor day
            //var ferrytimeS = [545, "H123456A", 645, "*", 800, "*", 900, "*", 1000, "F", 1200, "*", 1410, "*", 1510, "*", 1610, "*", 1710, "*", 1830, "*", 1930, "*", 2040, "4560H", 2200, "X6H", 2300, "Y"];
            //var ferrytimeA = [615, "H123456A", 730, "*", 830, "*", 930, "*", 1030, "F", 1230, "*", 1440, "*", 1540, "*", 1640, "*", 1740, "*", 1900, "*", 2000, "*", 2110, "4560H", 2230, "X6H", 2330, "Y"];
            // at this point, i = the next valid ferry run
            var v;
            v = "Next Steilacoom: ";
            if (holiday) v = "Hoilday Steilacoom: "
            var lftS = localStorage.getItem("ferrytimess");
            if (lftS === null) lftS = "545,H123456A,645,*,800,*,900,*,1000,F,1200,*,1410,*,510,*,1610,*,1710,*,1830,*,1930,*,2040,4560H,2200,X6H,2300,Y";
            var lftA = localStorage.getItem("ferrytimesA");
            if (lftA === null) lftA = "615,H123456A,730,*,830,*,930,*,1030,F,1230,*,1440,*,1540,*,1640,*,1740,*,1900,*,2000,*,2110,4560H,2230,X6H,2330,Y";
            v = v + FindNextFerryTime(lftS);
            // make it bold if not tomorrow
            if (v.indexOf('tomorrow') < 0) v = "<span style='font-weight:bold'>" + v + "</span>";
            var a = "</br>Next Anderson Is: " + FindNextFerryTime(lftA);
            if (a.indexOf('tomorrow') < 0) a = "<span style='font-weight:bold;color:darkblue'>" + a + "</span>";
            //v = v + FindNextFerryTime(lftS) + "</br>Next Anderson Is: " + FindNextFerryTime(lftA);
            document.getElementById("ferrytimes").innerHTML = v + a;

        }

        /////////////////////////////////////////////////////////////////////////////////////////
        // ShowOpenHours - shows whether something is open or closed. 
        //  Entry: openhours is a string in "openhours", loaded from 'dailycache.txt'
        //  exit: returns a display string with the open hours for all businesses.
        //     
        function ShowOpenHours() {
            // openHours format is array of strings, 1 string per business Defined in AIA.js.
            // each string is: name (phone),Suntime,Montime,Tuetime,Wedtime,Thurtime,Fritime,Sattime,closedholidays
            //   where xxxtime = hhmm-hhmm in 24 hour format. closedholidays = mmdd/mmdd/mmdd...
            var j;
            var openlist;
            var a;
            var store;
            var opentimetoday, opentime, closetime;
            var openHours;

            openHours = localStorage.getItem("openhours");
            if (openHours === null) return "";
            if(openHours == "") return "";
            openHours = openHours.split("\n");
            openlist = "";

            // loop through the openHours array (each string entry is one business)
            for (var i = 0; i < openHours.length-1; i++) {
                a = openHours[i].split(",");  // parse it into an array'
                if (a[0] == "OPENHOURSEND") break;
                store = a[0].split("("); // strip out phone number
                openlist += "<span style='font-weight:bold'>" + store[0] + "</span>:";
                //opentimetoday = a[dayofweek + 1]; // hhmm-hhmm open today
                //opentime = Number(opentimetoday.substring(0,4)); // open time hhmm
                //closetime = Number(opentimetoday.substring(5, 9)); // close time hhmm
                openlist += GetOpenStatus(a) + "<br/>";
            } // end for
            return openlist;
        }

        ///////////////////////////////////////////////////////////////////////////////////////
        // GetOpenStatus - determine if business is open & reeturn string
        //  entry: a = array of openTime for 1 business
        //  exit: returns string
        function GetOpenStatus(a) {
            var opentimetoday, opentime, closetime;
            opentimetoday = a[dayofweek + 1]; // hhmm-hhmm open today
            opentime = Number(opentimetoday.substring(0, 4)); // open time hhmm
            closetime = Number(opentimetoday.substring(5, 9)); // close time hhmm
            var openlist; openlist = "";
            // test for closed
            if (opentimetoday = "" || (timehhmm > closetime) || (timehhmm < opentime)) {
                openlist += " <span style='color:red'> Closed. </span>";
                if (timehhmm < opentime) {
                    openlist += " Opens today at " + VeryShortTime(opentime);
                    return openlist;
                }
                // find next open time
                j = dayofweek + 1; if (j == 7) j = 0;
                // if it opens tomorrow
                if (a[j + 1]) {
                    openlist += " Opens tomorrow at " + VeryShortTime(a[j + 1].substring(0, 4));
                    return openlist;
                }
                // not open tomorrow. find next open day.
                while (true) {
                    j++; if (j == 7) j = 0; // handle day rollover
                    if (a[j + 1] != "") { // open day found
                        openlist += " Opens " + dayofweekname[j] + " at " + VeryShortTime(a[j + 1].substring(0, 4));
                        return openlist;
                    }
                } // while loop

            } else {
                // its open
                openlist += " <span style='color:green'> Open </span>till " + VeryShortTime(closetime) + " today";
                return openlist;
            }
        }

        //////////////////////////////////////////////////////////////////////////////////////////////////////
        // getCurrentWeather  
        //function getCurrentWeatherAERIS() {
            //alert("getcurrentweather");
            // kludge - exit right away
        //    var t = localStorage.getItem("currentweathertime");
        //    if (t != null && RawTimeDiff(t, timehhmm) < 20) return; // gets weather async every 20 min.
        //    localStorage.setItem("currentweathertime", timehhmm); // save the cache time so we don't keep asking forever

        //    $.ajax({
        //        url: 'http://api.aerisapi.com/observations/98303?client_id=U7kp3Zwthe8dc19cZkFUz&client_secret=4fHoJYS6m9T7SERu7kkp7iVwE0dewJo5zVF38tfW',
        //        dataType: 'jsonp',
        //        success: function (json) {
        //            if (json.success == true) {
        //                //alert("json success");
        //                // pick out the return variables
        //                var r = json.response.ob;
        //                var current =  r.tempF + "&degF, " + r.weather + ", " +  r.windDir + " " + r.windMPH + " mph " +
        //                    ", " + r.precipIN + " precip."
        //                localStorage.setItem("currentweather", current);
        //                localStorage.setItem("currentweathertime", timehhmm); // save the cache time
        //                $("#weather").html(current); // jquery equivalent. Is this really easier?
        //            }
        //            else {
        //                // error, but Don't correct forecast. just leave the old one.
        //                // update the time so that we don't keep asking futilly.
        //                //alert('Could not get current weather: ' + json.error.description);
        //                //if (localStorage.getItem("currentweather") == null) { // if no current weather, set to 'not available'
        //                var current = "Current weather not available.";
        //                localStorage.setItem("currentweather", current);
        //                $("#weather").html(current);
        //                localStorage.setItem("currentweathertime", timehhmm); // save the cache time so we don't keep asking forever
        //            }
        //        }
        //    });
        //} // end of function

        ////////////////////////////////////////////////////////////////////////////////////////////////////
        // StripDecimal - strips out the decimal part of a numeric text string
        function StripDecimal(n) {
            var ns = String(n);
            var i = ns.indexOf(".");
            if (i < 0) return ns;
            if (i == 0) return "";
            ns = ns.substring(0, i); // strip it
            return ns;
        }
        ////////////////////////////////////////////////////////////////////////////////////////////////////
        //  DegToCompassPoints - converts degrees to compass points
        function DegToCompassPoints(d) {
            var cp = ["N", "NE", "E", "SE", "S", "SW", "W", "NW", "N"];
            return cp[Math.floor((Number(d)+22.5) / 45)];
        }

        //////////////////////////////////////////////////////////////////////////////////////////////////////
        // getCurrentWeather  using WorldWeatherMap free service
        //  entry: "currentweathertime" = hhmm of last weather.  null to force now. otherwise we ask every 20 min
        //  exit: saves "currentweathertime" and "currentweather"
        // actual json response {"coord":{"lon":-122.6,"lat":47.17},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"base":"cmc stations","main":{"temp":54.18,"pressure":1023.6,"humidity":69,"temp_min":54.18,"temp_max":54.18,"sea_level":1034.45,"grnd_level":1023.6},"wind":{"speed":3.36,"deg":351.002},"clouds":{"all":0},"dt":1456447797,"sys":{"message":0.0082,"country":"US","sunrise":1456498595,"sunset":1456537846},"id":5812092,"name":"Steilacoom","cod":200}
        function getCurrentWeather() {
            var t = localStorage.getItem("currentweathertime");
            if (t != null && RawTimeDiff(t, timehhmm) < 20) return; // gets weather async every 20 min.
            localStorage.setItem("currentweathertime", timehhmm); // save the cache time so we don't keep asking forever

            $.ajax({
                url: 'http://api.openweathermap.org/data/2.5/weather?id=5812092&units=imperial&APPID=f0047017839b75ed3d166440bef52bb0',
                dataType: 'jsonp',
                success: function (r) {
                    // short form
                    var rain;
                    if (typeof r.rain == 'undefined' || typeof r.rain["3h"] == 'undefined') rain = "0";
                    else rain = (Number(r.rain["3h"])/25.4).toFixed(2);
                    var current = StripDecimal(r.main.temp) + "&degF, " + r.weather[0].description + ", " + DegToCompassPoints(r.wind.deg) + " " +
                        StripDecimal(r.wind.speed) + " mph, " + rain + " rain" ;// + ", " + r.precipitation.value + r.precipitation.value
                    localStorage.setItem("currentweather", current);
                    localStorage.setItem("currentweathertime", timehhmm); // save the cache time
                    $("#weather").html(current); // jquery equivalent. Is this really easier?
                    // detailed
                    dsr = new Date(Number(r.sys.sunrise)*1000);
                    dss = new Date(Number(r.sys.sunset) * 1000);
                    var currentlong = "Currently " + r.weather[0].description + ", " + StripDecimal(r.main.temp) + "&degF, " +
                        r.main.humidity + "% RH, wind " + DegToCompassPoints(r.wind.deg) + " " + StripDecimal(r.wind.speed) + " mph " +
                         ", " + rain + " in. rain, " +
                        "<br/>Sunrise at " + dsr.toLocaleTimeString() + ", Sunset at " + dss.toLocaleTimeString();

                    localStorage.setItem("currentweatherlong", currentlong);
                    }
            });
        } // end of function

        //////////////////////////////////////////////////////////////////////////////////////////////////////////
        // getForecast
        // get weather data using the aeris api and returning a jsonp structure. This is the only way to get data from a different web site.
        // License as of 2/8/16 is for 750 hits/day for free.
        //function getForecast()AERIS {
        //    // kludge to prevent over fishing of forecast
        //    var t = localStorage.getItem("forecasttime");
        //    if (t != null && RawTimeDiff(t, timehhmm) < 180) return; // gets weather async every 20 min.
        //    localStorage.setItem("forecasttime", timehhmm); // save the cache time so we don't keep asking forever

        //    $.ajax({
        //        url: 'http://api.aerisapi.com/forecasts/98303?client_id=U7kp3Zwthe8dc19cZkFUz&client_secret=4fHoJYS6m9T7SERu7kkp7iVwE0dewJo5zVF38tfW',
        //        dataType: 'jsonp',
        //        success: function (json) {
        //            if (json.success == true) {
        //                var r = json.response[0].periods[0];
        //                var forecast = "Forecast: " + r.maxTempF + "&deg/" + r.minTempF + "&deg, " + r.weather;
        //                localStorage.setItem("forecast", forecast);
        //                localStorage.setItem("forecasttime", timehhmm); // save time
        //                $("#forecast").html(forecast);
        //            }
        //            else {
        //                // no error. Don't correct forecast. just leave the old one.
        //                // update the time so that we don't keep asking futilly.
        //                //alert('Could not load weather forecast: ' + json.error.description);
        //                //$("#forecast").html("Forecast is not available.");
        //                if (localStorage.getItem("forecast") == null) { // if no current weather, set to 'not available'
        //                    var current = "Current forecast not available.";
        //                    localStorage.setItem("forecast", current);
        //                    $("#forecast").html(current);
        //                }
        //                localStorage.setItem("forecasttime", timehhmm); // save time so we don't keep asking
        //            }
        //        }
        //    });  // end of ajax call
        //}  // end of function

            //////////////////////////////////////////////////////////////////////////////////////////////////////////
            // getForecast using WorldWeatherMap. License for 
            // get weather data using the aeris api and returning a jsonp structure. This is the only way to get data from a different web site.
            // License as of 2/25/16 is for 60 hits/min for free. http://openweathermap.org/price
            function getForecast() {
                // kludge to prevent over fishing of forecast
                var t = localStorage.getItem("forecasttime");
                if (t != null && RawTimeDiff(t, timehhmm) < 60) return; // gets weather forecast async every 60 min.
                localStorage.setItem("forecasttime", timehhmm); // save the cache time so we don't keep asking forever

                $.ajax({
                    url: 'http://api.openweathermap.org/data/2.5/forecast?id=5812092&units=imperial&APPID=f0047017839b75ed3d166440bef52bb0',
                    dataType: 'jsonp',
                    success: function (json) {
                        var r = json.list[0];
                        var forecast = "Forecast: " + StripDecimal(r.main.temp_max) + "&deg/" + StripDecimal(r.main.temp_min) + "&deg, " +
                            r.weather[0].description + ", " + DegToCompassPoints(r.wind.deg) + " " + StripDecimal(r.wind.speed) + " mph ";
                        localStorage.setItem("forecast", forecast);
                        localStorage.setItem("forecasttime", timehhmm); // save time
                        $("#forecast").html(forecast);
                    }
                });  // end of ajax call
            }  // end of function
        /////////////////////////////////////////////////////////////////////////////////////////////
        // get tide data using the aeris api and returning a jsonp structure. This is the only way to get data from a different web site.
        // License as of 2/8/16 is for 750 hits/day for free.
        //  entry: localStorage "jsontides" = tide data  (refreshed nightly)
        //  exit: forceCacheReload = true to reload tide data.  
        //          html populated.
        function ShowNextTides() {
            var hilow;
            var nextTides;
            var oldtide = -1;
            var newtidetime, oldtidetime, newtideheight, oldtideheight;
            var json = localStorage.getItem("jsontides");
            // get tide data
            if (json === null) {
                forceTideReload = true;
                document.getElementById("tides").innerHTML = "Tide data not available.";
                return;
            }

            var periods = JSON.parse(json); // parse it
            // roll through the reply in jason.response.periods[i]
            var i;
            for (i = 0; i < periods.length; i++) {
                var thisperiod = periods[i];
                var m = Number(thisperiod.dateTimeISO.substring(5, 7));
                var d = Number(thisperiod.dateTimeISO.substring(8, 10));
                var h = Number(thisperiod.dateTimeISO.substring(11, 13)); // tide hour
                var mi =Number(thisperiod.dateTimeISO.substring(14, 16));  // time min
                var tidehhmm = ((h) * 100) + (mi);
                if (thisperiod.type == 'h') hilow = 'High';
                else hilow = 'Low';
                // if tide is past, color row gray
                if ((month > m) || (month == m && dayofmonth > d) || (month == m && dayofmonth == d && (timehhmm > tidehhmm))) {
                    oldtide = 0;
                    oldtidetime = tidehhmm; oldtideheight = thisperiod.heightFT;
                } else if (oldtide != 1) {
                    var cth = CalculateCurrentTideHeight(tidehhmm, oldtidetime, thisperiod.heightFT, oldtideheight);
                    if (thisperiod.type == 'h') {
                        nextTides = "Incoming. Now ";
                        document.getElementById("tidestitle").innerHTML = "TIDE &uarr;";
                    } else {
                        nextTides = "Outgoing. Now ";
                        document.getElementById("tidestitle").innerHTML = "TIDE &darr;";
                    }
                    nextTides += cth.toFixed(1) + "ft.<br/>Next: " + hilow + " " + thisperiod.heightFT + " ft. at " + ShortTime(tidehhmm) +
                         " (in " + timeDiff(timehhmm, tidehhmm) + ")<br/>";
                    oldtide = 1;
                } else if (oldtide == 1) {  // save next tide
                    nextTides += hilow + " " + thisperiod.heightFT + " ft. at " + ShortTime(tidehhmm) + " (in " + timeDiff(timehhmm, tidehhmm) + ")";
                    document.getElementById("tides").innerHTML = nextTides;
                    return;
                }
            }
            forceTideReload = true; // if we haven't gotten today's tides, reload it
         }

        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        // getTideData - call the aeri api and store the response as a local storage string
        //
        function getTideData() {
            var hilow;
            var nextTides;
            var oldtide = -1;
            var t = localStorage.getItem("tidesloadedmmdd");
            if (t != null && (Number(t)== monthday)) return; // gets tides async every day

            $.ajax({
                url: 'http://api.aerisapi.com/tides/9446705?client_id=pSIYiKH6lq4YzlsNY54y0&client_secret=vMb1vxvyo7Z96DSn7niwxVymzOxPN6qiEEdBk7vS&from=-20hours&to=+96hours',
                dataType: 'jsonp',
                success: function (json) {

                    if (json.success == true) {
                        localStorage.setItem("jsontides", JSON.stringify(json.response.periods)); // store the full json structure
                        localStorage.setItem("tidesloadedmmdd", monthday);
                        ShowNextTides();
                    } else {
                        // error
                        //localStorage.setItem("tidesloadedmmdd", monthday);
                    }
                }
            });
        }

      
        ////////////////////////////////////////////////////////////////////////////////////////////
        // DisplayNextEvent


        ///////////////////////////////////////////////////////////////////////////////////////////////
        // DisplayComingEvents - display the events in the 'comingevents'  or 'comingactivities' local storage object
        //  object consists of rows (separated by /n) 1 for each event or activity
        function DisplayNextEvents(CE){
            var datefmt=""; // formatted date
            var iCE; // iterator through CE
            var aCE; // CE split array 
            var aCEmonthday;
            if (CE === null) return;
            // break CE up into rows
            CE = CE.split("\n");  // break it up into rows
            if (CE == "") return;
            // roll through the next 30 days
            for (iCE = 0; iCE < CE.length; iCE++) {
                aCE = CE[iCE].split(';');  // split the string
                //  advance schedule date to today
                aCEmonthday = Number(aCE[0]);
                if (aCEmonthday < monthday) continue; // not there yet
                // if the entry is for today and it is done, skip it
                if (aCEmonthday == monthday && Number(aCE[2]) < timehhmm) continue; // if today and it is done, skip it
                // found it
                if (aCEmonthday != monthday && datefmt != "") return datefmt; // don't return tomorrow if we all the stuff for today
                if (aCEmonthday == monthday) datefmt += "<span style='font-weight:bold'>Today</span>";
                else if (aCEmonthday == (monthday + 1)) datefmt += "Tomorrow";
                else if (GetDayofWeek(aCE[0]) > dayofweek) { datefmt += dayofweekshort[GetDayofWeek(aCE[0])]; }
                else datefmt += dayofweekshort[GetDayofWeek(aCE[0])] + " " + aCE[0].substring(0, 2) + "/" + aCE[0].substring(2, 4);
                datefmt += " " + VeryShortTime(aCE[1]) + "-" + VeryShortTime(aCE[2]) + " " + aCE[4] + " @ " + aCE[5] + "<br/>";
                // show all events for today
                //if (Number(aCE[0]) == monthday) datefmt += "<br/>";  // event is for today, so go on to the next one
                //else return datefmt;
            }
            return datefmt; // end case
        }


        ///////////////////////////////////////////////////////////////////////////////////////////////
        //  GetComingEvents - retrieves the coming events into the comingevents local storage object
        //  Load from server using ajax async request.
        //  Store into local cache at 'comingevents' and 'comingactivities'  monthday of load stored into local cache at 'comingeventsloaded'
        function GetComingEvents() {
            // ajax async request
            //$.get("comingevents.txt", ComingEventsReceived());
            //                 url: "http://anderson-island.org/comingevents.txt" for phone use fully qualified url
            $.ajax({
                url: "comingevents.txt",
                success: function (data) {
                    //alert("Data: " + data + "\nStatus: " + status);
                    var i = data.indexOf("ACTIVITIES");
                    if(i==0) i=data.length; 
                    localStorage.setItem("comingevents", data.substring(0, i));
                    if(i<data.length) localStorage.setItem("comingactivities", data.substring(i+11, data.length));
                    localStorage.setItem("comingeventsloaded", monthday); // save event loaded date/time
                    //alert("coming events loaded at " + monthday);
                    $("#nextevent").html(DisplayNextEvents(localStorage.getItem("comingevents")));
                    $("#nextactivity").html(DisplayNextEvents(localStorage.getItem("comingactivities")));
                }
            });
            //alert("comingevents.txt requested");
            return;
        }

        ///////////////////////////////////////////////////////////////////////////////////////////////
        //  GetDailyCache - retrieves the daily cache into the local storage objects 
        //  Load from server using ajax async request.
        //  Store into local cache at 'comingevents'.  monthday of load stored into local cache at 'comingeventsloaded'
        function GetDailyCache() {
            // ajax async request
            $.ajax({
                url: "dailycache.txt", // for phone use fully qualified url http://anderson-island.org/
                success: function (data) {
                    InitializeDates(0);
                    ReloadDailyCache(data);
                    localStorage.setItem("dailycacheloaded", monthday); // save event loaded date/time
                    localStorage.setItem("dailycacheloadedtime", timehhmm); // save event loaded date/time
                    DisplayLoadTimes();

                    //alert("coming events loaded at " + monthday);
                }
            });
            //alert("comingevents.txt requested");
            return;
        }

        ////////////////////////////////////////////////////////////////////////////////////////
        // ReloadDailyCache - parses the daily cache into its parts in local storage
        //  note: data must be in the order of FERRYTIMESS,FERRYTIMESA,OPENHOURS,OPENHOURSEND,EMERGENCY,EMERGENCYEND
        function ReloadDailyCache(data) {
            var s;
            var i1, i2, i3, i4;
            data = data.replace(/\r/g, ""); // remove all crs regular expression with global flag
            //var rows = data.split("\n"); //split into lines
            if (data.substring(0,10) != "DAILYCACHE") {
                //alert("could not load updated values for ferry times and open hours");
                document.getElementById("reloadreason").innerHTML = "Could not load dailycache data.";
                return;
            }
            //alert("loading daily cache");
            localStorage.setItem("dailycacheloaded", monthday); // remember date time
            // alternate approach
            //alert("Data: " + data + "\nStatus: " + status);
            // FERRYTIMESS
            i1 = data.indexOf("FERRYTIMESS");
            if (i1 == 0) i = data.length;
            i2 = data.indexOf("FERRYTIMESA");
            i3 = data.indexOf("OPENHOURS");
            i4 = data.indexOf("OPENHOURSEND");
            var i5 = data.indexOf("EMERGENCY");
            var i6 = data.indexOf("EMERGENCYEND");
            localStorage.setItem("ferrytimess", data.substring(i1 + 12, i2));
            localStorage.setItem("ferrytimesa", data.substring(i2 + 12, i3));
            localStorage.setItem("openhours", data.substring(i3 + 10, i4));
            if (i5 > 0) localStorage.setItem("emergency", data.substring(i5 + 10, i6));
            
            
        }

        /////////////////////////////////////////////////////////////////////////////////////
        //  update all data on a regular basis
        //  also redisplay the next ferry times & tides & open hours every minute
        //  update current weather every 15 minutes. update forecast every 30 minutes.
        function timerUp() {
            updateMinutes = Number(localStorage.getItem("updateminutes"));

            // everything you want to do every minute. These all go against localStorage strings, so no query
            InitializeDates(0);
            document.getElementById("updatetime").innerHTML = "Screen updated at " + FormatTime(timehhmm);

            // special handling for other than the main page
            switch (localStorage.getItem("displaypage")){
                case "comingeventspage":
                    return;
                case "emergencypage":
                    return;
                case "ferryschedulepage":
                    return;
                case "openhourspage":
                    return;
                case "tidespage":
                    var periods = JSON.parse(localStorage.getItem("jsontides"));
                    ShowTideDataPage(periods, true);
                    return;
                case "weatherpage":
                    return;
                case "ferrywebcampage":
                    ShowFerryWebCam();
                    return; // how to force redisplay
            }

            // main page update

            ShowCachedData();

            // reload daily stuff - ferry schedule, store hours, coming events, tides
            var dailycacheloaded = localStorage.getItem("dailycacheloaded");
            if ((dailycacheloaded==null) || (Number(dailycacheloaded) != monthday)) {
                ReloadCachedData();
            }

            // get tides once/day
            getTideData();

            // current weather every 20 
            getCurrentWeather(); // gets weather async every 20 min. Timer is in routine.

            // forecast every 4 hours
            getForecast(); // gets weather async every 4 hour. Timer is in routine.

            updateMinutes++; // do this last so the focus event will run all of these but really we should use the actual elapsed time, not a counter
            localStorage.setItem("updateminutes", updateMinutes);
            DisplayLoadTimes();
        }

        /////////////////////////////////////////////////////////////////////////////
        // focus and blur events
        function focusEvent() {
            setInterval("timerUp()", 60000);  // timeout in milliseconds. currently 60 seconds
            localStorage.setItem("updateminutes", "0");
            timerUp();
        }
        function blurEvent() {
            clearInterval(0); // TURN OFF TIMER WHEN FOCUS IS LOST
        }

        //////////////////////////////////////////////////////////////////////////////////
        // show all cached data, i.e. all data in localStorage.
        // 
        function ShowCachedData() {
            WriteNextFerryTimes();  // show cached ferry schedule
            ShowNextTides(); // show cached tide data
            document.getElementById("openhours").innerHTML = ShowOpenHours(); //  open hours
            $("#nextevent").html(DisplayNextEvents(localStorage.getItem("comingevents")));
            $("#nextactivity").html(DisplayNextEvents(localStorage.getItem("comingactivities")));

            s = localStorage.getItem("forecast");
            if (s != null) document.getElementById("forecast").innerHTML = s;

            s = localStorage.getItem("currentweather"); // cached current weather
            if (s != null) document.getElementById("weather").innerHTML = s;

            DisplayLoadTimes();
        }

        ////////////////////////////////////////////////////////////////////////////////////
        // Reload cached data - calls all the ajax calls to get the data and recache it in localStorage.
        //
        function ReloadCachedData() {
            //alert("reload cached data");
            InitializeDates(0);
            GetDailyCache();  // no limit
            GetComingEvents();// no limit
            localStorage.removeItem("tidesloadedmmdd"); // force tides
            getTideData();// no limit
            localStorage.removeItem("forecasttime"); // force forecast reload at start of new day
            getForecast();// limited to every 120 min
            localStorage.removeItem("currentweathertime"); // force weather reload at start of new day
            getCurrentWeather();// limited to every 20 min
            DisplayLoadTimes();
        }

        //////////////////////////////////////////////////////////////////////////////////////
        // DisplayLoadTimes() displays time data loaded
        function DisplayLoadTimes() {
            document.getElementById("reloadtime").innerHTML = "Cached data reloaded@ " + localStorage.getItem("dailycacheloaded") + " @" + localStorage.getItem("dailycacheloadedtime") +
                                "<br/>Tides:" + localStorage.getItem("tidesloadedmmdd") + "; Forecast:" + localStorage.getItem("forecasttime") + "; CurrentWeather:" + localStorage.getItem("currentweathertime") + " Counter:" + updateMinutes;

        }

        ////////////////////////////////////////////////////////////////////////////////////////
        // show page (new page name). Turns off the page currently being displayed (displaypage) and turns on newpage.
        //  newpage = id of div for page, 'displaypage' = name of currently displaying page, 
        //  'tabletoclear' = name of table to clear in former page
        //  exit    displaypage = the new page
        function ShowPage(newpage) {
            // clear out rows of table for former page
            var t = localStorage.getItem("tabletoclear");
            if (t != null) {
                var table = document.getElementById(t);
                if (table != null) clearTable(table);
                localStorage.removeItem("tabletoclear");
            }
            // now switch to new page
            document.getElementById(localStorage.getItem("displaypage")).setAttribute('style', 'display:none;');
            document.getElementById(newpage).setAttribute('style', 'display:block;');
            localStorage.setItem("displaypage", newpage); // remember it
        }

        ///////////////////////////////////////////////////////////////////////////////////////////////////
        // show main page
        function ShowMainPage() {
            ShowPage("mainpage");
            timerUp();
        }

    </script>
    <script>
 //==== FERRY SCHEDULE =======================================================================================

        // FERRY SCHEDULE PAGE as a DIV.  Replaces 'localferryschedule.html'

        // loads the ferry schedule at pierce web page
        function ShowFerrySchedule() {
            window.open("http://www.co.pierce.wa.us/index.aspx?NID=2200");
        }
        function ShowFerryLocation() {
            window.open("http://matterhorn11.co.pierce.wa.us/FerryStatus/");
        }


        /////////////////////////////////////////////////////////////////////////////////////////
        // Loads the next ferry times into the global 'table' as a row for each run. 
        // ferrytimesS, ferrytimesA is the array of times and days for Steelacoom and AI;
        function BuildFerrySchedule(ferrytimesS, ferrytimesA) {
            var i;
            var ft;
            // roll through the ferry times, skipping runs that are not valid for today
            for (i = 0; i < ferrytimesS.length; i = i + 2) {
                if (timehhmm >= ferrytimesS[i] && timehhmm >= ferrytimesA[i]) continue;  // skip ferrys that have alreaedy run
                // now determine if the next run will run today.  If it is a valid run, break out of loop.
                if (ValidFerryRun(ferrytimesS[i + 1])) {
                    // Steelacoom
                    var row1, row1col1, row1col2;
                    row1 = table.insertRow(-1);
                    row1col1 = row1.insertCell(0);
                    row1col1.style.border.width = 1;
                    row1col1.innerHTML = "&nbsp&nbsp" + FormatTime(ferrytimesS[i]);
                    row1col1.style.border = "thin solid black";
                    // Anderson Island;
                    row1col2 = row1.insertCell(1);
                    row1col2.innerHTML = "&nbsp&nbsp" + FormatTime(ferrytimesA[i]);
                    row1col2.style.color = "darkblue";
                    row1col2.style.border = "thin solid black";
                }
            }
            return;
        }


        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        // run the script
    function DisplayFerrySchedulePage () {
        var row1, row1col1, row1col2;
        ShowPage("ferryschedulepage");


        InitializeDates(0);

        table = document.getElementById("ferrytable");
        localStorage.setItem("tabletoclear", "ferrytable");
        clearTable(table);

        row1 = table.insertRow(-1);
        row1col1 = row1.insertCell(0);
        row1col1.style.backgroundColor = "blue";
        row1col1.style.color = "white";
        row1col1.innerHTML = 'TODAY';
        row1col1 = row1.insertCell(1);
        row1col1.style.backgroundColor = "blue";
        row1col1.style.color = "white";
        row1col1.innerHTML = month + "/" + dayofmonth;
        BuildFerrySchedule(ferrytimeS, ferrytimeA);

        // build next 6 days
        timehhmm = 0;  // ignore current time
        var i;
        for (i = 0; i < 7; i++) {
            InitializeDates(1);  // tomorrow
            //alert(monthday + " dow " + dayofweek);
            row1 = table.insertRow(-1);
            row1col1 = row1.insertCell(0);
            row1col1.style.backgroundColor = "blue";
            row1col1.style.color = "white";
            row1col1.innerHTML = dayofweekname[dayofweek];
            row1col1 = row1.insertCell(1);
            row1col1.style.backgroundColor = "blue";
            row1col1.style.color = "white";
            row1col1.innerHTML = month + "/" + dayofmonth;
            if (holiday) row1col1.innerHTML = "Holiday";
            BuildFerrySchedule(ferrytimeS, ferrytimeA);
        }
        InitializeDates(0);  // reset dates back
        //alert("build ferry sch done");
        //Append Table into div.
        //document.getElementById('divTable').appendChild(table);
        //document.getElementById('schdate').innerHTML = "Based on schedule as of " + scheduledate[0];             // mark schedule date
        //alert("appended table to divTable");
    }
    </script>

    <script>
//======== OPEN HOURS ============================================================================

        /////////////////////////////////////////////////////////////////////////////////////////
        // ShowOpenHours - shows whether something is open or closed
        // openHours (global) is a string consisting of strings (rows) of store hours, separated by /n.
        // each string is: name,Suntime,Montime,Tuetime,Wedtime,Thurtime,Fritime,Sattime,closedholidays
        //   where xxxtime = hhmm-hhmm in 24 hour format. closedholidays = mmdd/mmdd/mmdd...
        function ShowOpenHoursPage() {
            var openlist;
            ShowPage("openhourspage");
            InitializeDates(0);
            table = document.getElementById("openhourstable");
            localStorage.setItem("tabletoclear", "openhourstable");
            clearTable(table);

            // read open hours from master source
            var openHours = localStorage.getItem("openhours");
            openHours = openHours.split("\n");

            // loop through the openHours array (each string entry is one business)
            var i;
            for (i = 0; i < openHours.length - 1; i++) {
                var a; a = openHours[i].split(",");  // parse it into an array
                openlist = "<span style='font-weight:bold'>" + a[0] + GetOpenStatus(a) + " </span><br/>&nbsp&nbsp&nbsp";  // name of business
                var phonenumber = a[0].split("(");
                phonenumber[1] = phonenumber[1].replace(")", ""); // remove closing paren
                // loop through Sun - Sat
                for (j = 0; j < 7; j++) {
                    var opentimetoday, opentime, closetime;
                    opentimetoday = a[j + 1]; // hhmm-hhmm open today
                    if (opentimetoday != "") {
                        opentime = opentimetoday.substring(0, 4); // open time hhmm
                        closetime = opentimetoday.substring(5, 9); // close time hhmm
                        openlist += dayofweekshort[j] + ":" + VeryShortTime(opentime) + "-" + VeryShortTime(closetime) + "&nbsp";
                    }
                } // for loop for each day
                var row = table.insertRow(-1);
                var s = '' + a[8] + '';
                //if (a[8] != "") row.onclick = function () { window.open(s); };
                var cell = row.insertCell(0);
                cell.innerHTML = openlist + "<br/><br/>" +
                    "<a style='display:normal;text-decoration:none;background-color:lightgray;padding:8px;width:300px' href='tel:" + phonenumber[1] + "'>Call " + phonenumber[1] + "</a>&nbsp&nbsp&nbsp&nbsp" +
                    "<a style='display:normal;text-decoration:none;background-color:lightgray;padding:8px;width:300px' href='" + a[8] + "'>Web Site</a><br/>&nbsp";
                cell.style.border = "thin solid black";
            } // for loop for each business
        }


    </script>

    <script>
//========= COMING EVENTS ===========================================================================

        ////////////////////////////////////////////////////////////////////////////////////////////////
        // DisplayComingEventsPage(type)
        //  entry   type = 'events' or 'activities'
        function DisplayComingEventsPage(type) {
            localStorage.setItem("eventtype", type);
            document.getElementById("othercalendars").setAttribute("style", "display:none");
            ShowPage("comingeventspage");
            InitializeDates(0);
            if (type == "events") {
                document.getElementById("comingeventsH1").setAttribute('style', 'display:normal;');
                document.getElementById("comingactivitiesH1").setAttribute('style', 'display:none;');
            } else {
                document.getElementById("comingeventsH1").setAttribute('style', 'display:none;');
                document.getElementById("comingactivitiesH1").setAttribute('style', 'display:normal;');
            }
            DisplayComingEventsList(GetEvents())
        }

        ////////////////////////////////////////////////////////////////////////////////////////
        // GetEvents gets the events and returns them, based on the activities parameter in the url
        function GetEvents() {
            if (localStorage.getItem("eventtype") == "events") {
                return localStorage.getItem("comingevents");  //display stored data in case we can't successfully reload the comingevents cache
            } else {
                return localStorage.getItem("comingactivities");  //display stored data in case we can't successfully reload the comingevents cache\
            }
        }

        function ShowOtherCalendars() {
            document.getElementById("othercalendars").setAttribute("style", "display:normal");
        }

        ///////////////////////////////////////////////////////////////////////////////////////////////
        // DisplayComingEventsList - display the events in the CE string, which is a copy of the comingevents txt file
        //  or the 'ACTIVITIES' section of the comingevents text file. These are cached in the 'comingevents' 
        // or 'comingactivities' localStorage items. 
        // CE is a single big string containing multiple lines, so we split the string by \n.
        function DisplayComingEventsList(CE) {
            var i;
            var row;
            var col;
            var idayofweek; // 0-6
            var lastdayofweek = 100; // 0-6 of previous row
            var previouseventdate; // date of previous event
            var datefmt; // formatted date
            var table // ref to table
            table = document.getElementById("comingeventstable");
            localStorage.setItem("tabletoclear", "comingeventstable");
            var iCE; // iterator through CE
            iCE = 0;
            var aCE; // CE split array 
            if (CE == null) return;
            CE = CE.split("\n");  // break it up into rows
            if (CE == "") return;
            clearTable(table); // clear table
            table.deleteRow(-1);
            // add a new week header
            row = table.insertRow(-1);
            row.style.border = "solid thin gray";
            row.style.backgroundColor = "lightblue";
            row.style.fontWeight = "bold";
            col = row.insertCell(0); col.innerHTML = "Day";
            col = row.insertCell(1); col.innerHTML = "";
            col = row.insertCell(2); col.innerHTML = "Time";
            col = row.insertCell(3); col.innerHTML = "";
            col = row.insertCell(4); col.innerHTML = "";
            col = row.insertCell(5); col.innerHTML = "Event";
            col = row.insertCell(6); col.innerHTML = "Location";
            col = row.insertCell(7); col.innerHTML = "Sponsor";
            col = row.insertCell(8); col.innerHTML = "More...";
            // calculate end month day. 6 for events, 1 for activities.
            var endmmdd;
            if (localStorage.getItem("eventtype") == "events") endmmdd = (month + 6) * 100 + dayofmonth;
            else endmmdd = (month + 1) * 100 + dayofmonth;

            // roll through the CE array
            for (iCE = 0; iCE < CE.length; iCE++) {
                aCE = CE[iCE].split(';');  // split the string
                //  advance schedule date to today
                var dateCE = Number(aCE[0]); // mmdd
                if (dateCE > endmmdd) return; // past one month
                if (dateCE < monthday) continue; // if before today
                if (dateCE == monthday && Number(aCE[2]) < (timehhmm + 10)) continue; // end time not reached.
                // found it
                datefmt = aCE[0].substring(0, 2) + "/" + aCE[0].substring(2, 4);

                var dd = new Date(datefmt + "/" + year); // wont work for next year
                idayofweek = dd.getDay();

                // add a row for new week. won't work if schedule days are both same day of week
                if (idayofweek < lastdayofweek) {
                    row = table.insertRow(-1);
                    row.style.backgroundColor = "azure";
                    // test for this week
                    if ((idayofweek >= dayofweek) && ((dateCE - monthday) <= 6)) {
                        row.insertCell(0).innerHTML = "This";
                        row.insertCell(1).innerHTML = "";
                        row.insertCell(2).innerHTML = "Week";
                    } else {
                        row.insertCell(0).innerHTML = "&nbsp";
                        row.insertCell(1).innerHTML = "";
                        row.insertCell(2).innerHTML = "&nbsp";
                    }
                    for (i = 3; i < 9; i++) {
                        row.insertCell(i).innerHTML = "&nbsp";
                    }
                }

                // add a new table row
                row = table.insertRow(-1);
                row.style.border = "thin solid gray";//
                if (dateCE == monthday && Number(aCE[2]) > (timehhmm + 10)) row.style.fontWeight = "bold"; // end time not reached.
                col = row.insertCell(0);
                if (aCE[0] != previouseventdate) col.innerHTML = dayofweekshort[idayofweek] + " " + datefmt; // day of week
                else col.innerHTML = "";
                col = row.insertCell(1);
                //if (aCE[0] != previouseventdate)  col.innerHTML = datefmt; // date
                //else col.innerHTML = "";
                //if ((iCE<CE.length-1) && (aCE[0] == CE[iCE + 1].substring(0, 4))) row.style.border = "solid thin lightgray";


                col = row.insertCell(2);
                col.innerHTML = VeryShortTime(aCE[1]) + "-" + VeryShortTime(aCE[2]); // compressed time
                //col.innerHTML = ShortTime(aCE[1]);  // start
                //col.style.textAlign = "right";
                col = row.insertCell(3);
                //col.innerHTML = ShortTime(aCE[2]); // end
                //col.style.textAlign = "right";
                col = row.insertCell(4);
                //col.innerHTML = aCE[3];//type
                //col.style.textAlign = "center";
                col = row.insertCell(5); col.innerHTML = aCE[4];//event
                col = row.insertCell(6); col.innerHTML = aCE[5];//where
                col = row.insertCell(7);
                if (aCE.length >= 7) col.innerHTML = aCE[6]; // sponsor
                else col.innerHTML = "";
                col = row.insertCell(8);
                if (aCE.length >= 8) col.innerHTML = aCE[7];
                else col.innerHTML = ""; // more
                lastdayofweek = idayofweek;
                previouseventdate = aCE[0];
            } // end loop through CE
        }

        ///////////////////////////////////////////////////////////////////////////////////////////////
        // DisplayComingWeek - display the events in the CE structure in a 1 week form
        // CE = string of events, \n separated.
        function DisplayComingWeek(CE) {

            var i, h;
            var row;
            var col;
            var datefmt; // formatted date
            var table // ref to table
            table = document.getElementById("comingeventstable");
            var iCE; // iterator through CE
            iCE = 0;
            var aCE; // CE split array 
            var CE;

            if (CE == null) return;
            CE = CE.split("\n");  // break it up into rows


            // build table
            clearTable(table);
            table.deleteRow(-1);
            // add a new week header
            row = table.insertRow(-1);
            row.style.border = "solid thin gray";
            row.style.border.width = 1;
            row.style.backgroundColor = "lightblue";
            row.style.fontWeight = "bold";
            col = row.insertCell(0); col.innerHTML = ""; col.style.width = "5%"; //
            col = row.insertCell(1); col.innerHTML = "Sun"; col.style.width = "13%"// 
            col = row.insertCell(2); col.innerHTML = "Mon"; col.style.width = "13%"  // 
            col = row.insertCell(3); col.innerHTML = "Tue"; col.style.width = "13%" // 
            col = row.insertCell(4); col.innerHTML = "Wed"; col.style.width = "13%"//
            col = row.insertCell(5); col.innerHTML = "Thur"; col.style.width = "13%"//
            col = row.insertCell(6); col.innerHTML = "Fri"; col.style.width = "13%"
            col = row.insertCell(7); col.innerHTML = "Sat"; col.style.width = "13%"

            // build the week table with all rows and columns
            for (h = 7; h < 23; h++) {
                row = table.insertRow(-1);
                //row.style.border = "thin solid blue";
                col = row.insertCell(0);
                // time row
                if (h < 13) col.innerHTML = h + 'am';
                else col.innerHTML = (h - 12) + 'pm';
                if (timehh == h) col.style.backgroundColor = "pink";
                else col.style.backgroundColor = "azure";
                col.style.border = "thin solid lightblue";
                // day rows
                for (i = 1; i < 8; i++) {
                    col = row.insertCell(i);
                    var id = h.toFixed(0) + i.toFixed(0)
                    col.setAttribute("id", id);
                    col.innerHTML = "";
                    if (i == (dayofweek + 1)) col.style.backgroundColor = "yellow";  // make today yellow
                    col.style.border = "thin solid lightblue";
                }
            }

            // roll through the CE array for 7 days
            for (iCE = 0; iCE < CE.length; iCE++) {
                aCE = CE[iCE].split(';');  // split the string
                // FOLLOWING FAILS AT MONTH BOUNDARIES FIX IT
                startmmdd = monthday - dayofweek; // startmmdd = sunday
                endmmdd = startmmdd + 6;  // end day
                //  advance schedule date to today
                var dateCE = Number(aCE[0]); // mmdd
                if (dateCE > endmmdd) break; // past one week
                if (dateCE < startmmdd) continue; // if before today
                // found it calculate cell;
                hourCE = Math.floor(Number(aCE[1]) / 100);
                datefmt = aCE[0].substring(0, 2) + "/" + aCE[0].substring(2, 4);
                var dd = new Date(datefmt + "/" + year); // wont work for next year
                idayofweek = dd.getDay();

                // add to entry
                var e = "";
                if (aCE[1].substring(2, 4) != "00") e = ShortTime(aCE[1]) + " "; // add time if not one the hour
                e += aCE[4];
                var id = hourCE.toFixed(0) + (idayofweek + 1).toFixed(0);
                var c = document.getElementById(id);
                if (hourCE < 23) c.innerHTML += e + "<br/>";
            } // end for
        } // end function

        ///////////////////////////////////////////////////////////////////////////////////////////////
        // DisplayComingMonth - display the events in the CE structure in a 1 month form
        // CE = string of events, \n separated.
        function DisplayComingMonth(CE) {
            var daysinmonth = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            var i, w;
            var row;
            var col;
            var datefmt; // formatted date
            var table // ref to table
            table = document.getElementById("comingeventstable");
            var iCE; // iterator through CE
            iCE = 0;
            var aCE; // CE split array 
            var CE;

            if (CE == null) return;
            CE = CE.split("\n");  // break it up into rows

            if (year % 4 == 0) daysinmonth[2] = 29; // leap year
            // compute starting date
            var dd = dayofmonth - dayofweek; // starting dayy of the month
            var mm = month;
            if (dd <= 0) { mm--; dd = daysinmonth[mm] + dd; } // if we had to back of
            var startmmdd = mm * 100 + dd;

            // build table
            clearTable(table);
            table.deleteRow(-1);
            // add a new week header
            row = table.insertRow(-1);
            row.style.border = "solid thin gray";
            row.style.border.width = 1;
            row.style.backgroundColor = "lightblue";
            row.style.fontWeight = "bold";
            col = row.insertCell(0); col.innerHTML = "Sun"; col.style.width = "14%"// 
            col = row.insertCell(1); col.innerHTML = "Mon"; col.style.width = "14%"  // 
            col = row.insertCell(2); col.innerHTML = "Tue"; col.style.width = "14%" // 
            col = row.insertCell(3); col.innerHTML = "Wed"; col.style.width = "14%"//
            col = row.insertCell(4); col.innerHTML = "Thur"; col.style.width = "14%"//
            col = row.insertCell(5); col.innerHTML = "Fri"; col.style.width = "14%"
            col = row.insertCell(6); col.innerHTML = "Sat"; col.style.width = "14%"
            ;

            // build the month table with all rows and columns
            for (w = 1; w < 9; w++) {
                var rowN = table.insertRow(-1);
                row = table.insertRow(-1);
                //row.style.border = "thin solid blue";
                // day rows with date
                for (i = 0; i < 7; i++) {
                    // cell with date
                    col = rowN.insertCell(i);
                    if (dd == 1) col.innerHTML = (mm).toFixed(0) + "/" + (dd).toFixed(0);
                    else col.innerHTML = (dd).toFixed(0);
                    if (dayofmonth == dd && month == mm) col.style.backgroundColor = "yellow";
                    else col.style.backgroundColor = "azure";
                    col.style.border = "thin solid lightblue";
                    // cell that will hold the events
                    col = row.insertCell(i);
                    col.innerHTML = "&nbsp";
                    col.style.border = "thin solid lightblue";
                    var id = Leading0(mm) + Leading0(dd);
                    col.setAttribute("id", id);
                    if (dayofmonth == (dd) && month == mm) col.style.backgroundColor = "lightyellow";  // make today yellow
                    endmmdd = mm * 100 + dd;
                    // bump dd and allow for next month
                    dd++;
                    if (dd > daysinmonth[mm]) { dd = 1; mm++ }
                }
            }

            // roll through the CE array for the month days
            for (iCE = 0; iCE < CE.length; iCE++) {
                aCE = CE[iCE].split(';');  // split the string
                //  advance schedule date to today
                var dateCE = Number(aCE[0]); // mmdd
                if (dateCE > endmmdd) break; // past end of mothb
                if (dateCE < startmmdd) continue; // if before start of month
                // found it calculate cell;
                hourCE = Math.floor(Number(aCE[1]) / 100);
                datefmt = aCE[0].substring(0, 2) + "/" + aCE[0].substring(2, 4);

                // add to entry
                var e;
                e = "<span style:'font-weight:bold'>" + VeryShortTime(aCE[1]) + "</span> " + aCE[4];// add time 
                var id = aCE[0];
                var c = document.getElementById(id);
                c.innerHTML += e + "<br/>";
            } // end for
        } // end function

    </script>

    <script>
 //===== TIDES =======================================================================================
        
        //////////////////////////////////////////////////////////////////////////////////////////////////
        // TidesDataPage
        function TidesDataPage() {
            InitializeDates(0);
            ShowPage("tidespage");
            // show the tide data in the jsontides global
            var periods = JSON.parse(localStorage.getItem("jsontides"));
            ShowTideDataPage(periods, true );
        }

        ////////////////////////////////////////////////////////////////////////////////////////////////////////////
        // ShowTideData - show the data in the periods array
        //  entry periods = array of data returned by aeris. Each array entry is one tide period.
        //        showcurrent = true to show current tides, else false
        function ShowTideDataPage(periods, showcurrent) {

            var table = document.getElementById("tidestable");
            localStorage.setItem("tabletoclear", "tidestable");
            clearTable(table);
            olddate = periods[0].dateTimeISO.substring(5, 10);
            var oldtide = -1;
            var i;
            // roll through the reply in jason.response.periods[i]
            for (i = 0; i < periods.length; i++) {
                // if date changed, add a blank row
                newdate = periods[i].dateTimeISO.substring(5, 10);
                if (newdate != olddate) {
                    var row1; row1 = table.insertRow(-1);
                    var row1col1; row1.insertCell(0).innerHTML = " ";
                    row1.insertCell(1).innerHTML = " ";
                    row1.insertCell(2).innerHTML = " ";
                    row1.insertCell(3).innerHTML = " ";
                    olddate = newdate;
                }
                // Insert New Row for table at end of table.

                var row1 = table.insertRow(-1);

                // Insert New Column for date
                var row1col1 = row1.insertCell(0);
                var m = Number(periods[i].dateTimeISO.substring(5, 7));
                var d = Number(periods[i].dateTimeISO.substring(8, 10));
                row1col1.innerHTML = m + "/" + d + '&nbsp';
                row1col1.style.border = "thin solid gray";
                // time
                row1col1 = row1.insertCell(1);
                var h = Number(periods[i].dateTimeISO.substring(11, 13)); // tide hour
                var mi = Number(periods[i].dateTimeISO.substring(14, 16));  // time min
                tidehhmm = (Number(h) * 100) + Number(mi);
                row1col1.innerHTML = "&nbsp" + ShortTime(tidehhmm);
                row1col1.style.border = "thin solid gray";
                if (periods[i].type == 'h') hilow = '&nbspHigh';
                else hilow = '&nbspLow';

                // if tide is past, color row gray and show current tide info
                if (showcurrent) {
                    if ((month > m) || (month == m && dayofmonth > d) || (month == m && dayofmonth == d && (timehhmm > tidehhmm))) {
                        row1.style.color = "gray";
                        if (periods[i].type == 'h') currentTide = "Outgoing since ";  // incoming outgoing flag
                        else currentTide = "Incoming since ";
                        currentTide += ShortTime(tidehhmm) + " (duration: " + timeDiff(tidehhmm, timehhmm) + ")";
                        oldtideheight = Number(periods[i].heightFT);
                        oldtidetime = tidehhmm;
                        oldtide = 0;
                    } else if ((oldtide < 1)) {

                        // this is the next tide, bold it and calculate approx height                             
                        row1.style.fontWeight = "bold";
                        oldtide = 1;
                        // calculate current tide height
                        var tideheight = CalculateCurrentTideHeight(tidehhmm, oldtidetime, Number(periods[i].heightFT), oldtideheight);
                        currentTide += "<br/>Approximate height: " + tideheight.toFixed(1) + " ft.";
                        // calculate time till next tide                                 
                        currentTide += "<br/>" + hilow + " tide will be " + periods[i].heightFT + " ft. at " + ShortTime(tidehhmm) + " (in " + timeDiff(timehhmm, tidehhmm) + ")";
                        nextTides = "Tides: " + hilow + " " + periods[i].heightFT + " ft. at " + ShortTime(tidehhmm) + ";";
                    } else if (oldtide == 1) {  // save next tide
                        oldtide = 2;
                        nextTides += hilow + " " + periods[i].heightFT + " ft. at " + ShortTime(tidehhmm) + ";";
                        localStorage.setItem("nextTides", nextTides); // save tide
                    }
                }

                // type
                row1col1 = row1.insertCell(2);
                row1col1.innerHTML = hilow;
                row1col1.style.border = "thin solid gray";
                // height
                row1col1 = row1.insertCell(3);
                row1col1.innerHTML = periods[i].heightFT;
                row1col1.style.border = "thin solid gray";
            }
            // now save the current tide
            document.getElementById("tidepagecurrent").innerHTML = "Current tide is: " + currentTide;
            $("#tideButton").show();
         }


        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        // ShowCustom - get date for custom tides, call the aeris query, and display the result.
        //
        function ShowCustom() {
            InitializeDates(0);
            var tidedate = prompt("Please enter the date as mm/dd", month + "/" + dayofmonth);
            if (tidedate == null) return;
            // validate the date
            var tda = tidedate.split("/");
            if (tda.length != 2) {
                alert("Invalid date. An example of a valid date is: 1/22");
                return;
            }
            var m = Number(tda[0]); // month
            var d = Number(tda[1]);  // day
            if (isNaN(m) || isNaN(d) || (m < 1) || (m > 12) || (d < 1) || (d > 31)) {
                alert("Invalid date. An example of a valid date is: 1/22");
                return;
            }
            // get new data
            tidedate = tidedate + "/" + year;
            getCustomTideData(tidedate);

        }

        /////////////////////////////////////////////////////////////////////////////////////////////
        // getCustomTideData get tide data using the aeris api and returning a jsonp structure. This is the only way to get data from a different web site.
        // used only for custom date queries, not for normal tides.
        // License as of 2/8/16 is for 750 hits/day for free.
        //  fromdate = optional starting date for the tides
        //  data is used to display tide data. It is not stored.
        function getCustomTideData(fromdate) {
            var olddate, newdate; // dates
            var ampm; // am or pm
            var oldtide = -1; // true for tides older than current time
            var oldtideheight, oldtidetime; // saved tide hight for last tide
            var hilow;
            var nextTides;
            $("#tideButton").hide();  // hide the user button
            $.ajax({
                url: 'http://api.aerisapi.com/tides/9446705?client_id=U7kp3Zwthe8dc19cZkFUz&client_secret=4fHoJYS6m9T7SERu7kkp7iVwE0dewJo5zVF38tfW&from=' + fromdate + '&to=+48hours',
                dataType: 'jsonp',
                success: function (json) {

                    if (json.success == true) {
                        ShowTideDataPage(json.response.periods, false);
                    }
                    else {
                        document.getElementById("tidepagecurrent").innerHTML = "Tides not available." + json.error.description;
                        //alert('Could not retrieve tide information: ' + json.error.description);
                    }
                }
            });
        }
        /////////////////////////////////////////////////////////////////////////////////////
        // ShowNOAA - query NOAA for the tide page
        function ShowNOAA() {
            InitializeDates(0);
            window.open("http://opendap.co-ops.nos.noaa.gov/axis/webservices/highlowtidepred/response.jsp?stationId=9446705&beginDate=" + year + month + dayofmonth + "&endDate=" + year + month + dayofmonth + "&datum=MLLW&unit=0&timeZone=0&format=html&Submit=Submit")
        }

     </script>
    <script>
//====EMERGENCY=====================================================================================

        //////////////////////////////////////////////////////////////////////////////////////
        // ShowEmergency
        function ShowEmergencyPage() {
            ShowPage("emergencypage");
            document.getElementById("emergencytable").innerHTML = localStorage.getItem("emergency");
        }
    </script>

    <script>
//====WEATHER=====================================================================================
        // Weather
        function ShowWeatherPage() {
            ShowPage("weatherpage");
            InitializeDates(0);
            document.getElementById("currentweatherpage").innerHTML = localStorage.getItem("currentweatherlong");
            getWeatherForecastPage("today");
        }
        /////////////////////////////////////////////////////////////////////////////////////////////
        // get weather data using the AERIS  api and returning a jsonp structure. This is the only way to get data from a different web site.
        // License as of 2/8/16 is for 750 hits/day for free.
        //  fromdate = optional starting date for the weather.  Deprecated 2/26/16.
        //function getWeatherForecastPageAERIS(fromdate) {
        //    var olddate, newdate; // dates
        //    var ampm; // am or pm
        //    var currentTemp;

        //    //$("#tideButton").hide();  // hide the user button

        //    $.ajax({
        //        // url: 'http://api.aerisapi.com/forecasts/98303?client_id=U7kp3Zwthe8dc19cZkFUz&client_secret=4fHoJYS6m9T7SERu7kkp7iVwE0dewJo5zVF38tfW',
        //        url: 'http://api.aerisapi.com/forecasts/98303?filter=daynight&client_id=U7kp3Zwthe8dc19cZkFUz&client_secret=4fHoJYS6m9T7SERu7kkp7iVwE0dewJo5zVF38tfW',
        //        dataType: 'jsonp',
        //        success: function (json) {

        //            if (json.success == true) {

        //                //debug - display the return
        //                //alert("json success");
        //                //var output;
        //                //output = JSON.stringify(json);
        //                //alert(output);
        //                // document.getElementById("forecast").innerHTML = output;

        //                var resp = json.response[0].periods;
        //                var mydayofweek = dayofweek;
        //                var firstrow = true;  // true for first row
        //                // roll through the reply in jason.response.periods[i]
        //                var table = document.getElementById("forecasttable");
        //                clearTable(table);
        //                for (var i = 0; i < resp.length; i++) {
        //                    // if date changed, add a blank row
        //                    var r = resp[i];

        //                    // Insert New Row for table at end of table.
        //                    var row1 = table.insertRow(-1);
        //                    if (r.isDay) row1.style.backgroundColor = "lightyellow";
        //                    else row1.style.backgroundColor = "lightgray";

        //                    // Insert New Column for date
        //                    var row1col1 = row1.insertCell(0);
        //                    //var m = r.dateTimeISO.substring(5, 7);
        //                    //var d = r.dateTimeISO.substring(8, 10);
        //                    //row1col1.innerHTML = m + "/" + d + '&nbsp';
        //                    if (r.isDay || firstrow) row1col1.innerHTML = dayofweekname[mydayofweek].substring(0, 3);
        //                    firstrow = false;
        //                    row1col1.style.border = "thin solid gray";
        //                    // high
        //                    row1col1 = row1.insertCell(1);
        //                    if (r.maxTempF != null) row1col1.innerHTML = r.maxTempF + "&deg";
        //                    row1col1.style.border = "thin solid gray";
        //                    // low
        //                    row1col1 = row1.insertCell(2);
        //                    if (r.minTempF != null) row1col1.innerHTML = r.minTempF + "&deg";
        //                    row1col1.style.border = "thin solid gray";
        //                    // weather
        //                    row1col1 = row1.insertCell(3);
        //                    row1col1.innerHTML = r.weather;
        //                    row1col1.style.border = "thin solid gray";
        //                    // rain
        //                    row1col1 = row1.insertCell(4);
        //                    row1col1.innerHTML = r.pop + "% &nbsp" + r.precipIN + " in.";
        //                    row1col1.style.border = "thin solid gray";
        //                    // wind
        //                    row1col1 = row1.insertCell(5);
        //                    row1col1.innerHTML = r.windDir + " " + r.windSpeedMPH + " mph";
        //                    row1col1.style.border = "thin solid gray";

        //                    // bump day if we just did a night
        //                    if (r.isDay == false) {
        //                        mydayofweek++; if (mydayofweek > 6) mydayofweek = 0;
        //                    }
        //                }  // for end
        //                document.getElementById("forecastpage").innerHTML = "Data from " + FormatTime(timehhmm) + " and does not automatically refresh.";
        //            }
        //            else {
        //                //alert('An error occurred: ' + json.error.description);
        //                document.getElementById("forecastpage").innerHTML = "Forecast Unavailable." + json.error.description;
        //            }
        //        }
        //    });  // end of ajax call
        //}  // end of function

        /////////////////////////////////////////////////////////////////////////////////////////////
        // get weather data using the OpenWeatherMap api and returning a jsonp structure. This is the only way to get data from a different web site.
        // License as of 2/25/16 is for 60 hits/minute for free.
        //  fromdate = optional starting date for the weather
        function getWeatherForecastPage(fromdate) {
            var olddate, newdate; // dates
            var ampm; // am or pm
            var currentTemp;

            //$("#tideButton").hide();  // hide the user button

            $.ajax({
                url: 'http://api.openweathermap.org/data/2.5/forecast?id=5812092&units=imperial&APPID=f0047017839b75ed3d166440bef52bb0',
                dataType: 'jsonp',
                success: function (json) {
                    //var r = json.list[0];
                    //var forecast = "Forecast: " + StripDecimal(r.main.temp_max) + "&deg/" + StripDecimal(r.main.temp_min) + "&deg, " +
                     //   r.weather[0].description + ", " + DegToCompassPoints(r.wind.deg) + " " + StripDecimal(r.wind.speed) + " mph ";
                        var resp = json.list;
                        var mydayofweek = dayofweek;
                        var firstrow = true;  // true for first row
                        var olddate = "";
                        // roll through the reply in jason.list[i]
                        var table = document.getElementById("forecasttable");
                        // don't clear the table so it is there in case we don't have network coverage for a new forecast
                        clearTable(table);
                        for (var i = 0; i < resp.length; i++) {
                            // if date changed, add a blank row
                            var r = resp[i];

                            // Insert New Row for table for new day 
                            var row1 = table.insertRow(-1);
                            var newdate = r.dt_txt.substring(5, 11);// date
                            if (newdate != olddate) {
                                row1 = table.insertRow(-1); // dummy row
                                row1col1 = row1.insertCell(0); row1.insertCell(1); row1.insertCell(2); row1.insertCell(3); row1.insertCell(4);
                                var dow = GetDayofWeek(newdate.substring(0, 2) + newdate.substring(3, 5));
                                row1col1.innerHTML = dayofweekshort[dow] + " " + newdate;
                                olddate = newdate;
                            }
                            var row1 = table.insertRow(-1);
                            var t = r.dt_txt.substring(11, 13) * 100;  // hh00
                            if ((t < 900) || (t > 1800)) row1.style.backgroundColor = "lightgray";
                            else row1.style.backgroundColor = "lightyellow";

                            // Insert New Column for time
                            var row1col1 = row1.insertCell(0);
                            row1col1.innerHTML = "&nbsp&nbsp&nbsp" + VeryShortTime(t);  // time
                            firstrow = false;
                            row1col1.style.border = "thin solid gray";
                            // high/low
                            row1col1 = row1.insertCell(1);
                            row1col1.innerHTML = StripDecimal(r.main.temp_max) + "&deg";
                            row1col1.style.border = "thin solid gray";
                            // weather
                            row1col1 = row1.insertCell(2);
                            row1col1.innerHTML = r.weather[0].description;
                            row1col1.style.border = "thin solid gray";
                            // rain
                            row1col1 = row1.insertCell(3);
                            var rain;
                            if (typeof r.rain == 'undefined' || typeof r.rain["3h"]== 'undefined') rain = "0";
                            else rain = (Number(r.rain["3h"]) / 25.4).toFixed(2);
                            row1col1.innerHTML = rain;
                            row1col1.style.border = "thin solid gray";
                            // wind
                            row1col1 = row1.insertCell(4);
                            row1col1.innerHTML = DegToCompassPoints(r.wind.deg) + " " + StripDecimal(r.wind.speed);
                            row1col1.style.border = "thin solid gray";

                            //// bump day if we just did a night
                            //if (r.isDay == false) {
                            //    mydayofweek++; if (mydayofweek > 6) mydayofweek = 0;
                            //}
                        }  // for end
                        document.getElementById("forecastpage").innerHTML = "Data from " + FormatTime(timehhmm) + " and does not automatically refresh.";
                    }
                
            });  // end of ajax call
        }  // end of function
        /////////////////////////////////////////////////////////////////////////////////////////////
        // get current weather observation data using the aeris api and returning a jsonp structure. This is the only way to get data from a different web site.
        //for documentation see: http://www.aerisweather.com/support/docs/api/reference/endpoints/observations/
        // License as of 2/8/16 is for 750 hits/day for free.
        //function getCurrentWeatherPage() {
        //    $.ajax({
        //        url: 'http://api.aerisapi.com/observations/98303?client_id=U7kp3Zwthe8dc19cZkFUz&client_secret=4fHoJYS6m9T7SERu7kkp7iVwE0dewJo5zVF38tfW',
        //        dataType: 'jsonp',
        //        success: function (json) {
        //            if (json.success == true) {
        //                // pick out the return variables
        //                var r = json.response.ob;
        //                var current = "Currently " + r.weather + ", " + r.tempF + "&degF, " + r.humidity + "% RH, wind " + r.windDir + " " + r.windMPH + " mph " +
        //                    ", " + r.precipIN + " in. rain, " +
        //                    "<br/>Sunrise at " + r.sunriseISO.substring(11, 19) + ", Sunset at " + r.sunsetISO.substring(11, 19);
        //                //document.getElementById("forecast").innerHTML = current;
        //                $("#currentweatherpage").html(current); // jquery equivalent. Is this really easier?
        //            }
        //            else {
        //                //alert('An error occurred: ' + json.error.description);
        //                $("#currentweatherpage").html("Current weather is unavailable. " + json.error.description);
        //            }
        //        }
        //    });
        //}

    </script>

    <script>
 //====ABOUT=========================================================================================

    // FERRY WEB CAM
        function ShowFerryWebCam() {
            ShowPage("ferrywebcampage");
            document.getElementById("steilacoomcam").setAttribute("src", "http://online.co.pierce.wa.us/xml/abtus/ourorg/PWU/Ferry/Steilacoom.jpg?random" + timehhmm.toFixed(0));
            document.getElementById("aicam").setAttribute("src", "http://online.co.pierce.wa.us/xml/abtus/ourorg/PWU/Ferry/AndersonIsland.jpg?random" + timehhmm.toFixed(0));
        }

//====ABOUT=========================================================================================
        /////////////////////////////////////////////////////////////////////////////////////
        // About
        function ShowAboutPage() {
            ShowPage("aboutpage");
        }

//====LINKS=========================================================================================
        /////////////////////////////////////////////////////////////////////////////////////
        // About
        function ShowLinksPage() {
            ShowPage("linkspage");
        }
    </script>

    <!-- actual javascript execution begins here:-->
    <script type="text/javascript">
 //======================================================================================================
        /////////////////////////////////////////////////////////////////////////////////////////////////
        //  MAIN APP CODE
        //
        var cacheReloadEvery = 720; // minutes

        app.initialize();
        localStorage.setItem("displaypage", "mainpage");
        InitializeDates(0);
        document.getElementById("updatetime").innerHTML = "Screen updated at " + FormatTime(timehhmm);
        updateMinutes = 1;
        localStorage.setItem("updateminutes", "1"); // start at 1 so the 1st timer call does not run stuff, but the focus event does
        forceCacheReload = false; // cache reload not needed
        forceTideReload = false; 

        //  Show the cached data
        ShowCachedData();

        //reload the 'dailycache' cache + coming events + tides + forecast if the day has changed or > 3 hour.
        getCurrentWeather(); // gets weather async every 20 min.
        getForecast(); // updates forecast every 2 hrs

        var reloadreason = "";
        var dailycacheloaded = localStorage.getItem("dailycacheloaded");
        if (dailycacheloaded == null) {
            forceCacheReload = true;
            reloadreason = "initial cache load";
        } else if (Number(dailycacheloaded) != monthday) {
            reloadreason = "dailycacheloaded != monthday";
            forceCacheReload = true;
        }
        if (forceCacheReload)
        {
            document.getElementById("reloadreason").innerHTML = reloadreason;
            ReloadCachedData();
        }

        // tide reload every day
         getTideData();


        // set refresh timners
        setInterval("timerUp()", 60000);  // timeout in milliseconds. currently 60 seconds
        window.addEventListener("focus", focusEvent);
        window.addEventListener("blur", blurEvent);
        DisplayLoadTimes();


    </script>
</body>
</html>

