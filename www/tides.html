<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
     <meta name="format-detection" content="telephone=no" />
     <meta name="msapplication-tap-highlight" content="no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
     <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=medium-dpi" />
     <link rel="stylesheet" type="text/css" href="css/index.css" />
     <title>Tides</title>
     <style>
            button {font-size: 12px;}
            p {font-size:12px;}
      </style>
</head>
<body>
    <div class="app">
<h1>Tides at Yoman Point <br />(ferry dock)</h1>
    <p id="current">Please wait for tide data .... </p>
    <div id="divTable">
    
    </div>
    <hr />
    <p id="demo">
    <button id="tideButton" onclick="ShowCustom();" hidden="hidden">Get Tides for other days</button>
    </p>

     <p>These tide predictions are provided for 
         <a href="http://opendap.co-ops.nos.noaa.gov/axis/webservices/highlowtidepred/">station id 9446705 by NOAA</a>  through Aeris. 
         Approximate current height calculated using <a href="https://en.wikipedia.org/wiki/Rule_of_twelfths"> Rule of Twelves.</a></p>
     </div>

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript" src="js/AIA.js"></script>
    <script type="text/javascript">

        var currentTide;  // incoming or outgoing


        /////////////////////////////////////////////////////////////////////////////////////////
        // create the ferry schedule table
        //  creates the global 'table'
        function createTable() {
            // Create table.
            table = document.createElement('table');
            table.style.border = "thin solid black";
            table.style.borderCollapse = "collapse";
            // Insert New Row for table at index '0'.
            var row1; row1 = table.insertRow(0);
            // Insert New Column for Row1 at index '0'.
            var row1col1 = row1.insertCell(0);
            row1col1.style.backgroundColor = "black";
            row1col1.style.color = "white";
            row1col1.innerHTML = 'Date';
            // Insert New Column for Row1 at index '1'.
            row1col1 = row1.insertCell(1);
            row1col1.style.backgroundColor = "black";
            row1col1.style.color = "white";
            row1col1.innerHTML = '| Time&nbsp';
            row1col1 = row1.insertCell(2);
            row1col1.style.backgroundColor = "black";
            row1col1.style.color = "white";
            row1col1.innerHTML = '| Type&nbsp';
            row1col1 = row1.insertCell(3);
            row1col1.style.backgroundColor = "black";
            row1col1.style.color = "white";
            row1col1.innerHTML = '| Feet&nbsp';
        }

        ////////////////////////////////////////////////////////////////////////////////////////////////////////
        // Calculate current tide height using the rule of 12s (tide rise in hour: 1/12, 2/12, 3/12, 3/12, 2/12, 1/12
        function CalculateCurrentTideHeight(newtidetime, oldtidetime, newtideheight, oldtideheight) {
            // calculate current tide height
            var tideheight;
            var timedelta; timedelta = RawTimeDiff(oldtidetime, newtidetime);
            var tidedelta, tideheight;
            var tidedelta = newtideheight - oldtideheight; // new tide - old tide; + for rising; - for falling
            var currenttimedelta; currenttimedelta = RawTimeDiff(oldtidetime, timehhmm); // elapsed time since last low or high tide
            var timedelta6; timedelta6 = timedelta / 6; //minutes in current tide pseudo hour a little over 60. newtidetime - oldtidetime / 60.
            var tidedelta12; tidedelta12 = tidedelta / 12;
            var currenttimeremainder; currenttimeremainder = (currenttimedelta % timedelta6) / timedelta6; // faction of current pseudo hour
            // this code adds the tidedelta to the old tide in the ratio of :1/12, 2/12, 3/12, 3/12, 2/12, 1/12 . 
            if (currenttimedelta <= timedelta6) tideheight = oldtideheight + (tidedelta12 * currenttimeremainder);
            else if (currenttimedelta <= timedelta6 * 2) tideheight = oldtideheight + tidedelta12 + (tidedelta12 * 2 * currenttimeremainder);
            else if (currenttimedelta <= timedelta6 * 3) tideheight = oldtideheight + tidedelta12 * 3 + (tidedelta12 * 3 * currenttimeremainder);
            else if (currenttimedelta <= timedelta6 * 4) tideheight = oldtideheight + tidedelta12 * 6 + (tidedelta12 * 3 * currenttimeremainder);
            else if (currenttimedelta <= timedelta6 * 5) tideheight = oldtideheight + tidedelta12 * 9 + (tidedelta12 * 2 * currenttimeremainder);
            else tideheight = oldtideheight + tidedelta12 * 11 + (tidedelta12 * currenttimeremainder);
            return tideheight;
        }

        /////////////////////////////////////////////////////////////////////////////////////////////
        // get tide data using the aeris api and returning a jsonp structure. This is the only way to get data from a different web site.
        // License as of 2/8/16 is for 750 hits/day for free.
        //  fromdate = optional starting date for the tides
        function getTideData(fromdate) {
 
 
            var olddate, newdate; // dates
            var ampm; // am or pm
            var oldtide = -1; // true for tides older than current time
            var oldtideheight; // saved tide hight for last tide
            var hilow;
            var nextTides;
            $("#tideButton").hide();  // hide the user button
            $.ajax({
                url: 'http://api.aerisapi.com/tides/9446705?client_id=U7kp3Zwthe8dc19cZkFUz&client_secret=4fHoJYS6m9T7SERu7kkp7iVwE0dewJo5zVF38tfW&from=' + fromdate + '&to=+48hours',
                dataType: 'jsonp',
                success: function (json) {
                    
                    if (json.success == true) {

                        //debug - display the return
                        // alert("json success");
                       //var output;
                        //output = JSON.stringify(json);
                        //alert(output);
                        olddate = json.response.periods[0].dateTimeISO.substring(5, 10);

                        // roll through the reply in jason.response.periods[i]
                        var i;
                        for (i = 0; i < json.response.periods.length; i++) {
                            // if date changed, add a blank row
                             newdate = json.response.periods[i].dateTimeISO.substring(5, 10);
                             if (newdate != olddate) {
                                 var row1; row1 = table.insertRow(-1);
                                 var row1col1; row1.insertCell(0).innerHTML = " ";
                                 row1.insertCell(1).innerHTML = " ";
                                 row1.insertCell(2).innerHTML = " ";
                                 row1.insertCell(3).innerHTML = " ";
                                 olddate = newdate;
                            }
                           // Insert New Row for table at end of table.
                            var row1 = table.insertRow(-1);

                            // Insert New Column for date
                            var row1col1 = row1.insertCell(0);
                            var m = json.response.periods[i].dateTimeISO.substring(5, 7);
                            var d = json.response.periods[i].dateTimeISO.substring(8, 10);
                            row1col1.innerHTML = m + "/" + d + '&nbsp';
                            row1col1.style.border = "thin solid black";
                            // time
                            row1col1 = row1.insertCell(1);
                            var h = json.response.periods[i].dateTimeISO.substring(11, 13); // tide hour
                            var mi = json.response.periods[i].dateTimeISO.substring(14, 16);  // time min
                            tidehhmm = (Number(h) * 100) + Number(mi);
                            row1col1.innerHTML = "&nbsp" + ShortTime(tidehhmm);
                            row1col1.style.border = "thin solid black";
                            if (json.response.periods[i].type == 'h') hilow = '&nbsphigh';
                            else hilow = '&nbsplow';
                            // if tide is past, color row gray
                            if ((month > m) || (month == m && dayofmonth > d) || (month == m && dayofmonth == d && (timehhmm > tidehhmm))) {
                                row1.style.color = "lightgray";
                                if (json.response.periods[i].type == 'h') currentTide = "Outgoing since ";  // incoming outgoing flag
                                else currentTide = "Incoming since ";
                                currentTide += ShortTime(tidehhmm) + " (duration: " + timeDiff(tidehhmm, timehhmm) + ")";
                                oldtideheight = Number(json.response.periods[i].heightFT);
                                oldtidetime = tidehhmm;
                                oldtide = 0;
                            } else if ((oldtide == 0) ) {

                                // this is the next tide, bold it and calculate approx height                             
                                row1.style.fontWeight = "bold";
                                oldtide = 1;
                                // calculate current tide height
                                var tideheight = CalculateCurrentTideHeight(tidehhmm, oldtidetime, Number(json.response.periods[i].heightFT), oldtideheight);
                                currentTide += "<br/>Approximate height: " + tideheight.toFixed(1) + " ft.";
                                // calculate time till next tide                                 
                                currentTide += "<br/>" + hilow + " tide will be " + json.response.periods[i].heightFT + " ft. at " + ShortTime(tidehhmm) + " (in " + timeDiff(timehhmm, tidehhmm) + ")";
                                nextTides = "Tides: " + hilow + " " + json.response.periods[i].heightFT + " ft. at " + ShortTime(tidehhmm) + ";";                        
                            } else if(oldtide == 1) {  // save next tide
                                oldtide = 2;
                                nextTides += hilow + " " + json.response.periods[i].heightFT + " ft. at " + ShortTime(tidehhmm) + ";";
                                localStorage.setItem("nextTides", nextTides); // save tide
                            }

                            // type
                            row1col1 = row1.insertCell(2);
                            row1col1.innerHTML = hilow;
                            row1col1.style.border = "thin solid black";
                            // height
                            row1col1 = row1.insertCell(3);
                            row1col1.innerHTML = json.response.periods[i].heightFT;
                            row1col1.style.border = "thin solid black";
                        }
                        // now save the current tide
                        document.getElementById("current").innerHTML = "Current tide is: " + currentTide;
                        $("#tideButton").show();
                        //document.getElementById("tideButton").show(); // show the button
                        //$('#js').html('The current weather in Seattle is ' + ob.weather.toLowerCase() + ' with a temperature of ' + ob.tempF + '°');
                    }
                    else {
                        alert('Could not retrieve tide information: ' + json.error.description);
                    }
                }   
            });
                    

        }

        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        // ShowCustom - get date for custom tides
        function ShowCustom() {
            InitializeDates(0);
            var tidedate = prompt("Please enter the date as mm/dd", month + "/" + dayofmonth);
            if (tidedate == null) return;
            // validate the date
            var tda = tidedate.split("/");
            if (tda.length != 2) {
                alert("Invalid date. An example of a valid date is: 1/22");
                return;
            }
            var m = Number(tda[0]); // month
            var d = Number(tda[1]);  // day
            if (isNaN(m) || isNaN(d) || (m < 1) || (m > 12) || (d < 1) || (d > 31)) {
                alert("Invalid date. An example of a valid date is: 1/22");
                return;
            }            // clear table
            while (table.rows.length > 1) {
                table.deleteRow(-1);
            }
            // get new data
            tidedate = tidedate + "/" + year;
            getTideData(tidedate);

        }

        function ShowNOAA() {
            InitializeDates(0);
            window.open("http://opendap.co-ops.nos.noaa.gov/axis/webservices/highlowtidepred/response.jsp?stationId=9446705&beginDate=" + year + month + dayofmonth + "&endDate=" + year + month + dayofmonth + "&datum=MLLW&unit=0&timeZone=0&format=html&Submit=Submit")
        }


        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        // run the script
        InitializeDates(0);
        createTable();

        getTideData("-20hours");
        var div = document.getElementById('divTable');
        div.appendChild(table);

    </script>
</body>
</html>